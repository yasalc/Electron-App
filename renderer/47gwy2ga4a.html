<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="v2.9.0-Messaging-System-Added">
    <title>Admin Panel - Attorney's At Law Classes - Netaji Yasara Silva</title>
    <!-- Add Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            height: 100%;
            width: 100%;
        }

        .container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
        }

        /* Login Form */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #333333 0%, #555555 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* Dashboard Styles */
        .dashboard {
            display: none; /* Will be changed to block on successful login */
            background: white;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            margin: 0;
        }

        .dashboard-content {
            display: flex;
            position: absolute;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            overflow: auto;
        }

        .sidebar {
            width: 250px;
            background: #f5f5f5;
            padding: 20px 0;
            border-right: 1px solid #e1e8ed;
            overflow-y: auto;
            height: 100%;
        }

        .nav-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e8ed;
            color: #333;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .nav-item:hover {
            background-color: #e9ecef;
        }

        .nav-item.active {
            background-color: #e9ecef;
            border-left: 4px solid #333333;
            font-weight: 500;
        }

        .content {
            flex: 1;
            padding: 20px;
            background: #fff;
            overflow: auto;
            position: relative;
            box-sizing: border-box;
            min-width: 0;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .content-header {
            margin-bottom: 30px;
        }

        .content-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .content-header p {
            color: #666;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background-color: #f5f5f5;
            color: #333;
            font-weight: 500;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        /* Filter controls */
        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Action buttons */
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            color: white;
        }

        .edit-btn {
            background-color: #666666;
        }

        .approve-btn {
            background-color: #333333;
        }

        .reject-btn {
            background-color: #888888;
        }

        .delete-btn {
            background-color: #999999;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .pending {
            background-color: #cccccc;
            color: #333;
        }

        .approved {
            background-color: #333333;
            color: white;
        }

        .rejected {
            background-color: #888888;
            color: white;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 800px;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #333333 0%, #555555 100%);
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #eee;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: #f5f5f5;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            text-align: right;
        }

        @media (max-width: 768px) {
            .dashboard-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e1e8ed;
                display: flex;
                overflow-x: auto;
                padding: 10px;
                height: auto;
                position: absolute;
                top: 70px;
                left: 0;
                right: 0;
            }

            .nav-item {
                text-align: center;
            }
            
            .dashboard-content {
                top: 140px;
                flex-direction: column;
            }
            
            .content {
                overflow: auto;
                padding: 15px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="authSection" class="auth-container">
            <div class="auth-box">
                <div class="auth-header">
                    <h1>Admin Portal</h1>
                    <p>Attorney's At Law Classes - Netaji Yasara Silva</p>
                </div>

                <form id="adminLoginForm">
                    <div class="form-group">
                        <label for="adminEmail">Email</label>
                        <input type="email" id="adminEmail" value="yasalc2023@gmail.com" required>
                    </div>

                    <div class="form-group">
                        <label for="adminPassword">Password</label>
                        <input type="password" id="adminPassword" value="Hamster00" required>
                    </div>

                    <button type="submit" class="btn">Login as Admin</button>
                </form>

                <!-- Admin Note -->
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                    <p style="color: #666; font-size: 12px; margin: 0;">
                        🔐 Admin password management available through Password Reset Requests section
                    </p>
                </div>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e8ed;">
                    <p style="color: #666; margin-bottom: 10px;">Not an admin?</p>
                    <a href="0cj1zfmo29.html" style="color: #667eea; text-decoration: none; font-weight: 500;">
                        👨‍🎓 Go to Student Portal
                    </a>
                    <br><br>
                    <a href="index.html" style="color: #999; text-decoration: none; font-size: 14px;">
                        ← Back to Portal Selector
                    </a>
                    <br><small style="color: #999; font-size: 10px; margin-top: 10px; display: block;">Version: 2.5.1-20250618-0950</small>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard">
            <div class="dashboard-header">
                <h1>Admin Dashboard</h1>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <small style="color: rgba(255,255,255,0.8); font-size: 10px;">v2.5.1-20250618-0950</small>
                    <button onclick="logout()" class="btn" style="width: auto; background: rgba(255,255,255,0.2);">Logout</button>
                </div>
            </div>

            <div class="dashboard-content">
                <div class="sidebar">
                    <div class="nav-item active" data-section="userManagement" onclick="showSection('userManagement', event)">User Management</div>
                    <div class="nav-item" data-section="classManagement" onclick="showSection('classManagement', event)">Class Management</div>
                    <div class="nav-item" data-section="enrollmentRequests" onclick="showSection('enrollmentRequests', event)">Enrollment Requests</div>
                    <div class="nav-item" data-section="recordingManagement" onclick="showSection('recordingManagement', event)">Recording Management</div>
                    <div class="nav-item" data-section="notesManagement" onclick="showSection('notesManagement', event)">Notes Management</div>
                    <div class="nav-item" data-section="messaging" onclick="showSection('messaging', event)">📱 Messaging</div>
                    <div class="nav-item" data-section="deviceManagement" onclick="showSection('deviceManagement', event)">🔒 Device Management</div>
                    <div class="nav-item" data-section="passwordResetManagement" onclick="showSection('passwordResetManagement', event)">Password Reset Requests</div>
                    <div class="nav-item" data-section="reports" onclick="showSection('reports', event)">Reports</div>
                    <div class="nav-item" data-section="settings" onclick="showSection('settings', event)">Settings</div>
                </div>

                <div class="content">
                    <!-- User Management Section -->
                    <div id="userManagementSection" class="content-section active">
                        <div class="content-header">
                            <h1>User Management</h1>
                            <p>Manage student registrations and profiles</p>
                        </div>

                        <div class="filter-controls">
                            <button class="btn" onclick="loadUsers()" style="width: auto; margin-right: 10px;">Refresh Users</button>
                            <label for="statusFilter">Filter by Status:</label>
                            <select id="statusFilter">
                                <option value="">All Status</option>
                                <option value="profile_updates" style="background-color: #ffecef;">Pending Profile Updates</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <button class="btn" onclick="openBulkUploadModal()" style="width: auto; margin-left: 20px; background: #333333;">Bulk Upload Students</button>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>NIC</th>
                                    <th>Mobile</th>
                                    <th>Batch</th>
                                    <th>Classes</th>
                                    <th>Status</th>
                                    <th>Registration Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 20px;">Click "Refresh Users" to load students</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Class Management Section -->
                    <div id="classManagementSection" class="content-section">
                        <div class="content-header">
                            <h1>Class Management</h1>
                            <p>Create and manage classes</p>
                        </div>

                        <div class="bulk-actions-section" style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #333333;">
                            <h3>🚀 Bulk Enrollment Actions</h3>
                            
                            <!-- Simple Bulk Enrollment -->
                            <div style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #ddd;">
                                <h4>📚 Enroll All Students in One Class</h4>
                                <p>Quickly enroll all approved students into a specific class</p>
                                
                                <div class="form-group">
                                    <label for="bulkEnrollClass">Select Class:</label>
                                    <select id="bulkEnrollClass" style="width: 300px; padding: 8px; margin: 10px 0;">
                                        <option value="">-- Select a Class --</option>
                                    </select>
                                </div>
                                
                                <button class="btn" onclick="bulkEnrollStudents()" style="background: #333333; color: white;">
                                    📚 Enroll All Approved Students
                                </button>
                            </div>

                            <!-- Advanced Multi-Selection Bulk Enrollment -->
                            <div>
                                <h4>🎯 Custom Student-Class Enrollment Matrix</h4>
                                <p>Select specific students and classes for bulk enrollment</p>
                                
                                <button class="btn" onclick="openBulkEnrollMatrix()" style="background: #666666; color: white;">
                                    🗂️ Open Enrollment Matrix
                                </button>
                            </div>
                            
                            <div id="bulkEnrollResults" style="margin-top: 15px; padding: 10px; display: none;"></div>
                        </div>

                        <div style="margin-bottom: 30px; background: #f5f5f5; padding: 20px; border-radius: 8px;">
                            <h3>Add New Class</h3>
                            <form id="classForm" style="margin-top: 15px;">
                                <div style="margin-bottom: 15px;">
                                    <label for="className">Class Name:</label>
                                    <input type="text" id="className" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label for="classDescription">Description:</label>
                                    <textarea id="classDescription" style="width: 100%; padding: 8px; margin-top: 5px; height: 80px;"></textarea>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label for="classPrice">Price (LKR):</label>
                                    <input type="number" id="classPrice" style="width: 100%; padding: 8px; margin-top: 5px;" value="0">
                                </div>
                                <button type="submit" class="btn" style="width: auto; background: #333333;">Create Class</button>
                            </form>
                        </div>

                        <h3>Existing Classes</h3>
                        <button class="btn" onclick="loadClasses()" style="width: auto; margin-bottom: 15px;">Refresh Classes</button>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Price (LKR)</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="classesTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">Click "Refresh Classes" to load classes</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Enrollment Requests Section -->
                    <div id="enrollmentRequestsSection" class="content-section">
                        <div class="content-header">
                            <h1>Enrollment Requests</h1>
                            <p>Review and approve student enrollment requests</p>
                        </div>

                        <div class="filter-controls">
                            <button class="btn" onclick="loadEnrollmentRequests()" style="width: auto; margin-right: 10px;">Refresh Requests</button>
                            <label for="enrollmentStatusFilter">Filter by Status:</label>
                            <select id="enrollmentStatusFilter" onchange="filterEnrollmentRequests()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Student Email</th>
                                    <th>Class Name</th>
                                    <th>Request Date</th>
                                    <th>Status</th>
                                    <th>Payment Proof</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="enrollmentRequestsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">Click "Refresh Requests" to load enrollment requests</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Recording Management Section -->
                    <div id="recordingManagementSection" class="content-section">
                        <div class="content-header">
                            <h1>Recording Management</h1>
                            <p>Manage class recordings and student recording requests</p>
                        </div>

                        <!-- Upload Recording Links -->
                        <div style="margin-bottom: 30px; background: #f5f5f5; padding: 20px; border-radius: 8px;">
                            <h3>Upload Class Recording Links</h3>
                            <form id="recordingUploadForm" style="margin-top: 15px;">
                                <div style="margin-bottom: 15px;">
                                    <label for="recordingClass">Select Class:</label>
                                    <select id="recordingClass" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                                        <option value="">Select a class</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label for="recordingTitle">Recording Title:</label>
                                    <input type="text" id="recordingTitle" style="width: 100%; padding: 8px; margin-top: 5px;" 
                                           placeholder="e.g., Week 1 - Introduction" required>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label for="recordingDescription">Description (Optional):</label>
                                    <textarea id="recordingDescription" rows="3" style="width: 100%; padding: 8px; margin-top: 5px;"
                                              placeholder="Brief description of the recording content"></textarea>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label for="googleDriveUrl">Google Drive Link:</label>
                                    <input type="url" id="googleDriveUrl" style="width: 100%; padding: 8px; margin-top: 5px;" 
                                           placeholder="https://drive.google.com/...">
                                    <small style="color: #666;">Make sure the link is publicly accessible or shared with view permissions</small>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label for="zoomUrl">Zoom Recording Link (Optional):</label>
                                    <input type="url" id="zoomUrl" style="width: 100%; padding: 8px; margin-top: 5px;" 
                                           placeholder="https://zoom.us/rec/play/...">
                                    <small style="color: #666;">Zoom cloud recording link as alternative to Google Drive</small>
                                </div>
                                
                                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <small style="color: #666; font-style: italic;">
                                        Note: You can provide both Google Drive and Zoom links. Students will see both options if available, providing better access reliability.
                                    </small>
                                </div>
                                
                                <button type="submit" class="btn" style="background: #333333; color: white;">Upload Recording Link</button>
                            </form>
                        </div>

                        <!-- Recording Requests -->
                        <div style="margin-bottom: 30px;">
                            <h3>Recording Access Requests</h3>
                            
                            <!-- Duplicate Requests Summary -->
                            <div id="duplicateRequestsSummary" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin-bottom: 15px; display: none;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-weight: bold; color: #dc3545;">⚠️ Duplicate Requests Detected</span>
                                    <span id="duplicateCount" style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;"></span>
                                    <span style="font-size: 14px; color: #666;">Students who have requested the same recording multiple times</span>
                                </div>
                            </div>
                            
                            <div class="filter-controls">
                                <button class="btn" onclick="loadRecordingRequests()" style="width: auto; margin-right: 10px;">Refresh Requests</button>
                                <label for="recordingStatusFilter">Filter by Status:</label>
                                <select id="recordingStatusFilter" onchange="filterRecordingRequests()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <label for="duplicateFilter" style="margin-left: 15px;">Show:</label>
                                <select id="duplicateFilter" onchange="filterRecordingRequests()">
                                    <option value="">All Requests</option>
                                    <option value="duplicates">Duplicate Requests Only</option>
                                    <option value="unique">Unique Requests Only</option>
                                </select>
                            </div>

                            <table style="margin-top: 15px;">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Student Email</th>
                                        <th>Class Name</th>
                                        <th>Enrolled Status</th>
                                        <th>Request Date</th>
                                        <th>Status</th>
                                        <th>Access Expiry</th>
                                        <th>Payment Proof</th>
                                        <th>Recording Available</th>
                                        <th>Duplicate Info</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recordingRequestsTableBody">
                                    <tr>
                                        <td colspan="11" style="text-align: center; color: #666;">Click refresh to load recording requests</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Existing Class Recordings -->
                        <div>
                            <h3>Existing Class Recordings</h3>
                            <button class="btn" onclick="loadExistingRecordings()" style="width: auto; margin: 10px 0;">Load Recordings</button>
                            
                            <table style="margin-top: 15px;">
                                <thead>
                                    <tr>
                                        <th>Class Name</th>
                                        <th>Recording Title</th>
                                        <th>Description</th>
                                        <th>Upload Date</th>
                                        <th>Google Drive Link</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="existingRecordingsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: #666;">Click "Load Recordings" to see uploaded recordings</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="reportsSection" class="content-section">
                        <div class="content-header">
                            <h1>Student Reports Dashboard</h1>
                            <p>Comprehensive view of all students and their enrollments</p>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="search-controls" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <label for="studentSearch" style="display: block; margin-bottom: 5px; font-weight: bold;">🔍 Search Students:</label>
                                    <input type="text" id="studentSearch" placeholder="Search by name, email, NIC, or mobile number..." 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                           oninput="searchStudents()">
                                </div>
                                <div>
                                    <label for="statusFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Status:</label>
                                    <select id="statusFilter" onchange="filterStudents()" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">All Status</option>
                                        <option value="approved">Approved</option>
                                        <option value="pending">Pending</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="batchFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Batch:</label>
                                    <select id="batchFilter" onchange="filterStudents()" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">All Batches</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button onclick="loadStudentReports()" style="background: #666666; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                        🔄 Refresh Data
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; gap: 15px; align-items: center;">
                                <span id="studentCount" style="font-weight: bold; color: #007bff;"></span>
                                <button onclick="exportStudentData()" style="background: #333333; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
                                    📊 Export to CSV
                                </button>
                            </div>
                        </div>

                        <!-- Student Reports Table -->
                        <div style="overflow: auto; border: 1px solid #ddd; border-radius: 8px; height: calc(100vh - 280px); width: 100%; position: relative;">
                            <div style="width: 100%; overflow-x: auto;">
                                <table id="studentReportsTable" style="width: 100%; border-collapse: collapse; min-width: 1000px;">
                                <thead style="background: #333333; color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">Email</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">NIC</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">Mobile</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">Batch</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">Classes Enrolled</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #333333;">Total Classes</th>
                                    </tr>
                                </thead>
                                <tbody id="studentReportsTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                            Click "Refresh Data" to load student reports
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Management Section -->
                    <div id="notesManagementSection" class="content-section">
                        <div class="content-header">
                            <h1>Notes Management</h1>
                            <p>Upload and manage class notes for students</p>
                        </div>

                        <!-- Upload New Notes -->
                        <div style="margin-bottom: 30px;">
                            <h3>📚 Upload Class Notes</h3>
                            <form id="notesUploadForm" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                                <div class="form-group">
                                    <label for="notesClassId">Select Class:</label>
                                    <select id="notesClassId" required>
                                        <option value="">Select a class</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="notesTitle">Notes Title:</label>
                                    <input type="text" id="notesTitle" placeholder="e.g., Lecture 1 - Introduction" required>
                                </div>

                                <div class="form-group">
                                    <label for="notesDescription">Description (Optional):</label>
                                    <textarea id="notesDescription" placeholder="Brief description of the notes content" rows="3"></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="notesGoogleDriveUrl">Google Drive Link:</label>
                                    <input type="url" id="notesGoogleDriveUrl" placeholder="https://drive.google.com/file/d/..." required>
                                    <small style="color: #666; display: block; margin-top: 5px;">
                                        📎 Accepted formats: drive.google.com, docs.google.com, sheets.google.com, slides.google.com<br>
                                        🔗 Make sure the file is set to "Anyone with the link can view"
                                    </small>
                                </div>

                                <button type="submit" class="btn" style="background: #28a745; color: white;">📤 Upload Notes</button>
                            </form>
                        </div>

                        <!-- Existing Notes -->
                        <div>
                            <h3>📋 Existing Class Notes</h3>
                            <button class="btn" onclick="loadExistingNotes()" style="width: auto; margin: 10px 0;">Refresh Notes</button>
                            
                            <table style="margin-top: 15px;">
                                <thead>
                                    <tr>
                                        <th>Class Name</th>
                                        <th>Notes Title</th>
                                        <th>Description</th>
                                        <th>Upload Date</th>
                                        <th>Google Drive Link</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="existingNotesTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: #666;">Click refresh to load existing notes</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Password Reset Management Section -->
                    <div id="passwordResetManagementSection" class="content-section">
                        <div class="content-header">
                            <h1>Password Reset Requests</h1>
                            <p>Manage student password reset requests</p>
                        </div>

                        <div class="filter-controls">
                            <button class="btn" onclick="loadPasswordResetRequests()" style="width: auto; margin-right: 10px;">Refresh Requests</button>
                            <label for="resetStatusFilter">Filter by Status:</label>
                            <select id="resetStatusFilter" onchange="filterPasswordResetRequests()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>NIC</th>
                                        <th>Reason</th>
                                        <th>Status</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="passwordResetRequestsTable">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                                            Click "Refresh Requests" to load password reset requests
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Messaging Section -->
                    <div id="messagingSection" class="content-section">
                        <div class="content-header">
                            <h1>📱 Student Messaging</h1>
                            <p>Filter students and send bulk WhatsApp messages</p>
                        </div>

                        <!-- Filter Controls -->
                        <div class="filter-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);">
                            <h3 style="margin-bottom: 15px; color: #333;">🔍 Student Filters</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">1️⃣ Select Class:</label>
                                    <select id="filterClass" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">All Classes</option>
                                        <!-- Classes will be loaded dynamically -->
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">2️⃣ Enrollment Status:</label>
                                    <select id="filterEnrollment" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">All Students</option>
                                        <option value="enrolled">Enrolled/Approved for Selected Class</option>
                                        <option value="not-enrolled">Not Enrolled in Selected Class</option>
                                    </select>
                                    <small style="color: #666; font-size: 11px; margin-top: 2px; display: block;">
                                        Select a class first to enable enrollment filtering
                                    </small>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="applyStudentFilters()" style="background: #333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                                    🔍 Apply Filters
                                </button>
                                <button onclick="clearStudentFilters()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                                    🗑️ Clear Filters
                                </button>
                                <button onclick="selectAllStudents()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                                    ✅ Select All
                                </button>
                                <button onclick="deselectAllStudents()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                                    ❌ Deselect All
                                </button>
                                <button onclick="debugEnrollmentData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                                    🐛 Debug Data
                                </button>

                            </div>
                        </div>

                        <!-- Student Selection Table -->
                        <div style="background: white; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.05); margin-bottom: 20px;">
                            <div style="padding: 15px; border-bottom: 1px solid #e1e8ed;">
                                <h3 style="margin: 0; color: #333;">👥 Student Selection</h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;" id="studentCountDisplay">Loading students...</p>

                            </div>
                            <div style="overflow-x: auto;">
                                <table id="studentsTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5;">
                                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e1e8ed;">
                                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllStudents(this)" style="margin-right: 5px;">
                                                Select
                                            </th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e1e8ed;">Name</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e1e8ed;">Mobile</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e1e8ed;">Batch</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e1e8ed;">Status</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e1e8ed;">All Classes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        <tr>
                                            <td colspan="6" style="padding: 20px; text-align: center; color: #666;">Loading students...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Message Composer -->
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);">
                            <h3 style="margin-bottom: 15px; color: #333;">📝 Compose Message</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Selected Students:</label>
                                <div id="selectedStudentsDisplay" style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #e1e8ed; min-height: 40px; color: #666;">
                                    No students selected
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Message:</label>
                                <textarea id="messageText" placeholder="Type your message here..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: Arial, sans-serif;"></textarea>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    💡 Tip: Keep messages professional and concise for WhatsApp delivery
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <button onclick="sendBulkWhatsAppMessages()" style="background: #25d366; color: white; border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                                    📱 Send WhatsApp Messages
                                </button>
                                <button onclick="previewMessages()" style="background: #007bff; color: white; border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer;">
                                    👀 Preview Messages
                                </button>
                                <span id="sendingStatus" style="color: #666; font-style: italic;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Device Management Section -->
                    <div id="deviceManagementSection" class="content-section">
                        <div class="content-header">
                            <h1>🔒 Device Management</h1>
                            <p>Manage student device access requests and approved devices</p>
                        </div>

                        <!-- Device Access Requests -->
                        <div style="margin-bottom: 40px;">
                            <h3>📋 Device Access Requests</h3>
                            <p style="color: #666; margin-bottom: 20px;">Review and approve/reject requests from students to access the system from new devices.</p>
                            
                            <div class="filter-controls">
                                <button class="btn" onclick="loadDeviceRequests()" style="width: auto; margin-right: 10px;">🔄 Refresh Requests</button>
                                <label for="deviceRequestStatusFilter">Filter by Status:</label>
                                <select id="deviceRequestStatusFilter" onchange="onDeviceRequestStatusFilterChange()">
                                    <option value="">All Requests</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>

                            <table style="margin-top: 20px;">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Device Info</th>
                                        <th>Justification</th>
                                        <th>Request Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deviceRequestsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 20px;">Click "Refresh Requests" to load device access requests</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Approved Devices -->
                        <div>
                            <h3>✅ Approved Devices</h3>
                            <p style="color: #666; margin-bottom: 20px;">View and manage all approved devices for students.</p>
                            
                            <div class="filter-controls">
                                <button class="btn" onclick="loadApprovedDevices()" style="width: auto; margin-right: 10px;">🔄 Refresh Devices</button>
                                <input type="text" id="deviceUserFilter" placeholder="Search by student name..." onkeyup="filterApprovedDevices()" style="margin-right: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <table style="margin-top: 20px;">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Device Name</th>
                                        <th>Device Type</th>
                                        <th>Platform</th>
                                        <th>First Seen</th>
                                        <th>Last Active</th>
                                        <th>Auto Approved</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedDevicesTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 20px;">Click "Refresh Devices" to load approved devices</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="settingsSection" class="content-section">
                        <div class="content-header">
                            <h1>Settings</h1>
                            <p>Configure system settings and privacy controls</p>
                        </div>
                        
                        <!-- Privacy Controls Section -->
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                            <h3>🔐 Privacy & Data Management</h3>
                            <p style="color: #666; margin-bottom: 20px;">
                                Payment proof files are automatically cleared after admin approval/rejection decisions. 
                                You can also manually clean up old pending payment proofs that are older than 30 days.
                            </p>
                            
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <button onclick="manualPaymentProofCleanup()" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                    🧹 Clean Old Payment Proofs
                                </button>
                                <span style="color: #666; font-size: 14px;">
                                    Removes payment proof files from pending requests older than 30 days
                                </span>
                            </div>
                            
                            <div id="cleanupResult" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
                        </div>
                        
                        <!-- System Information -->
                        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                            <h3>ℹ️ System Information</h3>
                            <ul style="color: #666; line-height: 1.6;">
                                <li><strong>Automatic Cleanup:</strong> Runs every hour while admin is logged in</li>
                                <li><strong>Payment Proof Retention:</strong> Cleared immediately after approval/rejection</li>
                                <li><strong>Old Data Cleanup:</strong> Pending payment proofs older than 30 days are automatically removed</li>
                                <li><strong>Privacy Compliance:</strong> No payment proof files are stored permanently</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Student Information</h2>
                <span class="close" onclick="closeEditUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    
                    <div class="form-group">
                        <label for="editName">Full Name:</label>
                        <input type="text" id="editName" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editEmail">Email:</label>
                        <input type="email" id="editEmail" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editNIC">NIC Number:</label>
                        <input type="text" id="editNIC" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editMobile">Mobile Number:</label>
                        <input type="text" id="editMobile" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editBatch">Batch:</label>
                        <input type="text" id="editBatch" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editStatus">Status:</label>
                        <select id="editStatus" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="button" onclick="closeEditUserModal()" style="background: #888888; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px;">
                            Cancel
                        </button>
                        <button type="submit" style="background: #333333; color: white; padding: 10px 20px; border: none; border-radius: 4px;">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bulk Upload Students</h2>
                <span class="close" onclick="closeBulkUploadModal()">&times;</span>
            </div>

            <div class="modal-body">
                <p style="margin-bottom: 20px;">Upload an Excel file (.xls, .xlsx) with student information. The file should have the following columns:</p>
                <ul style="margin-bottom: 20px; margin-left: 20px;">
                    <li><strong>name:</strong> Full name of the student</li>
                    <li><strong>email:</strong> Email address (will be used for login)</li>
                    <li><strong>nic:</strong> National ID Card number</li>
                    <li><strong>mobile:</strong> Mobile phone number</li>
                    <li><strong>batch:</strong> (Optional) Batch name/identifier</li>
                </ul>

                <div style="background: #f0f0f0; color: #333333; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
                    <strong>Note:</strong> Students will be automatically created with NIC as password.
                </div>
            </div>

            <form id="bulkUploadForm">
                <div class="form-group">
                    <label for="bulkUploadFile">Select Excel File (.xls, .xlsx)</label>
                    <input type="file" id="bulkUploadFile" accept=".xls,.xlsx" required>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn" style="background: #333333;">Upload Students</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Reset Request Modal -->
    <div id="passwordResetModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 600px;">
            <div class="modal-header">
                <h2>Process Password Reset Request</h2>
                <span class="close" onclick="closePasswordResetModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div id="resetRequestDetails" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <!-- Request details will be populated here -->
                </div>

                <form id="processResetForm">
                    <input type="hidden" id="resetRequestId">
                    
                    <div class="form-group">
                        <label for="resetAction">Action:</label>
                        <select id="resetAction" required onchange="toggleTemporaryPasswordField()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select Action</option>
                            <option value="approved">Approve Request</option>
                            <option value="rejected">Reject Request</option>
                        </select>
                    </div>

                    <div class="form-group" id="temporaryPasswordGroup" style="display: none;">
                        <label for="temporaryPassword">Temporary Password:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="temporaryPassword" placeholder="Enter temporary password" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <button type="button" onclick="generateTemporaryPassword()" style="background: #666; color: white; padding: 10px 15px; border: none; border-radius: 4px;">Generate</button>
                        </div>
                        <small style="color: #666;">This password will be provided to the student</small>
                    </div>

                    <div class="form-group">
                        <label for="adminNotes">Admin Notes:</label>
                        <textarea id="adminNotes" rows="3" placeholder="Optional notes for the student" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-top: 20px; text-align: right;">
                        <button type="button" onclick="closePasswordResetModal()" style="background: #888888; color: white; padding: 12px 20px; border: none; border-radius: 4px; margin-right: 10px;">Cancel</button>
                        <button type="submit" style="background: #333333; color: white; padding: 12px 20px; border: none; border-radius: 4px;">Process Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enrollment Matrix Modal -->
    <div id="enrollmentMatrixModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 1200px; height: 80vh;">
            <div class="modal-header">
                <h2>🎯 Student-Class Enrollment Matrix</h2>
                <span class="close" onclick="closeBulkEnrollMatrix()">&times;</span>
            </div>
            
            <div class="modal-body" style="height: calc(100% - 120px); overflow-y: auto;">
                <div style="margin-bottom: 20px; background: #f5f5f5; padding: 15px; border-radius: 8px;">
                    <h3>Instructions:</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>✅ <strong>Check boxes</strong> to select student-class combinations</li>
                        <li>📋 <strong>Use row/column headers</strong> to select all students for a class or all classes for a student</li>
                        <li>🚀 <strong>Click "Process Selected Enrollments"</strong> to bulk approve selected combinations</li>
                        <li>⚠️ <strong>Gray boxes</strong> indicate student is already enrolled</li>
                    </ul>
                </div>

                <div style="margin-bottom: 15px;">
                    <button onclick="selectAllMatrix()" style="background: #333333; color: white; padding: 8px 15px; border: none; border-radius: 4px; margin-right: 10px;">Select All</button>
                    <button onclick="clearAllMatrix()" style="background: #888888; color: white; padding: 8px 15px; border: none; border-radius: 4px; margin-right: 10px;">Clear All</button>
                    <span id="selectionCount" style="font-weight: bold; color: #007bff;">0 selections</span>
                </div>

                <div id="enrollmentMatrixTable" style="position: relative; height: calc(100vh - 350px); min-height: 300px; border: 1px solid #ddd; border-radius: 8px; overflow: auto; width: 100%; background: white;">
                    <!-- Matrix table will be generated here -->
                </div>
            </div>
            
            <div class="modal-footer" style="text-align: center; padding: 15px; border-top: 1px solid #ddd;">
                <button onclick="processBulkEnrollments()" style="background: #333333; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold;">
                    🚀 Process Selected Enrollments
                </button>
                <button onclick="closeBulkEnrollMatrix()" style="background: #888888; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; margin-left: 10px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Add Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Password reset URL handler (fallback)
        function handlePasswordResetFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token');
            const type = urlParams.get('type');

            if (accessToken && refreshToken && type === 'recovery') {
                console.log('Admin password reset tokens detected in URL');
                
                // Show password reset interface
                const resetPassword = prompt('Please enter your new admin password (minimum 6 characters):');
                if (resetPassword && resetPassword.length >= 6) {
                    const confirmPassword = prompt('Please confirm your new admin password:');
                    if (resetPassword === confirmPassword) {
                        // Set session and update password
                        supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        }).then(({ data, error }) => {
                            if (error) {
                                console.error('Admin session error:', error);
                                alert('Reset link is invalid or expired. Please request a new password reset.');
                                return;
                            }
                            
                            // Update password
                            return supabase.auth.updateUser({ password: resetPassword });
                        }).then(({ error }) => {
                            if (error) {
                                console.error('Admin password update error:', error);
                                alert('Failed to update admin password: ' + error.message);
                            } else {
                                alert('Admin password updated successfully! You can now log in with your new password.');
                                // Clear URL parameters and refresh
                                window.history.replaceState({}, document.title, window.location.pathname);
                                showAdminLogin();
                            }
                        });
                    } else {
                        alert('Passwords do not match. Please try again.');
                    }
                } else {
                    alert('Password must be at least 6 characters long.');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin page loaded');
            
            // Check for password reset in URL first
            handlePasswordResetFromURL();
        });
        
        // Supabase configuration
        const SUPABASE_URL = 'https://lfszceyrzwsyxlvubrcc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmc3pjZXlyendzeXhsdnVicmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5Nzg4OTUsImV4cCI6MjA2NTU1NDg5NX0.h2EHHl3bXwRxTbRlYrGkXFN8v5xlmf4u-2IuigmfSWc';
        
        // Initialize Supabase client
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized successfully');
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
            alert('Error initializing database connection. Please check your console for details.');
        }
        
        let currentSection = 'userManagement';
        let allUsers = [];

        // Admin UI functions (simplified - no separate reset form needed)
        function showAdminLogin() {
            // Login form is always visible now
            console.log('Admin login form displayed');
        }

        // Admin login - SIMPLIFIED LOGIN THAT DOESN'T RELY ON SUPABASE
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Admin login form submitted');
            
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            console.log('Checking credentials:', email, 'Password length:', password.length);
            
            // Simple hardcoded admin login with exact match
            if (email === 'yasalc2023@gmail.com' && password === 'Hamster00') {
                console.log('Login successful!');
                
                // Hide auth section and show dashboard
                const authSection = document.getElementById('authSection');
                const dashboardSection = document.getElementById('dashboardSection');
                
                if (authSection && dashboardSection) {
                    authSection.style.display = 'none';
                    dashboardSection.style.display = 'block';
                    console.log('Sections toggled successfully');
                } else {
                    console.error('Could not find authSection or dashboardSection elements');
                    alert('Error: Could not access dashboard. Please refresh the page.');
                }
                
                // Try to load initial data if Supabase is available
                try {
                    if (supabase) {
                        // Initialize reports data during login to ensure it's loaded
                        loadStudentReports();
                        
                        // Load other data
                        loadUsers();
                        loadClasses();
                        loadClassesForBulkEnroll();
                        
                        // Load recording management data
                        loadRecordingRequests();
                        loadExistingRecordings();
                        loadRecordingClasses();
                        
                        // Load device management data (with delay to ensure DOM is ready)
                        setTimeout(() => {
                            console.log('Loading device management data on admin login...');
                            loadDeviceRequests();
                            loadApprovedDevices();
                        }, 500);
                        
                        // Start automatic payment proof cleanup
                        startPaymentProofCleanup();
                    }
                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            } else {
                console.log('Login failed! Expected: yasalc2023@gmail.com / Hamster00');
                console.log('Received:', email, '/', password);
                alert('Invalid admin credentials!\n\nExpected:\nEmail: yasalc2023@gmail.com\nPassword: Hamster00');
            }
        });



        function showSection(sectionName, clickEvent) {
            console.log('Showing section:', sectionName);
            
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remove active from nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            // Show selected section
            const sectionElement = document.getElementById(sectionName + 'Section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            } else {
                console.error('Section not found:', sectionName + 'Section');
            }
            
            // If this was triggered by a click, mark that nav item as active
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            } else {
                // Otherwise find the nav item and mark it active
                const navItem = document.querySelector(`.nav-item[data-section="${sectionName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
            
            currentSection = sectionName;
            
            // Load section-specific data
            if (sectionName === 'reports') {
                console.log('Loading student reports data');
                loadStudentReports();
            } else if (sectionName === 'passwordResetManagement') {
                console.log('Loading password reset requests');
                loadPasswordResetRequests();
            } else if (sectionName === 'recordingManagement') {
                console.log('Loading recording management data');
                loadRecordingRequests();
                loadExistingRecordings();
                loadRecordingClasses();
            } else if (sectionName === 'messaging') {
                console.log('Loading messaging data');
                if (typeof initializeMessaging === 'function') {
                    initializeMessaging();
                }
            } else if (sectionName === 'deviceManagement') {
                console.log('Loading device management data');
                
                // Add a small delay to ensure DOM elements are ready
                setTimeout(() => {
                    console.log('Initializing device management...');
                    loadDeviceRequests();
                    loadApprovedDevices();
                }, 100);
            } else if (sectionName === 'notesManagement') {
                console.log('Loading notes management data');
                if (typeof initializeNotesManagement === 'function') {
                    initializeNotesManagement();
                }
            }
        }

        function logout() {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('dashboardSection').style.display = 'none';
        }



        // User Management Functions
        async function loadUsers() {
            try {
                console.log('Loading users from Supabase...');
                
                // Get user profiles
                const { data: users, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                console.log('User profiles response:', { data: users, error });
                
                if (error) {
                    console.error('Error loading users:', error);
                    displayNoUsers('Error loading users: ' + error.message);
                    return;
                }
                
                // Get enrollments for all users
                const { data: enrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select(`
                        *,
                        classes (
                            id,
                            name
                        )
                    `)
                    .in('status', ['approved']);
                    
                if (enrollError) {
                    console.error('Error loading enrollments:', enrollError);
                }
                
                // Combine users with their enrollments
                const usersWithEnrollments = (users || []).map(user => ({
                    ...user,
                    enrollments: (enrollments || []).filter(e => e.user_id === user.user_id)
                }));
                
                allUsers = usersWithEnrollments;
                displayUsers(filterUsersByStatus(document.getElementById('statusFilter').value));
                
                // Show notification if there are pending profile updates
                const pendingUpdates = allUsers.filter(user => user.profile_update_pending).length;
                if (pendingUpdates > 0) {
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #333333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
                    notification.innerHTML = `<strong>⚠️ Attention:</strong> ${pendingUpdates} profile update${pendingUpdates > 1 ? 's' : ''} pending approval`;
                    document.body.appendChild(notification);
                    
                    // Remove after 5 seconds
                    setTimeout(() => notification.remove(), 5000);
                }
                
                // Also load enrollment requests to check for pending
                loadEnrollmentRequests();
                
            } catch (e) {
                console.error('Error connecting to Supabase:', e);
                displayNoUsers('Error connecting to database: ' + e.message);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                displayNoUsers('No students found. Use "Bulk Upload Students" to add students.');
                return;
            }
            
            for (const user of users) {
                const row = document.createElement('tr');
                
                const registrationDate = new Date(user.created_at);
                const formattedDate = registrationDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const statusClass = user.status === 'approved' ? 'approved' : 
                                   user.status === 'rejected' ? 'rejected' : 'pending';
                
                row.innerHTML = `
                    <td>${user.name} ${user.profile_update_pending ? '<span style="color: #dc3545; font-weight: bold; font-size: 12px;">[UPDATE PENDING]</span>' : ''}</td>
                    <td>${user.email}${user.profile_update_pending && user.pending_email !== user.email ? '<br><small style="color: #dc3545;">→ ' + user.pending_email + '</small>' : ''}</td>
                    <td>${user.nic}${user.profile_update_pending && user.pending_nic !== user.nic ? '<br><small style="color: #dc3545;">→ ' + user.pending_nic + '</small>' : ''}</td>
                    <td>${user.mobile}${user.profile_update_pending && user.pending_mobile !== user.mobile ? '<br><small style="color: #dc3545;">→ ' + user.pending_mobile + '</small>' : ''}</td>
                    <td>${user.batch || 'Current Batch'}${user.profile_update_pending && user.pending_batch !== user.batch ? '<br><small style="color: #dc3545;">→ ' + user.pending_batch + '</small>' : ''}</td>
                    <td>${generateEnrollmentsList(user.enrollments)}</td>
                    <td><span class="status-badge ${statusClass}">${user.status.toUpperCase()}</span>${user.profile_update_pending ? ' <span class="status-badge" style="background: #333333; color: white;">PROFILE UPDATE</span>' : ''}</td>
                    <td>${formattedDate}</td>
                    <td>
                        ${user.profile_update_pending ? `
                            <button class="action-btn approve-btn" onclick="approveProfileUpdate('${user.id}')">Approve Update</button>
                            <button class="action-btn reject-btn" onclick="rejectProfileUpdate('${user.id}')">Reject Update</button>
                        ` : user.status === 'rejected' ? `
                            <button class="action-btn approve-btn" onclick="approveUser('${user.id}')">Approve</button>
                        ` : `
                            <button class="action-btn edit-btn" onclick="openEditUserModal('${user.id}')">Edit</button>
                        `}
                        <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }

        function generateEnrollmentsList(enrollments) {
            if (!enrollments || enrollments.length === 0) {
                return '<span style="color: #666; font-style: italic;">No classes enrolled</span>';
            }
            
            return enrollments.map(enrollment => {
                const className = enrollment.classes ? enrollment.classes.name : 'Unknown Class';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 3px 8px; background: #f0f0f0; border-radius: 4px; font-size: 12px;">
                        <span style="font-weight: bold; color: #333333;">${className}</span>
                        <button onclick="deleteEnrollment('${enrollment.id}', '${enrollment.user_id}', '${className}')" 
                                style="background: #888888; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;"
                                title="Delete this enrollment">×</button>
                    </div>
                `;
            }).join('');
        }

        async function deleteEnrollment(enrollmentId, userId, className) {
            if (!confirm(`Are you sure you want to delete the enrollment for "${className}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('enrollments')
                    .delete()
                    .eq('id', enrollmentId);
                
                if (error) throw error;
                
                alert(`✅ Enrollment for "${className}" has been deleted successfully!`);
                loadUsers(); // Refresh the user list
                
            } catch (e) {
                console.error('Error deleting enrollment:', e);
                alert('❌ Error deleting enrollment: ' + e.message);
            }
        }

        function displayNoUsers(message) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px;">${message}</td></tr>`;
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                    
                if (error) {
                    console.error('Error approving user:', error);
                    alert('Error approving user: ' + error.message);
                    return;
                }
                
                alert('Student approved successfully!');
                loadUsers();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error approving user: ' + e.message);
            }
        }

        async function rejectUser(userId) {
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({
                        status: 'rejected'
                    })
                    .eq('id', userId);
                    
                if (error) {
                    console.error('Error rejecting user:', error);
                    alert('Error rejecting user: ' + error.message);
                    return;
                }
                
                alert('Student rejected!');
                loadUsers();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error rejecting user: ' + e.message);
            }
        }

        // This is now a deprecated function, replaced by the more comprehensive version above
        async function _deprecatedDeleteUser(userId) {
            console.log('Using the improved deleteUser function instead');
        }

        function filterUsersByStatus(status) {
            if (!status) {
                return allUsers;
            }
            
            if (status === 'profile_updates') {
                return allUsers.filter(user => user.profile_update_pending);
            }
            
            return allUsers.filter(user => user.status === status);
        }

        document.getElementById('statusFilter').addEventListener('change', function() {
            const status = this.value;
            displayUsers(filterUsersByStatus(status));
        });

        // Bulk Upload Functions
        function openBulkUploadModal() {
            document.getElementById('bulkUploadModal').style.display = 'block';
        }

        function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').style.display = 'none';
        }

        document.getElementById('bulkUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('bulkUploadFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }
            
            // Here we would normally process the Excel file
            // But without the actual file processing capability, we'll simulate it
            
            alert('In a production environment, this would process the Excel file and create users. You can test with individual user management.');
            closeBulkUploadModal();
        });

        // Profile Update Approval Functions
        async function approveProfileUpdate(userId) {
            try {
                // First get the user's pending data
                const { data: userData, error: fetchError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                    
                if (fetchError) {
                    console.error('Error fetching user data:', fetchError);
                    alert('Error fetching user data: ' + fetchError.message);
                    return;
                }
                
                // Apply the pending changes to the main profile fields
                const { error } = await supabase
                    .from('user_profiles')
                    .update({
                        // Apply pending changes to main fields
                        name: userData.pending_name || userData.name,
                        email: userData.pending_email || userData.email,
                        nic: userData.pending_nic || userData.nic,
                        mobile: userData.pending_mobile || userData.mobile,
                        batch: userData.pending_batch || userData.batch,
                        // Clear pending fields
                        pending_name: null,
                        pending_email: null,
                        pending_nic: null,
                        pending_mobile: null,
                        pending_batch: null,
                        profile_update_pending: false,
                        profile_update_approved_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                    
                if (error) {
                    console.error('Error approving profile update:', error);
                    alert('Error approving profile update: ' + error.message);
                    return;
                }
                
                alert('Profile update approved successfully! Changes have been applied to the database.');
                loadUsers();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error approving profile update: ' + e.message);
            }
        }

        async function rejectProfileUpdate(userId) {
            try {
                // First get the original data
                const { data, error: fetchError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                    
                if (fetchError) {
                    console.error('Error fetching user data:', fetchError);
                    alert('Error fetching user data: ' + fetchError.message);
                    return;
                }
                
                // Confirm with admin
                if (!confirm('Are you sure you want to reject the profile update for ' + data.name + '? The proposed changes will be discarded.')) {
                    return;
                }
                
                // Clear all pending changes and reset flag
                const { error } = await supabase
                    .from('user_profiles')
                    .update({
                        // Clear all pending fields
                        pending_name: null,
                        pending_email: null,
                        pending_nic: null,
                        pending_mobile: null,
                        pending_batch: null,
                        profile_update_pending: false,
                        profile_update_rejected_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                    
                if (error) {
                    console.error('Error rejecting profile update:', error);
                    alert('Error rejecting profile update: ' + error.message);
                    return;
                }
                
                alert('Profile update rejected successfully. Proposed changes have been discarded.');
                loadUsers();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error rejecting profile update: ' + e.message);
            }
        }

        // Class Management Functions
        async function loadClasses() {
            try {
                console.log('Loading classes from Supabase...');
                
                const { data: classes, error } = await supabase
                    .from('classes')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                console.log('Classes response:', { data: classes, error });
                
                if (error) {
                    console.error('Error loading classes:', error);
                    document.getElementById('classesTableBody').innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">Error loading classes: ${error.message}</td></tr>`;
                    return;
                }
                
                if (!classes || classes.length === 0) {
                    document.getElementById('classesTableBody').innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No classes found. Create one using the form above.</td></tr>`;
                    return;
                }
                
                const tbody = document.getElementById('classesTableBody');
                tbody.innerHTML = '';
                
                for (const classItem of classes) {
                    const row = document.createElement('tr');
                    
                    const createdDate = new Date(classItem.created_at);
                    const formattedDate = createdDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    row.innerHTML = `
                        <td>${classItem.name}</td>
                        <td>${classItem.description || '-'}</td>
                        <td>${classItem.price || '0'}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="action-btn edit-btn">Edit</button>
                            <button class="action-btn delete-btn">Delete</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                }
                
            } catch (e) {
                console.error('Error connecting to Supabase:', e);
                document.getElementById('classesTableBody').innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">Error connecting to database: ${e.message}</td></tr>`;
            }
        }

        document.getElementById('classForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('className').value;
            const description = document.getElementById('classDescription').value;
            const price = document.getElementById('classPrice').value;
            
            try {
                const { data, error } = await supabase
                    .from('classes')
                    .insert([
                        { 
                            name: name,
                            description: description,
                            price: price,
                            is_active: true
                        }
                    ]);
                    
                if (error) {
                    console.error('Error creating class:', error);
                    alert('Error creating class: ' + error.message);
                    return;
                }
                
                alert('Class created successfully!');
                document.getElementById('classForm').reset();
                loadClasses();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error creating class: ' + e.message);
            }
        });

        // Enrollment Requests Functions
        let allEnrollmentRequests = [];

        async function loadEnrollmentRequests() {
            try {
                console.log('Loading enrollment requests from Supabase...');
                
                // Get enrollments first
                const { data: enrollments, error: enrollmentsError } = await supabase
                    .from('enrollments')
                    .select('*')
                    .order('enrolled_at', { ascending: false });
                    
                if (enrollmentsError) {
                    console.error('Error loading enrollments:', enrollmentsError);
                    displayNoEnrollmentRequests('Error loading enrollments: ' + enrollmentsError.message);
                    return;
                }
                
                console.log(`Fetched ${enrollments ? enrollments.length : 0} enrollments`);
                
                // Get user profiles
                const { data: userProfiles, error: usersError } = await supabase
                    .from('user_profiles')
                    .select('user_id, name, email');
                    
                if (usersError) {
                    console.error('Error loading user profiles:', usersError);
                    displayNoEnrollmentRequests('Error loading user profiles: ' + usersError.message);
                    return;
                }
                
                console.log(`Fetched ${userProfiles ? userProfiles.length : 0} user profiles`);
                
                // Get classes
                const { data: classes, error: classesError } = await supabase
                    .from('classes')
                    .select('id, name');
                    
                if (classesError) {
                    console.error('Error loading classes:', classesError);
                    displayNoEnrollmentRequests('Error loading classes: ' + classesError.message);
                    return;
                }
                
                console.log(`Fetched ${classes ? classes.length : 0} classes`);
                
                // Create lookup maps
                const userMap = {};
                if (userProfiles) {
                    userProfiles.forEach(user => {
                        userMap[user.user_id] = { name: user.name, email: user.email };
                    });
                }
                
                const classMap = {};
                if (classes) {
                    classes.forEach(cls => {
                        classMap[cls.id] = { name: cls.name };
                    });
                }
                
                // Combine the data manually
                allEnrollmentRequests = enrollments ? enrollments.map(enrollment => ({
                    ...enrollment,
                    user_profiles: userMap[enrollment.user_id] || { name: 'Unknown User', email: 'Unknown Email' },
                    classes: classMap[enrollment.class_id] || { name: 'Unknown Class' }
                })) : [];
                
                console.log('Combined enrollment requests:', allEnrollmentRequests);
                displayEnrollmentRequests(allEnrollmentRequests);
                
                // Show notification if there are pending enrollment requests
                const pendingEnrollments = allEnrollmentRequests.filter(enrollment => enrollment.status === 'pending').length;
                if (pendingEnrollments > 0) {
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 70px; right: 20px; background: #666666; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
                    notification.innerHTML = `<strong>📚 Class Enrollments:</strong> ${pendingEnrollments} enrollment request${pendingEnrollments > 1 ? 's' : ''} pending approval`;
                    document.body.appendChild(notification);
                    
                    // Remove after 5 seconds
                    setTimeout(() => notification.remove(), 5000);
                }
                
            } catch (e) {
                console.error('Error connecting to Supabase:', e);
                displayNoEnrollmentRequests('Error connecting to database: ' + e.message);
            }
        }

        function displayEnrollmentRequests(enrollments) {
            const tbody = document.getElementById('enrollmentRequestsTableBody');
            tbody.innerHTML = '';
            
            if (enrollments.length === 0) {
                displayNoEnrollmentRequests('No enrollment requests found.');
                return;
            }
            
            for (const enrollment of enrollments) {
                const row = document.createElement('tr');
                
                const requestDate = new Date(enrollment.enrolled_at);
                const formattedDate = requestDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const statusClass = enrollment.status === 'approved' ? 'approved' : 
                                   enrollment.status === 'rejected' ? 'rejected' : 'pending';
                
                // Handle payment proof display - check if it's base64 data or URL
                let paymentProof = '<span style="color: #666;">No proof</span>';
                if (enrollment.payment_proof_url) {
                    if (enrollment.payment_proof_url.startsWith('data:')) {
                        // Base64 encoded file - create a preview button
                        const filename = enrollment.payment_proof_filename || 'payment_proof';
                        paymentProof = `
                            <button onclick="viewPaymentProof('${enrollment.id}', '${enrollment.payment_proof_url}', '${filename}')" 
                                    style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                📄 View Proof
                            </button>
                        `;
                    } else if (enrollment.payment_proof_url === 'BULK_ENROLLED_BY_ADMIN' || enrollment.payment_proof_url === 'BULK_ENROLLED_BY_ADMIN_MATRIX') {
                        // Admin bulk enrollment - show indicator
                        paymentProof = '<span style="color: #28a745; font-size: 12px;">✅ Admin Enrolled</span>';
                    } else {
                        // Regular URL - create link
                        paymentProof = `<a href="${enrollment.payment_proof_url}" target="_blank" style="color: #007bff;">View Proof</a>`;
                    }
                }
                
                row.innerHTML = `
                    <td>${enrollment.user_profiles.name}</td>
                    <td>${enrollment.user_profiles.email}</td>
                    <td>${enrollment.classes.name}</td>
                    <td>${formattedDate}</td>
                    <td><span class="status-badge ${statusClass}">${enrollment.status.toUpperCase()}</span></td>
                    <td>${paymentProof}</td>
                    <td>
                        ${enrollment.status === 'pending' ? `
                            <button class="action-btn approve-btn" onclick="approveEnrollment('${enrollment.id}')">Approve</button>
                            <button class="action-btn reject-btn" onclick="rejectEnrollment('${enrollment.id}')">Reject</button>
                        ` : enrollment.status === 'rejected' ? `
                            <button class="action-btn approve-btn" onclick="approveEnrollment('${enrollment.id}')">Approve</button>
                        ` : `
                            <button class="action-btn edit-btn">View Details</button>
                        `}
                        <button class="action-btn delete-btn" onclick="deleteEnrollment('${enrollment.id}')">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }

        function displayNoEnrollmentRequests(message) {
            const tbody = document.getElementById('enrollmentRequestsTableBody');
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">${message}</td></tr>`;
        }

        async function approveEnrollment(enrollmentId) {
            try {
                const { error } = await supabase
                    .from('enrollments')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        // Clear payment proof data after approval - no longer needed
                        payment_proof_url: null,
                        payment_proof_filename: null
                    })
                    .eq('id', enrollmentId);
                    
                if (error) {
                    console.error('Error approving enrollment:', error);
                    alert('Error approving enrollment: ' + error.message);
                    return;
                }
                
                alert('Enrollment approved successfully! Payment proof has been automatically cleared for privacy.');
                loadEnrollmentRequests();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error approving enrollment: ' + e.message);
            }
        }

        async function rejectEnrollment(enrollmentId) {
            try {
                const { error } = await supabase
                    .from('enrollments')
                    .update({
                        status: 'rejected',
                        // Clear payment proof data after rejection - no longer needed
                        payment_proof_url: null,
                        payment_proof_filename: null
                    })
                    .eq('id', enrollmentId);
                    
                if (error) {
                    console.error('Error rejecting enrollment:', error);
                    alert('Error rejecting enrollment: ' + error.message);
                    return;
                }
                
                alert('Enrollment rejected. Payment proof has been automatically cleared for privacy.');
                loadEnrollmentRequests();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error rejecting enrollment: ' + e.message);
            }
        }

        async function deleteEnrollment(enrollmentId) {
            if (!confirm('Are you sure you want to delete this enrollment request?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('enrollments')
                    .delete()
                    .eq('id', enrollmentId);
                    
                if (error) {
                    console.error('Error deleting enrollment:', error);
                    alert('Error deleting enrollment: ' + error.message);
                    return;
                }
                
                alert('Enrollment request deleted successfully!');
                loadEnrollmentRequests();
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error deleting enrollment: ' + e.message);
            }
        }

        function filterEnrollmentRequests() {
            const statusFilter = document.getElementById('enrollmentStatusFilter').value;
            
            let filteredRequests = allEnrollmentRequests;
            if (statusFilter) {
                filteredRequests = allEnrollmentRequests.filter(enrollment => enrollment.status === statusFilter);
            }
            
            displayEnrollmentRequests(filteredRequests);
        }

        // Bulk Enrollment Functions
        async function loadClassesForBulkEnroll() {
            try {
                const { data: classes, error } = await supabase
                    .from('classes')
                    .select('*')
                    .order('name', { ascending: true });
                    
                if (error) {
                    console.error('Error loading classes for bulk enroll:', error);
                    return;
                }
                
                const select = document.getElementById('bulkEnrollClass');
                select.innerHTML = '<option value="">-- Select a Class --</option>';
                
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem.id;
                    option.textContent = classItem.name;
                    select.appendChild(option);
                });
                
            } catch (e) {
                console.error('Error loading classes:', e);
            }
        }

        async function bulkEnrollStudents() {
            const classId = document.getElementById('bulkEnrollClass').value;
            const resultsDiv = document.getElementById('bulkEnrollResults');
            
            if (!classId) {
                alert('Please select a class first!');
                return;
            }
            
            if (!confirm('This will enroll ALL approved students into the selected class. Are you sure?')) {
                return;
            }
            
            try {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div style="color: #007bff;">⏳ Processing bulk enrollment...</div>';
                
                // Get all approved students (those with status 'approved' in user_profiles)
                const { data: approvedStudents, error: studentsError } = await supabase
                    .from('user_profiles')
                    .select('user_id, name, email')
                    .eq('status', 'approved');
                    
                if (studentsError) throw studentsError;
                
                if (!approvedStudents || approvedStudents.length === 0) {
                    resultsDiv.innerHTML = '<div style="color: #dc3545;">❌ No approved students found.</div>';
                    return;
                }
                
                // Check which students are already enrolled in this class
                const { data: existingEnrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select('user_id')
                    .eq('class_id', classId);
                    
                if (enrollError) throw enrollError;
                
                const alreadyEnrolledUserIds = existingEnrollments.map(e => e.user_id);
                const studentsToEnroll = approvedStudents.filter(student => 
                    !alreadyEnrolledUserIds.includes(student.user_id)
                );
                
                if (studentsToEnroll.length === 0) {
                    resultsDiv.innerHTML = '<div style="color: #ffc107;">⚠️ All approved students are already enrolled in this class.</div>';
                    return;
                }
                
                // Create enrollment records for students not already enrolled
                const enrollmentData = studentsToEnroll.map(student => ({
                    user_id: student.user_id,
                    class_id: classId,
                    status: 'approved',
                    enrolled_at: new Date().toISOString(),
                    approved_at: new Date().toISOString(),
                    payment_proof_url: 'BULK_ENROLLED_BY_ADMIN',
                    payment_proof_filename: 'admin_bulk_enrollment.txt'
                }));
                
                const { error: insertError } = await supabase
                    .from('enrollments')
                    .insert(enrollmentData);
                    
                if (insertError) throw insertError;
                
                const skippedCount = approvedStudents.length - studentsToEnroll.length;
                
                resultsDiv.innerHTML = `
                    <div style="color: #28a745; font-weight: bold;">✅ Bulk enrollment completed!</div>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>${studentsToEnroll.length}</strong> students enrolled successfully</li>
                        ${skippedCount > 0 ? `<li><strong>${skippedCount}</strong> students were already enrolled</li>` : ''}
                        <li><strong>${approvedStudents.length}</strong> total approved students in system</li>
                    </ul>
                `;
                
                // Refresh the enrollment requests table
                loadEnrollmentRequests();
                
            } catch (e) {
                console.error('Error in bulk enrollment:', e);
                resultsDiv.innerHTML = `<div style="color: #dc3545;">❌ Error: ${e.message}</div>`;
            }
        }

        // Advanced Bulk Enrollment Matrix Functions
        let matrixStudents = [];
        let matrixClasses = [];
        let matrixExistingEnrollments = [];

        async function openBulkEnrollMatrix() {
            try {
                // Load students and classes
                await loadMatrixData();
                
                // Generate and display the matrix
                generateEnrollmentMatrix();
                
                // Show the modal
                document.getElementById('enrollmentMatrixModal').style.display = 'block';
                
            } catch (e) {
                console.error('Error opening enrollment matrix:', e);
                alert('Error loading enrollment matrix: ' + e.message);
            }
        }

        async function loadMatrixData() {
            // Load approved students
            const { data: students, error: studentsError } = await supabase
                .from('user_profiles')
                .select('user_id, name, email')
                .eq('status', 'approved')
                .order('name', { ascending: true });
                
            if (studentsError) throw studentsError;
            matrixStudents = students || [];

            // Load active classes
            const { data: classes, error: classesError } = await supabase
                .from('classes')
                .select('id, name')
                .eq('is_active', true)
                .order('name', { ascending: true });
                
            if (classesError) throw classesError;
            matrixClasses = classes || [];

            // Load existing enrollments
            const { data: enrollments, error: enrollError } = await supabase
                .from('enrollments')
                .select('user_id, class_id, status');
                
            if (enrollError) throw enrollError;
            matrixExistingEnrollments = enrollments || [];
        }

        function generateEnrollmentMatrix() {
            const tableDiv = document.getElementById('enrollmentMatrixTable');
            
            if (matrixStudents.length === 0 || matrixClasses.length === 0) {
                tableDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No approved students or active classes found.</div>';
                return;
            }

            let tableHTML = `
                <div style="display: flex; height: 100%; width: 100%;">
                    <!-- Fixed Student Names Column -->
                    <div id="studentNamesColumn" style="width: 250px; border-right: 2px solid #007bff; background: white; z-index: 100; overflow-y: auto; overflow-x: hidden;">
                        <table style="border-collapse: collapse; width: 100%; table-layout: fixed;">
                            <thead style="position: sticky; top: 0; z-index: 200; background: #f8f9fa;">
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background: #f5f5f5; width: 250px; height: 80px;">
                                        <div style="font-weight: bold;">Student Name</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Add student name rows for the fixed column
            matrixStudents.forEach(student => {
                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px; background: white; width: 250px; height: 60px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="selectStudent_${student.user_id}" onchange="toggleStudentRow('${student.user_id}')" style="transform: scale(1.1); margin-right: 8px;">
                                <div style="overflow: hidden; flex: 1;">
                                    <div style="font-weight: bold; font-size: 13px; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${student.name}</div>
                                    <div style="font-size: 11px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${student.email}</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Scrollable Classes Columns -->
                    <div id="classesColumn" style="flex: 1; overflow: auto;">
                        <table style="border-collapse: collapse; table-layout: fixed; width: ${matrixClasses.length * 140}px;">
                            <thead style="position: sticky; top: 0; z-index: 200; background: #f8f9fa;">
                                <tr style="background: #f8f9fa;">
            `;

            // Class header columns with "Select All" checkboxes
            matrixClasses.forEach(classItem => {
                tableHTML += `
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 140px; background: #f5f5f5; height: 80px;">
                        <div style="margin-bottom: 8px; font-weight: bold; font-size: 12px; line-height: 1.2; word-wrap: break-word;">${classItem.name}</div>
                        <div>
                            <input type="checkbox" id="selectClass_${classItem.id}" onchange="toggleClassColumn('${classItem.id}')" style="transform: scale(1.1);">
                            <label for="selectClass_${classItem.id}" style="font-size: 11px; margin-left: 5px;">All</label>
                        </div>
                    </th>
                `;
            });

            tableHTML += `
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Student rows with enrollment checkboxes
            matrixStudents.forEach(student => {
                tableHTML += `
                    <tr>
                `;

                // Class enrollment checkboxes
                matrixClasses.forEach(classItem => {
                    const isEnrolled = matrixExistingEnrollments.some(e => 
                        e.user_id === student.user_id && e.class_id === classItem.id
                    );
                    
                    const enrollmentStatus = matrixExistingEnrollments.find(e => 
                        e.user_id === student.user_id && e.class_id === classItem.id
                    )?.status || '';

                    if (isEnrolled) {
                        tableHTML += `
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #f5f5f5; width: 140px; height: 60px;">
                                <div style="color: #666; font-size: 11px; font-weight: bold;">
                                    ${enrollmentStatus.toUpperCase()}
                                </div>
                            </td>
                        `;
                    } else {
                        tableHTML += `
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 140px; height: 60px;">
                                <input type="checkbox" 
                                       id="enroll_${student.user_id}_${classItem.id}" 
                                       class="enrollment-checkbox" 
                                       data-student="${student.user_id}" 
                                       data-class="${classItem.id}"
                                       onchange="updateSelectionCount()" 
                                       style="transform: scale(1.4);">
                            </td>
                        `;
                    }
                });

                tableHTML += '</tr>';
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            tableDiv.innerHTML = tableHTML;
            
            // Add scroll synchronization
            setupScrollSync();
            updateSelectionCount();
        }

        function setupScrollSync() {
            const studentColumn = document.getElementById('studentNamesColumn');
            const classesColumn = document.getElementById('classesColumn');
            
            if (!studentColumn || !classesColumn) return;
            
            let syncing = false;
            
            // Sync vertical scroll from student names to classes
            studentColumn.addEventListener('scroll', function() {
                if (syncing) return;
                syncing = true;
                classesColumn.scrollTop = studentColumn.scrollTop;
                setTimeout(() => syncing = false, 10);
            });
            
            // Sync vertical scroll from classes to student names
            classesColumn.addEventListener('scroll', function() {
                if (syncing) return;
                syncing = true;
                studentColumn.scrollTop = classesColumn.scrollTop;
                setTimeout(() => syncing = false, 10);
            });
        }

        function toggleClassColumn(classId) {
            const classCheckbox = document.getElementById(`selectClass_${classId}`);
            const checkboxes = document.querySelectorAll(`[data-class="${classId}"]`);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = classCheckbox.checked;
            });
            
            updateSelectionCount();
        }

        function toggleStudentRow(studentId) {
            const studentCheckbox = document.getElementById(`selectStudent_${studentId}`);
            const checkboxes = document.querySelectorAll(`[data-student="${studentId}"]`);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = studentCheckbox.checked;
            });
            
            updateSelectionCount();
        }

        function selectAllMatrix() {
            const checkboxes = document.querySelectorAll('.enrollment-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateSelectionCount();
        }

        function clearAllMatrix() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const checkedBoxes = document.querySelectorAll('.enrollment-checkbox:checked');
            const count = checkedBoxes.length;
            document.getElementById('selectionCount').textContent = `${count} selection${count !== 1 ? 's' : ''}`;
        }

        async function processBulkEnrollments() {
            const checkedBoxes = document.querySelectorAll('.enrollment-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                alert('Please select at least one student-class combination!');
                return;
            }

            if (!confirm(`Are you sure you want to enroll ${checkedBoxes.length} student-class combinations?`)) {
                return;
            }

            try {
                const enrollmentData = [];
                
                checkedBoxes.forEach(checkbox => {
                    const studentId = checkbox.dataset.student;
                    const classId = checkbox.dataset.class;
                    
                    enrollmentData.push({
                        user_id: studentId,
                        class_id: classId,
                        status: 'approved',
                        enrolled_at: new Date().toISOString(),
                        approved_at: new Date().toISOString(),
                        payment_proof_url: 'BULK_ENROLLED_BY_ADMIN_MATRIX',
                        payment_proof_filename: 'admin_matrix_bulk_enrollment.txt'
                    });
                });

                const { error } = await supabase
                    .from('enrollments')
                    .insert(enrollmentData);
                    
                if (error) throw error;

                alert(`✅ Successfully enrolled ${enrollmentData.length} student-class combinations!`);
                
                // Close modal and refresh data
                closeBulkEnrollMatrix();
                loadEnrollmentRequests();
                
                // Show results in main panel
                const resultsDiv = document.getElementById('bulkEnrollResults');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div style="color: #28a745; font-weight: bold;">✅ Matrix enrollment completed!</div>
                    <div style="margin-top: 10px;"><strong>${enrollmentData.length}</strong> student-class combinations enrolled successfully</div>
                `;

            } catch (e) {
                console.error('Error in bulk matrix enrollment:', e);
                alert('Error processing enrollments: ' + e.message);
            }
        }

        function closeBulkEnrollMatrix() {
            document.getElementById('enrollmentMatrixModal').style.display = 'none';
        }

        // Student Reports Dashboard Functions
        let allStudentReports = [];
        let filteredStudentReports = [];

        async function loadStudentReports() {
            try {
                console.log('Loading student reports from Supabase...');
                
                // Show loading state
                const tbody = document.getElementById('studentReportsTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">Loading student data...</td></tr>';
                }
                
                // Load all students with their basic info
                const { data: students, error: studentsError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('name', { ascending: true });
                    
                if (studentsError) {
                    console.error('Error fetching students:', studentsError);
                    throw studentsError;
                }
                
                console.log(`Fetched ${students ? students.length : 0} students`);
                
                // Load all enrollments with class information - use a safer query that doesn't require inner join
                const { data: enrollments, error: enrollmentsError } = await supabase
                    .from('enrollments')
                    .select(`
                        user_id,
                        status,
                        class_id
                    `)
                    .eq('status', 'approved');
                    
                if (enrollmentsError) {
                    console.error('Error fetching enrollments:', enrollmentsError);
                    throw enrollmentsError;
                }
                
                console.log(`Fetched ${enrollments ? enrollments.length : 0} enrollments`);
                
                // Get classes
                const { data: classes, error: classesError } = await supabase
                    .from('classes')
                    .select('id, name');
                    
                if (classesError) {
                    console.error('Error fetching classes:', classesError);
                    throw classesError;
                }
                
                // Create a map of class IDs to names for quick lookup
                const classMap = {};
                if (classes) {
                    classes.forEach(c => classMap[c.id] = c.name);
                }
                
                // Combine student data with enrollment information
                allStudentReports = students.map(student => {
                    const studentEnrollments = enrollments ? enrollments.filter(e => e.user_id === student.user_id) : [];
                    const enrolledClasses = studentEnrollments.map(e => classMap[e.class_id] || 'Unknown Class');
                    
                    return {
                        ...student,
                        enrolledClasses: enrolledClasses,
                        totalClasses: enrolledClasses.length
                    };
                });
                
                // Populate batch filter options
                populateBatchFilter();
                
                // Display the data
                filteredStudentReports = [...allStudentReports];
                displayStudentReports();
                updateStudentCount();
                
                console.log(`Loaded ${allStudentReports.length} student reports`);
                
                // Make sure reports section is properly initialized
                const reportsSection = document.getElementById('reportsSection');
                if (reportsSection) {
                    console.log('Reports section found and initialized');
                } else {
                    console.error('Reports section element not found in DOM');
                }
                
            } catch (e) {
                console.error('Error loading student reports:', e);
                const tbody = document.getElementById('studentReportsTableBody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px; color: #dc3545;">Error loading student reports: ${e.message}</td></tr>`;
                } else {
                    console.error('studentReportsTableBody element not found');
                }
            }
        }

        function populateBatchFilter() {
            const batchFilter = document.getElementById('batchFilter');
            const batches = [...new Set(allStudentReports.map(s => s.batch).filter(b => b))];
            
            batchFilter.innerHTML = '<option value="">All Batches</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch;
                option.textContent = batch;
                batchFilter.appendChild(option);
            });
        }

        function displayStudentReports() {
            const tbody = document.getElementById('studentReportsTableBody');
            tbody.innerHTML = '';
            
            if (filteredStudentReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">No students found matching your criteria.</td></tr>';
                return;
            }
            
            filteredStudentReports.forEach(student => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                
                const statusClass = student.status === 'approved' ? 'approved' : 
                                   student.status === 'rejected' ? 'rejected' : 'pending';
                
                const enrolledClassesDisplay = student.enrolledClasses.length > 0 
                    ? student.enrolledClasses.map(className => 
                        `<span style="background: #f0f0f0; color: #333333; padding: 2px 6px; border-radius: 12px; font-size: 11px; margin: 1px; display: inline-block;">${className}</span>`
                    ).join(' ')
                    : '<span style="color: #666; font-style: italic;">No enrollments</span>';
                
                row.innerHTML = `
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <div style="font-weight: bold;">${student.name}</div>
                        ${student.profile_update_pending ? '<div style="color: #dc3545; font-size: 11px;">⚠️ Profile update pending</div>' : ''}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${student.email}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${student.nic}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${student.mobile}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${student.batch || '-'}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <span class="status-badge ${statusClass}">${student.status.toUpperCase()}</span>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; max-width: 300px;">
                        ${enrolledClassesDisplay}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                        <strong style="color: #007bff;">${student.totalClasses}</strong>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function searchStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredStudentReports = [...allStudentReports];
            } else {
                filteredStudentReports = allStudentReports.filter(student => 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm) ||
                    student.nic.toLowerCase().includes(searchTerm) ||
                    student.mobile.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply other filters
            applyStatusAndBatchFilters();
            displayStudentReports();
            updateStudentCount();
        }

        function filterStudents() {
            applyStatusAndBatchFilters();
            displayStudentReports();
            updateStudentCount();
        }

        function applyStatusAndBatchFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const batchFilter = document.getElementById('batchFilter').value;
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase().trim();
            
            filteredStudentReports = allStudentReports.filter(student => {
                const matchesSearch = searchTerm === '' || 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm) ||
                    student.nic.toLowerCase().includes(searchTerm) ||
                    student.mobile.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === '' || student.status === statusFilter;
                const matchesBatch = batchFilter === '' || student.batch === batchFilter;
                
                return matchesSearch && matchesStatus && matchesBatch;
            });
        }

        function updateStudentCount() {
            const countElement = document.getElementById('studentCount');
            const total = allStudentReports.length;
            const filtered = filteredStudentReports.length;
            
            if (filtered === total) {
                countElement.textContent = `📊 Showing ${total} student${total !== 1 ? 's' : ''}`;
            } else {
                countElement.textContent = `📊 Showing ${filtered} of ${total} student${total !== 1 ? 's' : ''}`;
            }
        }

        function exportStudentData() {
            if (filteredStudentReports.length === 0) {
                alert('No data to export. Please load student reports first.');
                return;
            }
            
            try {
                // Prepare CSV data
                const headers = ['Name', 'Email', 'NIC', 'Mobile', 'Batch', 'Status', 'Classes Enrolled', 'Total Classes'];
                const csvData = [headers];
                
                filteredStudentReports.forEach(student => {
                    const enrolledClassesText = student.enrolledClasses.length > 0 
                        ? student.enrolledClasses.join('; ')
                        : 'No enrollments';
                    
                    csvData.push([
                        student.name,
                        student.email,
                        student.nic,
                        student.mobile,
                        student.batch || '',
                        student.status,
                        enrolledClassesText,
                        student.totalClasses
                    ]);
                });
                
                // Convert to CSV string
                const csvString = csvData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                // Create and download file
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `student_reports_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`✅ Exported ${filteredStudentReports.length} student records to CSV file!`);
                
            } catch (e) {
                console.error('Export error:', e);
                alert('Error exporting data: ' + e.message);
            }
        }

        // User editing functions
        let currentEditingUser = null;

        function openEditUserModal(userId) {
            currentEditingUser = null;
            document.getElementById('editUserForm').reset();
            
            // Load user data
            getUserById(userId).then(userData => {
                if (!userData) {
                    alert('Error: User not found');
                    closeEditUserModal();
                    return;
                }
                
                // Populate form fields
                currentEditingUser = userData;
                document.getElementById('editUserId').value = userData.id;
                document.getElementById('editName').value = userData.name || '';
                document.getElementById('editEmail').value = userData.email || '';
                document.getElementById('editNIC').value = userData.nic || '';
                document.getElementById('editMobile').value = userData.mobile || '';
                document.getElementById('editBatch').value = userData.batch || '';
                document.getElementById('editStatus').value = userData.status || 'pending';
                
                // Show modal
                document.getElementById('editUserModal').style.display = 'block';
            });
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            currentEditingUser = null;
        }

        async function getUserById(userId) {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                    
                if (error) {
                    console.error('Error fetching user data:', error);
                    return null;
                }
                
                return data;
                
            } catch (e) {
                console.error('Error:', e);
                return null;
            }
        }

        // Handle edit user form submission
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditingUser) {
                alert('Error: No user data found');
                return;
            }
            
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const nic = document.getElementById('editNIC').value;
            const mobile = document.getElementById('editMobile').value;
            const batch = document.getElementById('editBatch').value;
            const status = document.getElementById('editStatus').value;
            
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({
                        name: name,
                        email: email,
                        nic: nic,
                        mobile: mobile,
                        batch: batch,
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                    
                if (error) {
                    console.error('Error updating user:', error);
                    alert('Error updating user: ' + error.message);
                    return;
                }
                
                alert('✅ Student information updated successfully!');
                closeEditUserModal();
                loadUsers(); // Refresh the user list
                
            } catch (e) {
                console.error('Error:', e);
                alert('Error updating user: ' + e.message);
            }
        });

        // Improve delete user function with better error handling and auth user cleanup
        async function deleteUser(userId) {
            if (!confirm('⚠️ Are you sure you want to delete this student? This action cannot be undone.')) {
                return;
            }
            
            try {
                // First get the user details to check if we need to delete from auth as well
                const { data: userData, error: userError } = await supabase
                    .from('user_profiles')
                    .select('user_id')
                    .eq('id', userId)
                    .single();
                    
                if (userError) {
                    console.error('Error fetching user data for deletion:', userError);
                    alert('Error preparing for user deletion: ' + userError.message);
                    return;
                }
                
                // 1. Delete enrollments first (due to foreign key constraints)
                if (userData.user_id) {
                    const { error: enrollmentError } = await supabase
                        .from('enrollments')
                        .delete()
                        .eq('user_id', userData.user_id);
                        
                    if (enrollmentError && !enrollmentError.message.includes('No rows found')) {
                        console.error('Error deleting user enrollments:', enrollmentError);
                        alert('Error deleting user enrollments: ' + enrollmentError.message);
                        return;
                    }
                }
                
                // 2. Delete the user profile
                const { error: profileError } = await supabase
                    .from('user_profiles')
                    .delete()
                    .eq('id', userId);
                    
                if (profileError) {
                    console.error('Error deleting user profile:', profileError);
                    alert('Error deleting user profile: ' + profileError.message);
                    return;
                }
                
                // 3. Attempt to delete the auth user (admin might not have permission)
                if (userData.user_id) {
                    try {
                        const { error: authError } = await supabase.auth.admin.deleteUser(
                            userData.user_id
                        );
                        
                        if (authError) {
                            console.warn('Could not delete auth user (requires admin privileges):', authError);
                            // Don't show this error to the user as the profile was deleted successfully
                        }
                    } catch (authError) {
                        console.warn('Auth user deletion not permitted with current access level:', authError);
                        // This is expected for non-admin users, so we don't show an error
                    }
                }
                
                alert('✅ Student deleted successfully!');
                loadUsers(); // Refresh the user list
                
            } catch (e) {
                console.error('Error deleting user:', e);
                alert('Error deleting user: ' + e.message);
            }
        }

        // Password Reset Management Functions
        let allPasswordResetRequests = [];

        // Function to update user password using RPC
        async function updateUserPasswordManually(userEmail, newPassword) {
            try {
                const { data, error } = await supabase.rpc('update_user_password_admin', {
                    user_email: userEmail,
                    new_password: newPassword
                });

                if (error) {
                    throw error;
                }

                if (data === true) {
                    console.log('Password updated successfully for:', userEmail);
                    return true;
                } else {
                    throw new Error('Password update function returned false - user may not exist');
                }

            } catch (error) {
                console.error('Password update failed:', error);
                throw error;
            }
        }

        async function loadPasswordResetRequests() {
            if (!supabase) {
                alert('Database connection required. Please enable Supabase MCP tool.');
                return;
            }

            try {
                const { data: requests, error } = await supabase
                    .from('password_reset_requests')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allPasswordResetRequests = requests || [];
                displayPasswordResetRequests();
                console.log('Loaded password reset requests:', allPasswordResetRequests.length);

            } catch (error) {
                console.error('Error loading password reset requests:', error);
                alert('Failed to load password reset requests: ' + error.message);
            }
        }

        function displayPasswordResetRequests() {
            const tbody = document.getElementById('passwordResetRequestsTable');
            
            if (allPasswordResetRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">No password reset requests found</td></tr>';
                return;
            }

            tbody.innerHTML = allPasswordResetRequests.map(request => {
                const statusClass = request.status === 'pending' ? 'status-pending' : 
                                  request.status === 'approved' ? 'status-approved' : 'status-rejected';
                
                const statusBadge = `<span class="${statusClass}">${request.status.toUpperCase()}</span>`;
                
                return `
                    <tr>
                        <td>${request.user_name || 'N/A'}</td>
                        <td>${request.user_email}</td>
                        <td>${request.user_nic || 'N/A'}</td>
                        <td style="max-width: 200px; word-wrap: break-word;">${request.reason || 'No reason provided'}</td>
                        <td>${statusBadge}</td>
                        <td>${new Date(request.created_at).toLocaleDateString()}</td>
                        <td>
                            ${request.status === 'pending' ? 
                                `<button class="action-btn" onclick="processPasswordResetRequest('${request.id}')">Process</button>` :
                                `<button class="action-btn secondary" onclick="viewPasswordResetRequest('${request.id}')">View</button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterPasswordResetRequests() {
            const statusFilter = document.getElementById('resetStatusFilter').value;
            
            const filteredRequests = statusFilter === '' ? 
                allPasswordResetRequests : 
                allPasswordResetRequests.filter(request => request.status === statusFilter);

            const tbody = document.getElementById('passwordResetRequestsTable');
            
            if (filteredRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">No requests match the selected filter</td></tr>';
                return;
            }

            tbody.innerHTML = filteredRequests.map(request => {
                const statusClass = request.status === 'pending' ? 'status-pending' : 
                                  request.status === 'approved' ? 'status-approved' : 'status-rejected';
                
                const statusBadge = `<span class="${statusClass}">${request.status.toUpperCase()}</span>`;
                
                return `
                    <tr>
                        <td>${request.user_name || 'N/A'}</td>
                        <td>${request.user_email}</td>
                        <td>${request.user_nic || 'N/A'}</td>
                        <td style="max-width: 200px; word-wrap: break-word;">${request.reason || 'No reason provided'}</td>
                        <td>${statusBadge}</td>
                        <td>${new Date(request.created_at).toLocaleDateString()}</td>
                        <td>
                            ${request.status === 'pending' ? 
                                `<button class="action-btn" onclick="processPasswordResetRequest('${request.id}')">Process</button>` :
                                `<button class="action-btn secondary" onclick="viewPasswordResetRequest('${request.id}')">View</button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function processPasswordResetRequest(requestId) {
            const request = allPasswordResetRequests.find(r => r.id === requestId);
            if (!request) {
                alert('Request not found');
                return;
            }

            // Populate modal with request details
            document.getElementById('resetRequestId').value = requestId;
            document.getElementById('resetRequestDetails').innerHTML = `
                <h4>Request Details</h4>
                <p><strong>Student:</strong> ${request.user_name || 'N/A'}</p>
                <p><strong>Email:</strong> ${request.user_email}</p>
                <p><strong>NIC:</strong> ${request.user_nic || 'N/A'}</p>
                <p><strong>Reason:</strong> ${request.reason || 'No reason provided'}</p>
                <p><strong>Submitted:</strong> ${new Date(request.created_at).toLocaleString()}</p>
            `;

            // Reset form
            document.getElementById('resetAction').value = '';
            document.getElementById('temporaryPassword').value = '';
            document.getElementById('adminNotes').value = '';
            document.getElementById('temporaryPasswordGroup').style.display = 'none';

            // Show modal
            document.getElementById('passwordResetModal').style.display = 'block';
        }

        function viewPasswordResetRequest(requestId) {
            const request = allPasswordResetRequests.find(r => r.id === requestId);
            if (!request) {
                alert('Request not found');
                return;
            }

            let details = `Password Reset Request Details:\n\n`;
            details += `Student: ${request.user_name || 'N/A'}\n`;
            details += `Email: ${request.user_email}\n`;
            details += `NIC: ${request.user_nic || 'N/A'}\n`;
            details += `Reason: ${request.reason || 'No reason provided'}\n`;
            details += `Status: ${request.status.toUpperCase()}\n`;
            details += `Submitted: ${new Date(request.created_at).toLocaleString()}\n`;

            if (request.status === 'approved') {
                details += `\nApproved by: ${request.approved_by || 'Administrator'}\n`;
                if (request.approved_at) {
                    details += `Approved on: ${new Date(request.approved_at).toLocaleString()}\n`;
                }
                if (request.temporary_password) {
                    details += `Temporary Password: ${request.temporary_password}\n`;
                }
            }

            if (request.admin_notes) {
                details += `\nAdmin Notes: ${request.admin_notes}`;
            }

            alert(details);
        }

        function toggleTemporaryPasswordField() {
            const action = document.getElementById('resetAction').value;
            const passwordGroup = document.getElementById('temporaryPasswordGroup');
            
            if (action === 'approved') {
                passwordGroup.style.display = 'block';
                document.getElementById('temporaryPassword').required = true;
            } else {
                passwordGroup.style.display = 'none';
                document.getElementById('temporaryPassword').required = false;
            }
        }

        function generateTemporaryPassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('temporaryPassword').value = password;
        }

        function closePasswordResetModal() {
            document.getElementById('passwordResetModal').style.display = 'none';
        }

        // Process Reset Form Handler
        document.getElementById('processResetForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const requestId = document.getElementById('resetRequestId').value;
            const action = document.getElementById('resetAction').value;
            const temporaryPassword = document.getElementById('temporaryPassword').value;
            const adminNotes = document.getElementById('adminNotes').value;

            if (!action) {
                alert('Please select an action');
                return;
            }

            if (action === 'approved' && !temporaryPassword) {
                alert('Please provide a temporary password for approved requests');
                return;
            }

            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Processing...';
            submitButton.disabled = true;

            try {
                // Update request status
                const updateData = {
                    status: action,
                    admin_notes: adminNotes,
                    approved_by: 'Administrator',
                    approved_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                if (action === 'approved') {
                    updateData.temporary_password = temporaryPassword;

                    // Update user password in auth
                    const request = allPasswordResetRequests.find(r => r.id === requestId);
                    if (request) {
                        try {
                            // Since we can't directly update other users' passwords with the anon key,
                            // we'll use a workaround: create a manual SQL update
                            await updateUserPasswordManually(request.user_email, temporaryPassword);
                            console.log('Password updated successfully for:', request.user_email);
                        } catch (authError) {
                            console.error('Could not update auth password:', authError);
                            alert('Warning: Password reset approved but could not update the actual password. User may need to contact support.');
                        }
                    }
                }

                const { error } = await supabase
                    .from('password_reset_requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                alert(`Password reset request ${action} successfully!`);
                closePasswordResetModal();
                loadPasswordResetRequests();

            } catch (error) {
                console.error('Error processing reset request:', error);
                alert('Failed to process request: ' + error.message);
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const bulkUploadModal = document.getElementById('bulkUploadModal');
            const enrollmentMatrixModal = document.getElementById('enrollmentMatrixModal');
            const editUserModal = document.getElementById('editUserModal');
            const passwordResetModal = document.getElementById('passwordResetModal');
            
            if (event.target === bulkUploadModal) {
                closeBulkUploadModal();
            }
            if (event.target === enrollmentMatrixModal) {
                closeBulkEnrollMatrix();
            }
            if (event.target === editUserModal) {
                closeEditUserModal();
            }
            if (event.target === passwordResetModal) {
                closePasswordResetModal();
            }
        }
        // Recording Management Functions
        async function loadRecordingClasses() {
            try {
                const { data: classes, error } = await supabase
                    .from('classes')
                    .select('id, name')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('recordingClass');
                select.innerHTML = '<option value="">Select a class</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading classes for recordings:', error);
            }
        }

        let allRecordingRequests = [];

        async function loadRecordingRequests() {
            try {
                console.log('Loading recording requests from Supabase...');
                
                // Load recording requests first
                const { data: requests, error: requestsError } = await supabase
                    .from('recording_requests')
                    .select('*')
                    .order('requested_at', { ascending: false });

                if (requestsError) {
                    console.error('Error loading recording requests:', requestsError);
                    allRecordingRequests = [];
                    const tbody = document.getElementById('recordingRequestsTableBody');
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #dc3545;">Error loading requests: ' + requestsError.message + '</td></tr>';
                    return;
                }

                console.log(`Fetched ${requests ? requests.length : 0} recording requests`);

                // Get user profiles
                const { data: userProfiles, error: usersError } = await supabase
                    .from('user_profiles')
                    .select('user_id, name, email');
                    
                if (usersError) {
                    console.error('Error loading user profiles:', usersError);
                }

                // Get classes
                const { data: classes, error: classesError } = await supabase
                    .from('classes')
                    .select('id, name');
                    
                if (classesError) {
                    console.error('Error loading classes:', classesError);
                }

                // Get enrollments to check enrollment status
                const { data: enrollments, error: enrollmentsError } = await supabase
                    .from('enrollments')
                    .select('user_id, class_id, status');
                    
                if (enrollmentsError) {
                    console.error('Error loading enrollments:', enrollmentsError);
                }

                // Get class recordings to check if recordings are available
                const { data: recordings, error: recordingsError } = await supabase
                    .from('class_recordings')
                    .select('class_id, google_drive_url, zoom_url');
                    
                if (recordingsError) {
                    console.error('Error loading class recordings:', recordingsError);
                }

                // Create lookup maps
                const userMap = {};
                if (userProfiles) {
                    userProfiles.forEach(user => {
                        userMap[user.user_id] = { name: user.name, email: user.email };
                    });
                }

                const classMap = {};
                if (classes) {
                    classes.forEach(cls => {
                        classMap[cls.id] = { name: cls.name };
                    });
                }

                const enrollmentMap = {};
                if (enrollments) {
                    enrollments.forEach(enrollment => {
                        const key = `${enrollment.user_id}_${enrollment.class_id}`;
                        enrollmentMap[key] = enrollment.status;
                    });
                }

                const recordingMap = {};
                if (recordings) {
                    recordings.forEach(recording => {
                        recordingMap[recording.class_id] = {
                            google_drive_url: recording.google_drive_url,
                            zoom_url: recording.zoom_url
                        };
                    });
                }

                // Combine the data manually
                allRecordingRequests = requests ? requests.map(request => {
                    const enrollmentKey = `${request.user_id}_${request.class_id}`;
                    return {
                        ...request,
                        user_profiles: userMap[request.user_id] || { name: 'Unknown User', email: 'Unknown Email' },
                        classes: classMap[request.class_id] || { name: 'Unknown Class' },
                        enrollment_status: enrollmentMap[enrollmentKey] || 'not enrolled',
                        recording_available: !!(recordingMap[request.class_id] && (recordingMap[request.class_id].google_drive_url || recordingMap[request.class_id].zoom_url))
                    };
                }) : [];

                console.log(`Combined ${allRecordingRequests.length} recording requests with related data`);
                displayRecordingRequests();
                
                // Show notification if there are pending recording requests
                const pendingRequests = allRecordingRequests.filter(request => request.status === 'pending').length;
                if (pendingRequests > 0) {
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 120px; right: 20px; background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
                    notification.innerHTML = `<strong>🎥 Recording Requests:</strong> ${pendingRequests} recording request${pendingRequests > 1 ? 's' : ''} pending approval`;
                    document.body.appendChild(notification);
                    
                    // Remove after 5 seconds
                    setTimeout(() => notification.remove(), 5000);
                }
                
            } catch (error) {
                console.error('Error loading recording requests:', error);
                allRecordingRequests = [];
                const tbody = document.getElementById('recordingRequestsTableBody');
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #dc3545;">Error loading requests: ' + error.message + '</td></tr>';
            }
        }

        function displayRecordingRequests() {
            const tbody = document.getElementById('recordingRequestsTableBody');
            tbody.innerHTML = '';

            if (allRecordingRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">No recording requests found</td></tr>';
                return;
            }

            // Analyze duplicate requests (same student + same class)
            const duplicateMap = {};
            allRecordingRequests.forEach(request => {
                const key = `${request.user_id}_${request.class_id}`;
                if (!duplicateMap[key]) {
                    duplicateMap[key] = [];
                }
                duplicateMap[key].push(request);
            });

            // Create a map of request counts for easy lookup
            const requestCountMap = {};
            let totalDuplicateRequests = 0;
            Object.keys(duplicateMap).forEach(key => {
                const requests = duplicateMap[key];
                if (requests.length > 1) {
                    totalDuplicateRequests += requests.length;
                }
                requests.forEach(request => {
                    requestCountMap[request.id] = {
                        count: requests.length,
                        requests: requests.sort((a, b) => new Date(b.requested_at) - new Date(a.requested_at))
                    };
                });
            });

            // Update duplicate requests summary
            const summaryDiv = document.getElementById('duplicateRequestsSummary');
            const duplicateCountSpan = document.getElementById('duplicateCount');
            if (totalDuplicateRequests > 0) {
                summaryDiv.style.display = 'block';
                duplicateCountSpan.textContent = `${totalDuplicateRequests} requests`;
            } else {
                summaryDiv.style.display = 'none';
            }

            allRecordingRequests.forEach(request => {
                const row = document.createElement('tr');
                const requestDate = new Date(request.requested_at).toLocaleDateString();
                
                // Get duplicate information for this request
                const duplicateInfo = requestCountMap[request.id];
                const isDuplicate = duplicateInfo.count > 1;
                
                const statusColors = {
                    pending: '#856404',
                    approved: '#155724',
                    rejected: '#721c24'
                };
                
                const statusBgs = {
                    pending: '#fff3cd',
                    approved: '#d4edda',
                    rejected: '#f8d7da'
                };

                const enrollmentBadge = request.enrollment_status === 'approved' 
                    ? '<span style="color: #28a745; font-weight: bold;">✅ Enrolled</span>'
                    : '<span style="color: #dc3545;">❌ Not Enrolled</span>';

                const recordingAvailable = request.recording_available
                    ? '<span style="color: #28a745;">✅ Available</span>'
                    : '<span style="color: #dc3545;">❌ Not Available</span>';

                // Handle payment proof display for recording requests - check if it's base64 data or URL
                let paymentProof = '<span style="color: #6c757d;">Not provided</span>';
                if (request.payment_proof_url) {
                    if (request.payment_proof_url.startsWith('data:')) {
                        // Base64 encoded file - create a preview button
                        const filename = request.payment_proof_filename || 'payment_proof';
                        paymentProof = `
                            <button onclick="viewPaymentProof('${request.id}', '${request.payment_proof_url}', '${filename}')" 
                                    style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                📄 View Proof
                            </button>
                        `;
                    } else {
                        // Regular URL - create link
                        paymentProof = `<a href="${request.payment_proof_url}" target="_blank" style="color: #007bff; text-decoration: none;">🔗 View Proof</a>`;
                    }
                }

                // Create duplicate information display
                let duplicateDisplay = '<span style="color: #28a745; font-size: 12px;">✅ First Request</span>';
                if (isDuplicate) {
                    const allRequests = duplicateInfo.requests;
                    const currentIndex = allRequests.findIndex(r => r.id === request.id) + 1;
                    
                    // Create a detailed popup with all request history
                    const requestHistory = allRequests.map((r, index) => {
                        const date = new Date(r.requested_at).toLocaleDateString();
                        const time = new Date(r.requested_at).toLocaleTimeString();
                        const current = r.id === request.id ? ' (CURRENT)' : '';
                        return `${index + 1}. ${date} ${time} - ${r.status.toUpperCase()}${current}`;
                    }).join('\\n');
                    
                    duplicateDisplay = `
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                🔄 ${duplicateInfo.count}x REQUESTED
                            </span>
                            <button onclick="alert('Request History for ${request.user_profiles.name} - ${request.classes.name}:\\n\\n${requestHistory}')" 
                                    style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                                📋 History
                            </button>
                        </div>
                    `;
                }

                const actions = request.status === 'pending' 
                    ? `<button onclick="approveRecordingRequest('${request.id}')" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px;">Approve</button>
                       <button onclick="rejectRecordingRequest('${request.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px;">Reject</button>`
                    : request.status === 'rejected' ? 
                        `<button onclick="approveRecordingRequest('${request.id}')" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px;">Approve</button>`
                    : `<span style="color: #666; font-style: italic;">Approved</span>`;

                // Highlight duplicate rows with background color
                const rowStyle = isDuplicate ? 'background-color: #fff3cd;' : '';
                row.style.cssText = rowStyle;

                // Create expiry information
                let expiryInfo = '<span style="color: #666;">No limit</span>';
                if (request.access_expiry_minutes) {
                    if (request.status === 'approved') {
                        if (!request.first_accessed_at) {
                            const expiryText = formatExpiryTimeAdmin(request.access_expiry_minutes);
                            expiryInfo = `<span style="color: #ff6b35;">⏰ ${expiryText} after first access</span>`;
                        } else {
                            const now = new Date();
                            const expiryTime = new Date(request.access_expires_at);
                            if (now > expiryTime) {
                                expiryInfo = `<span style="color: #dc3545;">❌ Expired</span>`;
                            } else {
                                const remainingMinutes = Math.floor((expiryTime - now) / (1000 * 60));
                                const remainingText = formatRemainingTimeAdmin(remainingMinutes);
                                expiryInfo = `<span style="color: #28a745;">✅ ${remainingText} remaining</span>`;
                            }
                        }
                    } else {
                        const expiryText = formatExpiryTimeAdmin(request.access_expiry_minutes);
                        expiryInfo = `<span style="color: #6c757d;">${expiryText} (when approved)</span>`;
                    }
                }

                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${request.user_profiles.name}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${request.user_profiles.email}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${request.classes.name}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${enrollmentBadge}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${requestDate}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                              background: ${statusBgs[request.status]}; color: ${statusColors[request.status]};">
                            ${request.status.toUpperCase()}
                        </span>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 11px;">${expiryInfo}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${paymentProof}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${recordingAvailable}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${duplicateDisplay}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${actions}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterRecordingRequests() {
            const statusFilter = document.getElementById('recordingStatusFilter').value;
            const duplicateFilter = document.getElementById('duplicateFilter').value;
            
            let filteredRequests = allRecordingRequests;
            
            // Apply status filter
            if (statusFilter) {
                filteredRequests = filteredRequests.filter(request => request.status === statusFilter);
            }
            
            // Apply duplicate filter
            if (duplicateFilter) {
                // First, analyze duplicates in the current filtered set
                const duplicateMap = {};
                filteredRequests.forEach(request => {
                    const key = `${request.user_id}_${request.class_id}`;
                    if (!duplicateMap[key]) {
                        duplicateMap[key] = [];
                    }
                    duplicateMap[key].push(request);
                });
                
                if (duplicateFilter === 'duplicates') {
                    // Show only requests that have duplicates
                    filteredRequests = filteredRequests.filter(request => {
                        const key = `${request.user_id}_${request.class_id}`;
                        return duplicateMap[key].length > 1;
                    });
                } else if (duplicateFilter === 'unique') {
                    // Show only requests that don't have duplicates
                    filteredRequests = filteredRequests.filter(request => {
                        const key = `${request.user_id}_${request.class_id}`;
                        return duplicateMap[key].length === 1;
                    });
                }
            }
            
            // Temporarily replace allRecordingRequests for display
            const originalRequests = allRecordingRequests;
            allRecordingRequests = filteredRequests;
            displayRecordingRequests();
            allRecordingRequests = originalRequests;
        }

        async function approveRecordingRequest(requestId) {
            // Show modal for approval with expiry time option
            showRecordingApprovalModal(requestId);
        }

        function showRecordingApprovalModal(requestId) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0; color: #333;">Approve Recording Request</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Access Duration (Optional):
                        </label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="expiryAmount" placeholder="0" 
                                   style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" min="0">
                            <select id="expiryUnit" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="minutes">Minutes</option>
                                <option value="hours" selected>Hours</option>
                                <option value="days">Days</option>
                                <option value="weeks">Weeks</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Leave empty for unlimited access. Time starts counting when student first clicks the recording.
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="confirmRecordingApproval('${requestId}')" 
                                style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">
                            Approve Request
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function confirmRecordingApproval(requestId) {
            const expiryAmount = document.getElementById('expiryAmount').value;
            const expiryUnit = document.getElementById('expiryUnit').value;
            
            let expiryMinutes = null;
            
            if (expiryAmount && parseInt(expiryAmount) > 0) {
                const amount = parseInt(expiryAmount);
                switch (expiryUnit) {
                    case 'minutes':
                        expiryMinutes = amount;
                        break;
                    case 'hours':
                        expiryMinutes = amount * 60;
                        break;
                    case 'days':
                        expiryMinutes = amount * 60 * 24;
                        break;
                    case 'weeks':
                        expiryMinutes = amount * 60 * 24 * 7;
                        break;
                    case 'months':
                        expiryMinutes = amount * 60 * 24 * 30;
                        break;
                }
            }

            try {
                const updateData = {
                    status: 'approved',
                    approved_at: new Date().toISOString(),
                    // Clear payment proof data after approval - no longer needed
                    payment_proof_url: null,
                    payment_proof_filename: null,
                    access_expiry_minutes: expiryMinutes
                };

                const { error } = await supabase
                    .from('recording_requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                // Close modal
                document.querySelector('div[style*="position: fixed"]').remove();

                const expiryText = expiryMinutes ? 
                    ` Access will expire ${expiryAmount} ${expiryUnit} after first access.` : 
                    ' Unlimited access granted.';
                
                alert('Recording request approved successfully!' + expiryText + ' Payment proof has been automatically cleared for privacy.');
                loadRecordingRequests();

            } catch (error) {
                console.error('Error approving recording request:', error);
                alert('Error approving request: ' + error.message);
            }
        }

        async function rejectRecordingRequest(requestId) {
            const reason = prompt('Enter rejection reason (optional):');
            
            try {
                const { error } = await supabase
                    .from('recording_requests')
                    .update({
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejection_reason: reason || 'No reason provided',
                        // Clear payment proof data after rejection - no longer needed
                        payment_proof_url: null,
                        payment_proof_filename: null,
                        // Clear expiry data as well
                        access_expiry_minutes: null,
                        first_accessed_at: null,
                        access_expires_at: null
                    })
                    .eq('id', requestId);

                if (error) throw error;

                alert('Recording request rejected. Payment proof has been automatically cleared for privacy.');
                loadRecordingRequests();

            } catch (error) {
                console.error('Error rejecting recording request:', error);
                alert('Error rejecting request: ' + error.message);
            }
        }

        function formatExpiryTimeAdmin(minutes) {
            if (minutes < 60) {
                return `${minutes}min`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const remainingMins = minutes % 60;
                return remainingMins === 0 ? `${hours}h` : `${hours}h ${remainingMins}m`;
            } else {
                const days = Math.floor(minutes / 1440);
                const remainingHours = Math.floor((minutes % 1440) / 60);
                return remainingHours === 0 ? `${days}d` : `${days}d ${remainingHours}h`;
            }
        }

        function formatRemainingTimeAdmin(minutes) {
            if (minutes < 60) {
                return `${minutes}min`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const remainingMins = minutes % 60;
                return remainingMins === 0 ? `${hours}h` : `${hours}h ${remainingMins}m`;
            } else {
                const days = Math.floor(minutes / 1440);
                const remainingHours = Math.floor((minutes % 1440) / 60);
                return remainingHours === 0 ? `${days}d` : `${days}d ${remainingHours}h`;
            }
        }

        async function loadExistingRecordings() {
            try {
                const { data: recordings, error } = await supabase
                    .from('class_recordings')
                    .select(`
                        *,
                        classes!inner(name)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('existingRecordingsTableBody');
                tbody.innerHTML = '';

                if (recordings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No recordings uploaded yet</td></tr>';
                    return;
                }

                recordings.forEach(recording => {
                    const row = document.createElement('tr');
                    const uploadDate = new Date(recording.created_at).toLocaleDateString();

                    // Build recording links display
                    let recordingLinks = '';
                    if (recording.google_drive_url) {
                        recordingLinks += `<a href="${recording.google_drive_url}" target="_blank" style="color: #007bff; text-decoration: none; margin-right: 10px;">📁 Google Drive</a>`;
                    }
                    if (recording.zoom_url) {
                        recordingLinks += `<a href="${recording.zoom_url}" target="_blank" style="color: #007bff; text-decoration: none;">📹 Zoom</a>`;
                    }
                    if (!recordingLinks) {
                        recordingLinks = '<span style="color: #666;">No links available</span>';
                    }

                    row.innerHTML = `
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${recording.classes.name}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${recording.title}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${recording.description || 'No description'}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${uploadDate}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">
                            ${recordingLinks}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">
                            <button onclick="deleteRecording('${recording.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px;">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading existing recordings:', error);
                const tbody = document.getElementById('existingRecordingsTableBody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">Error loading recordings</td></tr>';
            }
        }

        async function deleteRecording(recordingId) {
            if (!confirm('Are you sure you want to delete this recording? This action cannot be undone.')) return;

            try {
                const { error } = await supabase
                    .from('class_recordings')
                    .delete()
                    .eq('id', recordingId);

                if (error) throw error;

                alert('Recording deleted successfully!');
                loadExistingRecordings();

            } catch (error) {
                console.error('Error deleting recording:', error);
                alert('Error deleting recording: ' + error.message);
            }
        }

        // Recording Upload Form Submission
        document.getElementById('recordingUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const classId = document.getElementById('recordingClass').value;
            const title = document.getElementById('recordingTitle').value;
            const description = document.getElementById('recordingDescription').value;
            const googleDriveUrl = document.getElementById('googleDriveUrl').value;
            const zoomUrl = document.getElementById('zoomUrl').value;

            if (!classId || !title || (!googleDriveUrl && !zoomUrl)) {
                alert('Please fill in all required fields. At least one recording link (Google Drive or Zoom) is required.');
                return;
            }

            try {
                // Check if recording already exists for this class
                const { data: existing, error: checkError } = await supabase
                    .from('class_recordings')
                    .select('id')
                    .eq('class_id', classId)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = no rows found
                    throw checkError;
                }

                if (existing) {
                    if (!confirm('A recording already exists for this class. Do you want to update it?')) {
                        return;
                    }

                    // Update existing recording
                    const { error: updateError } = await supabase
                        .from('class_recordings')
                        .update({
                            title: title,
                            description: description,
                            google_drive_url: googleDriveUrl || null,
                            zoom_url: zoomUrl || null,
                            updated_at: new Date().toISOString()
                        })
                        .eq('class_id', classId);

                    if (updateError) throw updateError;

                    alert('Recording updated successfully!');
                } else {
                    // Insert new recording
                    const { error: insertError } = await supabase
                        .from('class_recordings')
                        .insert({
                            class_id: classId,
                            title: title,
                            description: description,
                            google_drive_url: googleDriveUrl || null,
                            zoom_url: zoomUrl || null
                            // created_by is nullable and will be NULL for admin uploads
                        });

                    if (insertError) throw insertError;

                    alert('Recording uploaded successfully!');
                }

                // Reset form and reload data
                document.getElementById('recordingUploadForm').reset();
                loadExistingRecordings();

            } catch (error) {
                console.error('Error uploading recording:', error);
                alert('Error uploading recording: ' + error.message);
            }
        });

        // Load recording classes when recording management section is shown
        function initializeRecordingManagement() {
            loadRecordingClasses();
            loadRecordingRequests();
            loadExistingRecordings();
        }

        // Automatic cleanup function for old payment proof data
        async function cleanupOldPaymentProofs() {
            try {
                // Clean up enrollment payment proofs older than 30 days in pending status
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const { error: enrollmentError } = await supabase
                    .from('enrollments')
                    .update({
                        payment_proof_url: null,
                        payment_proof_filename: null
                    })
                    .eq('status', 'pending')
                    .lt('enrolled_at', thirtyDaysAgo.toISOString())
                    .not('payment_proof_url', 'is', null);
                
                if (enrollmentError) {
                    console.error('Error cleaning up enrollment payment proofs:', enrollmentError);
                }
                
                // Clean up recording request payment proofs older than 30 days in pending status
                const { error: recordingError } = await supabase
                    .from('recording_requests')
                    .update({
                        payment_proof_url: null,
                        payment_proof_filename: null
                    })
                    .eq('status', 'pending')
                    .lt('requested_at', thirtyDaysAgo.toISOString())
                    .not('payment_proof_url', 'is', null);
                
                if (recordingError) {
                    console.error('Error cleaning up recording request payment proofs:', recordingError);
                }
                
                console.log('Automatic payment proof cleanup completed');
                
            } catch (error) {
                console.error('Error during payment proof cleanup:', error);
            }
        }

        // Run cleanup when admin logs in and every hour while admin is active
        function startPaymentProofCleanup() {
            // Run cleanup immediately when admin logs in
            cleanupOldPaymentProofs();
            
            // Set up periodic cleanup every hour (3600000 ms)
            setInterval(cleanupOldPaymentProofs, 3600000);
        }

        // Manual cleanup function with user feedback
        async function manualPaymentProofCleanup() {
            if (!confirm('This will permanently remove all payment proof files from pending requests older than 30 days. Continue?')) {
                return;
            }
            
            const resultDiv = document.getElementById('cleanupResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#cce5ff';
            resultDiv.style.color = '#004085';
            resultDiv.innerHTML = '⏳ Cleaning up old payment proofs...';
            
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                // Count how many will be cleaned up first
                const { data: enrollmentCount } = await supabase
                    .from('enrollments')
                    .select('id')
                    .eq('status', 'pending')
                    .lt('enrolled_at', thirtyDaysAgo.toISOString())
                    .not('payment_proof_url', 'is', null);
                
                const { data: recordingCount } = await supabase
                    .from('recording_requests')
                    .select('id')
                    .eq('status', 'pending')
                    .lt('requested_at', thirtyDaysAgo.toISOString())
                    .not('payment_proof_url', 'is', null);
                
                const totalToClean = (enrollmentCount?.length || 0) + (recordingCount?.length || 0);
                
                if (totalToClean === 0) {
                    resultDiv.style.background = '#d1ecf1';
                    resultDiv.style.color = '#0c5460';
                    resultDiv.innerHTML = '✅ No old payment proofs found to clean up. System is already clean!';
                    return;
                }
                
                // Perform the actual cleanup
                await cleanupOldPaymentProofs();
                
                resultDiv.style.background = '#d4edda';
                resultDiv.style.color = '#155724';
                resultDiv.innerHTML = `✅ Successfully cleaned up ${totalToClean} old payment proof file${totalToClean > 1 ? 's' : ''} from pending requests older than 30 days.`;
                
                // Refresh the current data if we're on relevant sections
                if (currentSection === 'enrollmentRequests') {
                    loadEnrollmentRequests();
                } else if (currentSection === 'recordingManagement') {
                    loadRecordingRequests();
                }
                
            } catch (error) {
                console.error('Error during manual cleanup:', error);
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.innerHTML = '❌ Error during cleanup: ' + error.message;
            }
            
            // Hide result after 10 seconds
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 10000);
        }

        // Payment Proof Viewing Function for base64 data
        function viewPaymentProof(enrollmentId, base64Data, filename) {
            // Create a modal to display the payment proof
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                background: white;
                border-radius: 8px;
                padding: 20px;
                position: relative;
                cursor: default;
            `;
            
            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                z-index: 2001;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            // Title
            const title = document.createElement('h3');
            title.textContent = `Payment Proof: ${filename}`;
            title.style.marginBottom = '15px';
            
            // Check if it's an image or other file type
            if (base64Data.startsWith('data:image/')) {
                // Display as image
                const img = document.createElement('img');
                img.src = base64Data;
                img.style.cssText = 'max-width: 100%; max-height: 70vh; object-fit: contain;';
                content.appendChild(title);
                content.appendChild(img);
            } else {
                // For non-image files, provide download option
                const downloadBtn = document.createElement('a');
                downloadBtn.href = base64Data;
                downloadBtn.download = filename;
                downloadBtn.textContent = `Download ${filename}`;
                downloadBtn.style.cssText = `
                    display: inline-block;
                    background: #007bff;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    text-decoration: none;
                    margin-top: 10px;
                `;
                
                const info = document.createElement('p');
                info.textContent = 'Click below to download the payment proof file:';
                
                content.appendChild(title);
                content.appendChild(info);
                content.appendChild(downloadBtn);
            }
            
            content.appendChild(closeBtn);
            modal.appendChild(content);
            
            // Close modal when clicking outside
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            // Prevent content clicks from closing modal
            content.onclick = (e) => e.stopPropagation();
            
            document.body.appendChild(modal);
        }

        // Notes Management Functions
        async function loadNotesClasses() {
            try {
                const { data: classes, error } = await supabase
                    .from('classes')
                    .select('id, name')
                    .eq('is_active', true)
                    .order('name');

                if (error) {
                    console.error('Error loading classes for notes:', error);
                    return;
                }

                const select = document.getElementById('notesClassId');
                select.innerHTML = '<option value="">Select a class</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error in loadNotesClasses:', error);
            }
        }

        async function loadExistingNotes() {
            try {
                console.log('Loading existing notes...');
                
                const { data: notes, error } = await supabase
                    .from('class_notes')
                    .select('*, classes(name)')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading notes:', error);
                    const tbody = document.getElementById('existingNotesTableBody');
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">Error loading notes</td></tr>';
                    return;
                }

                displayExistingNotes(notes || []);
            } catch (error) {
                console.error('Error in loadExistingNotes:', error);
            }
        }

        function displayExistingNotes(notes) {
            const tbody = document.getElementById('existingNotesTableBody');
            tbody.innerHTML = '';

            if (notes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No notes uploaded yet</td></tr>';
                return;
            }

            notes.forEach(note => {
                const row = document.createElement('tr');
                const uploadDate = new Date(note.created_at).toLocaleDateString();
                const className = note.classes?.name || 'Unknown Class';
                
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${className}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: 600;">${note.title}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${note.description || 'No description'}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${uploadDate}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <a href="${note.google_drive_url}" target="_blank" style="color: #007bff; text-decoration: none; font-size: 12px;">
                            🔗 View on Drive
                        </a>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <button onclick="deleteNote('${note.id}', '${note.title}')" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                            🗑️ Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function deleteNote(noteId, noteTitle) {
            if (!confirm(`Are you sure you want to delete the note: "${noteTitle}"?`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('class_notes')
                    .update({ is_active: false })
                    .eq('id', noteId);

                if (error) {
                    console.error('Error deleting note:', error);
                    alert('Error deleting note: ' + error.message);
                    return;
                }

                alert('Note deleted successfully!');
                loadExistingNotes(); // Refresh the list
            } catch (error) {
                console.error('Error in deleteNote:', error);
                alert('Error deleting note: ' + error.message);
            }
        }

        function initializeNotesManagement() {
            loadNotesClasses();
            loadExistingNotes();
        }

        // Notes form submission
        document.addEventListener('DOMContentLoaded', function() {
            const notesForm = document.getElementById('notesUploadForm');
            if (notesForm) {
                notesForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const classId = document.getElementById('notesClassId').value;
                    const title = document.getElementById('notesTitle').value.trim();
                    const description = document.getElementById('notesDescription').value.trim();
                    const googleDriveUrl = document.getElementById('notesGoogleDriveUrl').value.trim();

                    if (!classId || !title || !googleDriveUrl) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    // Validate Google Drive URL format - accept various Google Drive URL formats
                    console.log('Validating URL:', googleDriveUrl);
                    
                    const isValidGoogleDriveUrl = googleDriveUrl.includes('drive.google.com') || 
                                                 googleDriveUrl.includes('docs.google.com') ||
                                                 googleDriveUrl.includes('sheets.google.com') ||
                                                 googleDriveUrl.includes('slides.google.com');
                    
                    console.log('URL validation result:', isValidGoogleDriveUrl);
                    
                    if (!isValidGoogleDriveUrl) {
                        console.error('Invalid URL format detected:', googleDriveUrl);
                        alert('Please enter a valid Google Drive URL.\n\nAccepted formats:\n• drive.google.com/file/d/...\n• docs.google.com/document/d/...\n• sheets.google.com/spreadsheets/d/...\n• slides.google.com/presentation/d/...\n\nYour URL: ' + googleDriveUrl);
                        return;
                    }
                    
                    console.log('URL validation passed, proceeding with upload...');

                    try {
                        const { error } = await supabase
                            .from('class_notes')
                            .insert({
                                class_id: classId,
                                title: title,
                                description: description || null,
                                google_drive_url: googleDriveUrl,
                                created_by: null // Admin user - can be enhanced later
                            });

                        if (error) {
                            console.error('Error uploading notes:', error);
                            alert('Error uploading notes: ' + error.message);
                            return;
                        }

                        alert('Notes uploaded successfully!');
                        
                        // Reset form
                        notesForm.reset();
                        
                        // Refresh notes list
                        loadExistingNotes();
                        
                    } catch (error) {
                        console.error('Error in notes upload:', error);
                        alert('Error uploading notes: ' + error.message);
                    }
                });
            }
        });

        // Section initialization is now handled in the main showSection function

        // === MESSAGING FUNCTIONALITY ===
        
        let allStudents = [];
        let filteredStudents = [];
        let selectedStudents = [];
        let allClasses = []; // Add missing allClasses declaration

        async function initializeMessaging() {
            console.log('=== INITIALIZING MESSAGING ===');
            
            // Check if required DOM elements exist
            const tbody = document.getElementById('studentsTableBody');
            const countDisplay = document.getElementById('studentCountDisplay');
            const classFilter = document.getElementById('filterClass');
            const enrollmentFilter = document.getElementById('filterEnrollment');
            
            if (!tbody) {
                console.error('CRITICAL: studentsTableBody element not found!');
                throw new Error('Required DOM element studentsTableBody not found');
            }
            if (!countDisplay) {
                console.error('CRITICAL: studentCountDisplay element not found!');
                throw new Error('Required DOM element studentCountDisplay not found');
            }
            if (!classFilter) {
                console.error('CRITICAL: filterClass element not found!');
                throw new Error('Required DOM element filterClass not found');
            }
            if (!enrollmentFilter) {
                console.error('CRITICAL: filterEnrollment element not found!');
                throw new Error('Required DOM element filterEnrollment not found');
            }
            
            console.log('All required DOM elements found');
            
            // Update display immediately to show loading
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #007bff;">Loading students...</td></tr>';
            countDisplay.textContent = 'Loading students...';
            
            // Reset arrays
            allStudents = [];
            filteredStudents = [];
            selectedStudents = [];
            
            try {
                console.log('Step 1: Testing Supabase connection...');
                
                // Test Supabase connection first
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                console.log('Step 2: Loading students...');
                await loadAllStudents();
                console.log('Students loaded successfully:', allStudents.length);
                
                console.log('Step 3: Loading classes...');
                await loadClasses();
                console.log('Classes loaded successfully:', allClasses ? allClasses.length : 'allClasses is undefined');
                
                console.log('Step 4: Displaying students...');
                filteredStudents = [...allStudents];
                displayStudents(filteredStudents);
                
                console.log('=== MESSAGING INITIALIZATION COMPLETE ===');
                console.log('Total students:', allStudents.length);
                console.log('Sample student:', allStudents[0]);
                
            } catch (error) {
                console.error('=== INITIALIZATION ERROR ===');
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Supabase client exists:', !!supabase);
                console.error('allStudents array:', allStudents);
                console.error('allClasses array:', window.allClasses);
                
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #dc3545;">
                        Error loading students: ${error.message}<br>
                        <small>Check console for details</small>
                    </td></tr>`;
                }
            }
        }

        async function loadAllStudents() {
            try {
                console.log('Querying user_profiles table...');
                const { data: students, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('name');

                console.log('Supabase query result:', { data: students, error });

                if (error) {
                    console.error('Supabase error loading students:', error);
                    allStudents = [];
                    return;
                }

                allStudents = students || [];
                console.log(`Successfully loaded ${allStudents.length} students`);
                
                if (allStudents.length > 0) {
                    console.log('First student sample:', allStudents[0]);
                } else {
                    console.warn('No students found in database');
                }
                
                // Load enrollment data for each student
                console.log('Loading enrollment data...');
                await loadStudentEnrollments();
                console.log('Enrollment data loaded');
                
            } catch (error) {
                console.error('Exception in loadAllStudents:', error);
                allStudents = [];
                throw error; // Re-throw to let the caller handle it
            }
        }

        async function loadStudentEnrollments() {
            try {
                const { data: enrollments, error } = await supabase
                    .from('enrollments')
                    .select(`
                        user_id,
                        class_id,
                        status,
                        classes (
                            id,
                            name
                        )
                    `);
                    // Load ALL enrollments first for debugging, then we can filter if needed

                if (error) {
                    console.error('Error loading enrollments:', error);
                    return;
                }

                // Add enrollment data to students
                allStudents.forEach(student => {
                    const allEnrollments = enrollments.filter(e => e.user_id === student.user_id) || [];
                    // For display purposes, show only approved enrollments in the "All Classes" column
                    const approvedEnrollments = allEnrollments.filter(e => e.status === 'approved');
                    
                    // For filtering purposes, use all enrollments (approved, pending, etc.)
                    student.enrollments = allEnrollments;
                    student.enrolledClasses = approvedEnrollments.map(e => e.classes?.name).join(', ') || 'None';
                });

                console.log('Enrollments summary:', {
                    total_enrollments: enrollments.length,
                    enrollment_statuses: [...new Set(enrollments.map(e => e.status))],
                    classes_in_enrollments: [...new Set(enrollments.map(e => e.classes?.name).filter(Boolean))]
                });

                console.log('Students with enrollments loaded:', allStudents.map(s => ({
                    name: s.name,
                    user_id: s.user_id,
                    total_enrollments: s.enrollments.length,
                    approved_classes: s.enrolledClasses,
                    all_enrollments: s.enrollments.map(e => ({ class: e.classes?.name, status: e.status, class_id: e.class_id }))
                })));

            } catch (error) {
                console.error('Error in loadStudentEnrollments:', error);
            }
        }

        async function loadClasses() {
            try {
                const { data: classes, error } = await supabase
                    .from('classes')
                    .select('*')
                    .eq('is_active', true)
                    .order('name');

                if (error) {
                    console.error('Error loading classes:', error);
                    allClasses = []; // Set empty array on error
                    return;
                }

                // Store classes in the allClasses array for use in filtering
                allClasses = classes || [];
                console.log('Classes stored in allClasses:', allClasses.length);

                const classSelect = document.getElementById('filterClass');
                classSelect.innerHTML = '<option value="">All Classes</option>';
                
                classes.forEach(cls => {
                    classSelect.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
                });

                // Add event listeners for auto-apply filters
                classSelect.addEventListener('change', function() {
                    // Clear enrollment filter when class changes
                    if (!this.value) {
                        document.getElementById('filterEnrollment').value = '';
                    }
                    applyStudentFilters();
                });

                document.getElementById('filterEnrollment').addEventListener('change', function() {
                    const classFilter = document.getElementById('filterClass').value;
                    if (this.value && !classFilter) {
                        alert('Please select a class first before filtering by enrollment status.');
                        this.value = '';
                        return;
                    }
                    applyStudentFilters();
                });

                console.log('Classes loaded for filtering:', classes.map(c => ({ id: c.id, name: c.name })));

            } catch (error) {
                console.error('Error in loadClasses:', error);
            }
        }

        function displayStudents(students) {
            console.log('=== DISPLAY STUDENTS CALLED ===');
            console.log('Students to display:', students.length);
            console.log('Sample student:', students[0]);
            
            const tbody = document.getElementById('studentsTableBody');
            const countDisplay = document.getElementById('studentCountDisplay');
            const classFilter = document.getElementById('filterClass').value;
            
            if (!tbody) {
                console.error('ERROR: studentsTableBody element not found!');
                return;
            }
            
            if (!countDisplay) {
                console.error('ERROR: studentCountDisplay element not found!');
                return;
            }
            
            countDisplay.textContent = `Total: ${students.length} students | Selected: ${selectedStudents.length} students`;
            console.log('Updated count display');

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #666;">No students found matching the filters</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => {
                const isSelected = selectedStudents.some(s => s.id === student.id);
                const statusColor = student.status === 'approved' ? '#28a745' : 
                                  student.status === 'pending' ? '#ffc107' : '#dc3545';
                
                // Show enrollment status
                let enrollmentDisplay = 'N/A';
                let enrollmentColor = '#6c757d';
                let allClassesDisplay = 'None';
                
                if (classFilter) {
                    // Show status for selected class
                    const classId = parseInt(classFilter);
                    const classEnrollments = student.enrollments?.filter(e => e.class_id === classId) || [];
                    const approvedEnrollment = classEnrollments.find(e => e.status === 'approved');
                    const pendingEnrollment = classEnrollments.find(e => e.status === 'pending');
                    
                    if (approvedEnrollment) {
                        enrollmentDisplay = '✅ Enrolled';
                        enrollmentColor = '#28a745';
                    } else if (pendingEnrollment) {
                        enrollmentDisplay = '⏳ Pending';
                        enrollmentColor = '#ffc107';
                    } else {
                        enrollmentDisplay = '❌ Not Enrolled';
                        enrollmentColor = '#dc3545';
                    }
                    
                    // Show the selected class name
                    const selectedClassName = allClasses.find(c => c.id === classId)?.class_name || 'Selected Class';
                    allClassesDisplay = enrollmentDisplay === '❌ Not Enrolled' ? 'None' : selectedClassName;
                } else {
                    // Show all enrolled classes
                    const approvedEnrollments = student.enrollments?.filter(e => e.status === 'approved') || [];
                    
                    if (approvedEnrollments.length > 0) {
                        enrollmentDisplay = `✅ ${approvedEnrollments.length} classes`;
                        enrollmentColor = '#28a745';
                        
                        let classNames = [];
                        approvedEnrollments.forEach(enrollment => {
                            const className = allClasses.find(c => c.id === enrollment.class_id)?.class_name || `Class ${enrollment.class_id}`;
                            classNames.push(className);
                        });
                        allClassesDisplay = classNames.join(', ');
                    } else {
                        enrollmentDisplay = '❌ No enrollments';
                        enrollmentColor = '#dc3545';
                        allClassesDisplay = 'None';
                    }
                }
                
                return `
                    <tr style="cursor: pointer;" onclick="toggleStudentSelection('${student.id}', event)">
                        <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleStudentSelection('${student.id}', event)"
                                   onclick="event.stopPropagation();">
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e1e8ed; font-weight: 500;">
                            ${student.name || 'N/A'}
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">
                            ${student.mobile || 'N/A'}
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">
                            <span style="background: #f8f9fa; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                ${student.batch || 'N/A'}
                            </span>
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">
                            <span style="color: ${statusColor}; font-weight: 500; text-transform: capitalize;">
                                ${student.status || 'pending'}
                            </span>
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e1e8ed; font-size: 11px; line-height: 1.4;">
                            ${allClassesDisplay}
                        </td>
                    </tr>
                `;
            }).join('');

            updateSelectedStudentsDisplay();
        }

        function toggleStudentSelection(studentId, event) {
            if (event) event.stopPropagation();
            
            const student = filteredStudents.find(s => s.id === studentId);
            if (!student) return;

            const existingIndex = selectedStudents.findIndex(s => s.id === studentId);
            
            if (existingIndex >= 0) {
                selectedStudents.splice(existingIndex, 1);
            } else {
                selectedStudents.push(student);
            }

            displayStudents(filteredStudents);
            updateSelectAllCheckbox();
        }

        function toggleAllStudents(checkbox) {
            if (checkbox.checked) {
                // Select all filtered students
                filteredStudents.forEach(student => {
                    if (!selectedStudents.some(s => s.id === student.id)) {
                        selectedStudents.push(student);
                    }
                });
            } else {
                // Deselect all filtered students
                filteredStudents.forEach(student => {
                    const index = selectedStudents.findIndex(s => s.id === student.id);
                    if (index >= 0) {
                        selectedStudents.splice(index, 1);
                    }
                });
            }
            
            displayStudents(filteredStudents);
        }

        function updateSelectAllCheckbox() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const filteredSelectedCount = filteredStudents.filter(student => 
                selectedStudents.some(s => s.id === student.id)
            ).length;
            
            checkbox.checked = filteredSelectedCount === filteredStudents.length && filteredStudents.length > 0;
            checkbox.indeterminate = filteredSelectedCount > 0 && filteredSelectedCount < filteredStudents.length;
        }

        function selectAllStudents() {
            filteredStudents.forEach(student => {
                if (!selectedStudents.some(s => s.id === student.id)) {
                    selectedStudents.push(student);
                }
            });
            displayStudents(filteredStudents);
            updateSelectAllCheckbox();
        }

        function deselectAllStudents() {
            filteredStudents.forEach(student => {
                const index = selectedStudents.findIndex(s => s.id === student.id);
                if (index >= 0) {
                    selectedStudents.splice(index, 1);
                }
            });
            displayStudents(filteredStudents);
            updateSelectAllCheckbox();
        }

        function updateSelectedStudentsDisplay() {
            const display = document.getElementById('selectedStudentsDisplay');
            
            if (selectedStudents.length === 0) {
                display.innerHTML = '<span style="color: #666;">No students selected</span>';
                return;
            }

            const names = selectedStudents.map(s => s.name).slice(0, 5);
            let displayText = names.join(', ');
            
            if (selectedStudents.length > 5) {
                displayText += ` and ${selectedStudents.length - 5} more`;
            }
            
            display.innerHTML = `
                <strong>${selectedStudents.length} students selected:</strong><br>
                ${displayText}
            `;
        }

        function applyStudentFilters() {
            console.log('=== APPLYING FILTERS ===');
            const classFilter = document.getElementById('filterClass').value;
            const enrollmentFilter = document.getElementById('filterEnrollment').value;
            
            console.log('Filter values:', { classFilter, enrollmentFilter });
            console.log('Total students before filter:', allStudents.length);
            
            // Start with all students
            filteredStudents = allStudents.filter(student => {
                console.log(`Checking student: ${student.name}`);
                console.log('Student enrollments:', student.enrollments);
                
                // If enrollment filter is set but no class selected, require class first
                if (enrollmentFilter && !classFilter) {
                    console.log('Enrollment filter requires class selection - skipping filter');
                    return true;
                }
                
                // If class is selected, filter by enrollment in that class
                if (classFilter && enrollmentFilter) {
                    console.log(`Filtering by class ${classFilter} and enrollment ${enrollmentFilter}`);
                    
                    // Convert classFilter to string for comparison (UUIDs are strings)
                    const targetClassId = classFilter;
                    console.log('Looking for class ID:', targetClassId);
                    
                    // Check if student has any enrollment for this class
                    const classEnrollments = student.enrollments?.filter(e => {
                        console.log(`Comparing enrollment class_id ${e.class_id} with target ${targetClassId}`);
                        return e.class_id === targetClassId;
                    }) || [];
                    
                    console.log('Found class enrollments:', classEnrollments.length);
                    
                    // Check for approved enrollment
                    const hasApprovedEnrollment = classEnrollments.some(e => e.status === 'approved');
                    console.log('Has approved enrollment:', hasApprovedEnrollment);
                    
                    if (enrollmentFilter === 'enrolled') {
                        const result = hasApprovedEnrollment;
                        console.log(`Filter result for ${student.name}: ${result}`);
                        return result;
                    }
                    
                    if (enrollmentFilter === 'not-enrolled') {
                        const result = !hasApprovedEnrollment;
                        console.log(`Filter result for ${student.name}: ${result}`);
                        return result;
                    }
                }
                
                // No filters applied, show all
                console.log(`No specific filters, including ${student.name}`);
                return true;
            });

            console.log(`Filtered students: ${filteredStudents.length}`);
            console.log('Filtered student names:', filteredStudents.map(s => s.name));
            
            displayStudents(filteredStudents);
        }

        function clearStudentFilters() {
            document.getElementById('filterEnrollment').value = '';
            document.getElementById('filterClass').value = '';
            
            filteredStudents = [...allStudents];
            displayStudents(filteredStudents);
            updateSelectAllCheckbox();
            
            console.log('Filters cleared');
        }

        function debugEnrollmentData() {
            console.log('=== DEBUGGING ENROLLMENT DATA ===');
            console.log('Total students:', allStudents.length);
            console.log('Students with enrollments:', allStudents.filter(s => s.enrollments && s.enrollments.length > 0).length);
            
            // Check form elements
            console.log('=== FORM ELEMENTS CHECK ===');
            const elements = ['filterName', 'filterBatch', 'filterStatus', 'filterClass', 'filterEnrollment'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? 'EXISTS' : 'MISSING', element ? `value="${element.value}"` : '');
            });
            
            // Check for specific class
            const classFilter = document.getElementById('filterClass').value;
            if (classFilter) {
                console.log('=== CLASS-SPECIFIC ANALYSIS ===');
                console.log('Selected class ID:', classFilter, 'type:', typeof classFilter);
                
                const studentsWithAnyEnrollment = allStudents.filter(s => 
                    s.enrollments?.some(e => e.class_id === parseInt(classFilter))
                );
                const studentsWithApprovedEnrollment = allStudents.filter(s => 
                    s.enrollments?.some(e => e.class_id === parseInt(classFilter) && e.status === 'approved')
                );
                
                console.log('Students with ANY enrollment in selected class:', studentsWithAnyEnrollment.length);
                console.log('Students with APPROVED enrollment in selected class:', studentsWithApprovedEnrollment.length);
                
                console.log('Students with any enrollment details:', studentsWithAnyEnrollment.map(s => ({
                    name: s.name,
                    enrollments: s.enrollments.filter(e => e.class_id === parseInt(classFilter))
                })));
            }
            
            // Show all unique class IDs and names
            const allEnrollmentClassIds = [];
            const allEnrollmentClassNames = [];
            allStudents.forEach(s => {
                s.enrollments?.forEach(e => {
                    if (!allEnrollmentClassIds.includes(e.class_id)) {
                        allEnrollmentClassIds.push(e.class_id);
                        allEnrollmentClassNames.push({ id: e.class_id, name: e.classes?.name, status: e.status });
                    }
                });
            });
            
            console.log('=== ALL ENROLLMENT CLASS DATA ===');
            console.log('All class IDs in enrollments:', allEnrollmentClassIds);
            console.log('All class details in enrollments:', allEnrollmentClassNames);
            
            // Show sample data
            console.log('=== SAMPLE STUDENT DATA ===');
            console.log('Sample student data:', allStudents.slice(0, 3).map(s => ({
                name: s.name,
                id: s.id,
                user_id: s.user_id,
                status: s.status,
                batch: s.batch,
                enrollments: s.enrollments
            })));
            
            alert('Debug data logged to console. Open developer tools (F12) to view details.');
        }



        function previewMessages() {
            const message = document.getElementById('messageText').value.trim();
            
            if (!message) {
                alert('Please enter a message first!');
                return;
            }

            if (selectedStudents.length === 0) {
                alert('Please select at least one student!');
                return;
            }

            const studentsWithoutMobile = selectedStudents.filter(s => !s.mobile);
            
            let previewText = `📱 WhatsApp Message Preview\n\n`;
            previewText += `Message: "${message}"\n\n`;
            previewText += `Recipients (${selectedStudents.length}):\n`;
            
            selectedStudents.forEach((student, index) => {
                const mobile = student.mobile || 'No mobile number';
                previewText += `${index + 1}. ${student.name} - ${mobile}\n`;
            });

            if (studentsWithoutMobile.length > 0) {
                previewText += `\n⚠️ Warning: ${studentsWithoutMobile.length} student(s) don't have mobile numbers:\n`;
                studentsWithoutMobile.forEach(s => previewText += `- ${s.name}\n`);
            }

            alert(previewText);
        }

        function sendBulkWhatsAppMessages() {
            const message = document.getElementById('messageText').value.trim();
            
            if (!message) {
                alert('Please enter a message first!');
                return;
            }

            if (selectedStudents.length === 0) {
                alert('Please select at least one student!');
                return;
            }

            const studentsWithMobile = selectedStudents.filter(s => s.mobile);
            const studentsWithoutMobile = selectedStudents.filter(s => !s.mobile);

            if (studentsWithMobile.length === 0) {
                alert('None of the selected students have mobile numbers!');
                return;
            }

            let confirmText = `Send WhatsApp messages to ${studentsWithMobile.length} students?\n\n`;
            confirmText += `Message: "${message}"\n\n`;
            
            if (studentsWithoutMobile.length > 0) {
                confirmText += `⚠️ ${studentsWithoutMobile.length} student(s) will be skipped (no mobile number)\n\n`;
            }
            
            confirmText += `This will open ${studentsWithMobile.length} new browser tabs/windows.`;

            if (!confirm(confirmText)) {
                return;
            }

            const status = document.getElementById('sendingStatus');
            status.textContent = 'Opening WhatsApp conversations...';
            status.style.color = '#007bff';

            let successCount = 0;
            let errorCount = 0;

            studentsWithMobile.forEach((student, index) => {
                setTimeout(() => {
                    try {
                        const cleanMobile = student.mobile.replace(/\D/g, '');
                        let whatsappNumber = cleanMobile;
                        
                        // Add country code if not present (assuming Sri Lanka +94)
                        if (!whatsappNumber.startsWith('94') && whatsappNumber.startsWith('0')) {
                            whatsappNumber = '94' + whatsappNumber.substring(1);
                        }
                        
                        const encodedMessage = encodeURIComponent(message);
                        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
                        
                        window.open(whatsappUrl, '_blank');
                        successCount++;
                        
                        // Update status
                        status.textContent = `Opened ${successCount}/${studentsWithMobile.length} WhatsApp conversations`;
                        
                        if (successCount === studentsWithMobile.length) {
                            setTimeout(() => {
                                status.textContent = `✅ Successfully opened ${successCount} WhatsApp conversations!`;
                                status.style.color = '#28a745';
                                
                                setTimeout(() => {
                                    status.textContent = '';
                                }, 5000);
                            }, 1000);
                        }
                        
                    } catch (error) {
                        errorCount++;
                        console.error(`Error opening WhatsApp for ${student.name}:`, error);
                    }
                }, index * 500); // 500ms delay between each window opening
            });
        }

        // Device Management Functions
        let allDeviceRequests = [];
        let allApprovedDevices = [];

        async function loadDeviceRequests() {
            try {
                console.log('Loading device access requests...');

                // First get the device requests
                const { data: requests, error: requestError } = await supabase
                    .from('device_access_requests')
                    .select('*')
                    .order('requested_at', { ascending: false });

                if (requestError) {
                    console.error('Error loading device requests:', requestError);
                    displayNoDeviceRequests('Error loading device requests: ' + requestError.message);
                    return;
                }

                // Get user profiles for these users
                const userIds = [...new Set(requests.map(r => r.user_id).filter(Boolean))];
                
                let userProfiles = [];
                if (userIds.length > 0) {
                    const { data: profiles, error: profileError } = await supabase
                        .from('user_profiles')
                        .select('user_id, name, email')
                        .in('user_id', userIds);

                    if (profileError) {
                        console.error('Error loading user profiles:', profileError);
                    } else {
                        userProfiles = profiles || [];
                    }
                }

                // Combine the data
                const requestsWithProfiles = requests.map(request => {
                    const profile = userProfiles.find(p => p.user_id === request.user_id);
                    return {
                        ...request,
                        user_profiles: profile || { name: 'Unknown User', email: '' }
                    };
                });

                allDeviceRequests = requestsWithProfiles;
                console.log('Device requests loaded:', allDeviceRequests.length);

                // Get filter value, but handle case where element doesn't exist yet
                const filterElement = document.getElementById('deviceRequestStatusFilter');
                const filter = filterElement ? filterElement.value : '';
                console.log('Applying filter:', filter);
                
                const filteredRequests = filterDeviceRequestsByStatus(filter);
                console.log('Filtered requests:', filteredRequests.length);
                
                displayDeviceRequests(filteredRequests);

            } catch (error) {
                console.error('Error connecting to database:', error);
                displayNoDeviceRequests('Error connecting to database: ' + error.message);
            }
        }

        function displayDeviceRequests(requests) {
            const tbody = document.getElementById('deviceRequestsTableBody');
            if (!tbody) {
                console.error('deviceRequestsTableBody element not found');
                return;
            }
            
            tbody.innerHTML = '';
            console.log('Displaying device requests:', requests.length);

            if (requests.length === 0) {
                displayNoDeviceRequests('No device access requests found.');
                return;
            }

            requests.forEach(request => {
                const requestDate = new Date(request.requested_at).toLocaleDateString();
                const deviceInfo = request.device_info;
                const statusBadge = getStatusBadge(request.status);
                
                let actionButtons = '';
                if (request.status === 'pending') {
                    actionButtons = `
                        <button onclick="approveDeviceRequest('${request.id}')" 
                                style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer;">
                            ✅ Approve
                        </button>
                        <button onclick="showRejectDeviceModal('${request.id}')" 
                                style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                            ❌ Reject
                        </button>
                    `;
                } else {
                    const actionDate = request.status === 'approved' ? 
                        new Date(request.approved_at).toLocaleDateString() :
                        new Date(request.rejected_at).toLocaleDateString();
                    actionButtons = `<small style="color: #666;">Processed on ${actionDate}</small>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <strong>${request.user_profiles?.name || 'Unknown User'}</strong><br>
                        <small style="color: #666;">${request.user_profiles?.email || ''}</small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; font-size: 12px;">
                        <strong>${deviceInfo.name || 'Unknown Device'}</strong><br>
                        <small style="color: #666;">
                            ${deviceInfo.type} | ${deviceInfo.platform}<br>
                            ${deviceInfo.resolution} | ${deviceInfo.language}
                        </small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; max-width: 200px;">
                        <small style="color: #666; font-style: italic;">
                            ${request.user_justification || 'No justification provided'}
                        </small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <small>${requestDate}</small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        ${statusBadge}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayNoDeviceRequests(message) {
            const tbody = document.getElementById('deviceRequestsTableBody');
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">${message}</td></tr>`;
        }

        function filterDeviceRequestsByStatus(status) {
            if (!status) {
                return allDeviceRequests;
            }
            return allDeviceRequests.filter(request => request.status === status);
        }

        function onDeviceRequestStatusFilterChange() {
            const filterElement = document.getElementById('deviceRequestStatusFilter');
            if (!filterElement) {
                console.error('deviceRequestStatusFilter element not found');
                return;
            }
            
            const status = filterElement.value;
            console.log('Filter changed to:', status);
            
            const filteredRequests = filterDeviceRequestsByStatus(status);
            console.log('Filtered requests count:', filteredRequests.length);
            
            displayDeviceRequests(filteredRequests);
        }

        async function approveDeviceRequest(requestId) {
            try {
                // Get the request details first
                const request = allDeviceRequests.find(r => r.id === requestId);
                if (!request) {
                    alert('Request not found');
                    return;
                }

                // Update the request status
                const { error: updateError } = await supabase
                    .from('device_access_requests')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: 'admin' // You might want to track which admin approved
                    })
                    .eq('id', requestId);

                if (updateError) throw updateError;

                // Create approved device record
                const { error: deviceError } = await supabase
                    .from('approved_devices')
                    .insert({
                        user_id: request.user_id,
                        device_fingerprint: request.device_fingerprint,
                        device_name: `${request.device_info.name} (Approved)`,
                        device_info: request.device_info,
                        approved_by: 'admin'
                    });

                if (deviceError) throw deviceError;

                alert('✅ Device request approved successfully!');
                loadDeviceRequests();
                loadApprovedDevices();

            } catch (error) {
                console.error('Error approving device request:', error);
                alert('Error approving device request: ' + error.message);
            }
        }

        function showRejectDeviceModal(requestId) {
            const reason = prompt('Reason for rejection (optional):');
            if (reason !== null) { // User didn't cancel
                rejectDeviceRequest(requestId, reason);
            }
        }

        async function rejectDeviceRequest(requestId, reason) {
            try {
                const { error } = await supabase
                    .from('device_access_requests')
                    .update({
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejection_reason: reason || 'No reason provided'
                    })
                    .eq('id', requestId);

                if (error) throw error;

                alert('❌ Device request rejected.');
                loadDeviceRequests();

            } catch (error) {
                console.error('Error rejecting device request:', error);
                alert('Error rejecting device request: ' + error.message);
            }
        }

        async function loadApprovedDevices() {
            try {
                console.log('Loading approved devices...');

                // First get the approved devices
                const { data: devices, error: deviceError } = await supabase
                    .from('approved_devices')
                    .select('*')
                    .eq('is_active', true)
                    .order('first_seen', { ascending: false });

                if (deviceError) {
                    console.error('Error loading approved devices:', deviceError);
                    displayNoApprovedDevices('Error loading approved devices: ' + deviceError.message);
                    return;
                }

                // Get user profiles for these users
                const userIds = [...new Set(devices.map(d => d.user_id).filter(Boolean))];
                
                let userProfiles = [];
                if (userIds.length > 0) {
                    const { data: profiles, error: profileError } = await supabase
                        .from('user_profiles')
                        .select('user_id, name, email')
                        .in('user_id', userIds);

                    if (profileError) {
                        console.error('Error loading user profiles:', profileError);
                    } else {
                        userProfiles = profiles || [];
                    }
                }

                // Combine the data
                const devicesWithProfiles = devices.map(device => {
                    const profile = userProfiles.find(p => p.user_id === device.user_id);
                    return {
                        ...device,
                        user_profiles: profile || { name: 'Unknown User', email: '' }
                    };
                });

                allApprovedDevices = devicesWithProfiles;
                console.log('Approved devices loaded:', allApprovedDevices.length);

                displayApprovedDevices(allApprovedDevices);

            } catch (error) {
                console.error('Error connecting to database:', error);
                displayNoApprovedDevices('Error connecting to database: ' + error.message);
            }
        }

        function displayApprovedDevices(devices) {
            const tbody = document.getElementById('approvedDevicesTableBody');
            tbody.innerHTML = '';

            if (devices.length === 0) {
                displayNoApprovedDevices('No approved devices found.');
                return;
            }

            devices.forEach(device => {
                const firstSeenDate = new Date(device.first_seen).toLocaleDateString();
                const lastSeenDate = new Date(device.last_seen).toLocaleDateString();
                const deviceInfo = device.device_info;
                const autoApprovedBadge = device.auto_approved ? 
                    '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">AUTO</span>' :
                    '<span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">MANUAL</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <strong>${device.user_profiles?.name || 'Unknown User'}</strong><br>
                        <small style="color: #666;">${device.user_profiles?.email || ''}</small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <strong>${device.device_name || 'Unnamed Device'}</strong>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${deviceInfo.type || 'Unknown'}
                        </span>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; font-size: 12px;">
                        ${deviceInfo.platform || 'Unknown'}<br>
                        <small style="color: #666;">${deviceInfo.resolution || ''}</small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <small>${firstSeenDate}</small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <small>${lastSeenDate}</small>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                        ${autoApprovedBadge}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <button onclick="revokeDeviceAccess('${device.id}')" 
                                style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            🚫 Revoke
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayNoApprovedDevices(message) {
            const tbody = document.getElementById('approvedDevicesTableBody');
            tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">${message}</td></tr>`;
        }

        function filterApprovedDevices() {
            const searchTerm = document.getElementById('deviceUserFilter').value.toLowerCase();
            const filteredDevices = allApprovedDevices.filter(device => 
                (device.user_profiles?.name || '').toLowerCase().includes(searchTerm) ||
                (device.user_profiles?.email || '').toLowerCase().includes(searchTerm) ||
                (device.device_name || '').toLowerCase().includes(searchTerm)
            );
            displayApprovedDevices(filteredDevices);
        }

        async function revokeDeviceAccess(deviceId) {
            if (!confirm('Are you sure you want to revoke access for this device? The user will need to request approval again.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('approved_devices')
                    .update({ is_active: false })
                    .eq('id', deviceId);

                if (error) throw error;

                alert('🚫 Device access revoked successfully!');
                loadApprovedDevices();

            } catch (error) {
                console.error('Error revoking device access:', error);
                alert('Error revoking device access: ' + error.message);
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span style="background: #ffa500; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">⏳ Pending</span>',
                'approved': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">✅ Approved</span>',
                'rejected': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">❌ Rejected</span>'
            };
            return badges[status] || status;
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="v2.8.5-20250626-ELECTRON">
    <title>Student Portal - Netaji Yasara Silva (Desktop)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            height: 100%;
            width: 100%;
        }

        .container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
        }

        /* Login/Register Forms */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .auth-header h2 {
            color: #667eea; 
            margin-bottom: 5px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #333333;
            color: white;
        }

        .auth-tab:first-child {
            border-radius: 8px 0 0 8px;
        }

        .auth-tab:last-child {
            border-radius: 0 8px 8px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #333333;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #333333;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #555555;
        }

        .admin-login-link {
            text-align: center;
            margin-top: 20px;
        }

        .admin-login-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .admin-login-link a:hover {
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.active {
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h2 {
            color: #667eea;
            font-size: 24px;
        }

        .logo p {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .user-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: block;
            padding: 15px 20px;
            color: #555;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background: #333333;
            color: white;
        }

        .logout-btn {
            margin-top: 30px;
            background: #666666;
        }

        .logout-btn:hover {
            background: #888888;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: #f5f5f5;
            overflow: auto;
            height: 100%;
            position: relative;
        }

        .content-header {
            margin-bottom: 30px;
        }

        /* Notes Viewer Modal */
        .notes-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            overflow: auto;
        }

        .notes-viewer-content {
            position: relative;
            margin: 2% auto;
            width: 95%;
            height: 90%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .notes-viewer-header {
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-viewer-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .notes-viewer-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .notes-viewer-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notes-viewer-iframe {
            width: 100%;
            height: calc(100% - 70px);
            border: none;
            border-radius: 0 0 8px 8px;
        }

        @media (max-width: 768px) {
            .notes-viewer-content {
                width: 98%;
                height: 95%;
                margin: 1% auto;
            }
        }

        .content-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .content-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .profile-form .form-group:last-child {
            grid-column: 1 / -1;
        }

        .hidden {
            display: none;
        }

        .coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .coming-soon h2 {
            margin-bottom: 10px;
        }

        /* Secure Video Player Modal */
        .video-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        .video-modal-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 1200px;
            height: 80%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .video-header {
            background: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
        }

        .video-title {
            font-size: 18px;
            font-weight: bold;
        }

        .video-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .video-close:hover {
            background: #555;
        }

        .video-container {
            width: 100%;
            height: calc(100% - 60px);
            position: relative;
            background: #000;
        }

        .video-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
            pointer-events: auto;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 5;
            pointer-events: none;
        }

        /* Disable text selection in video modal */
        .video-modal * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Disable right-click context menu */
        .video-modal {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }

        .video-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-size: 16px;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .video-modal-content {
                margin: 2% auto;
                width: 95%;
                height: 90%;
            }
            
            .video-header {
                padding: 10px 15px;
            }
            
            .video-title {
                font-size: 16px;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100% !important;
                height: auto !important;
                position: relative;
                padding: 10px 0 !important;
            }
            
            .main-content {
                height: calc(100% - 250px);
                overflow: auto;
            }
            
            .profile-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authSection" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1>Student Portal</h1>
                <h2>Attorney's At Law Classes - Netaji Yasara Silva</h2>
                <p>Welcome to the learning platform</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showLogin()">Login</button>
                <button class="auth-tab" onclick="showRegister()">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn">Login</button>
                
                <!-- Password Reset Link -->
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showPasswordReset()" style="color: #007bff; text-decoration: none; font-size: 14px;">
                        Forgot your password?
                    </a>
                </div>
                
                <!-- Debug Login for Testing -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;">
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Having trouble logging in? Try using a test account:</p>
                    <button type="button" class="btn" style="background: #666666; font-size: 12px; padding: 5px 10px;" 
                            onclick="document.getElementById('loginEmail').value='test@example.com'; document.getElementById('loginPassword').value='password123';">
                        Use Test Account
                    </button>
                </div>
            </form>

            <!-- Registration Form -->
            <form id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerNIC">NIC Number</label>
                    <input type="text" id="registerNIC" required>
                </div>
                <div class="form-group">
                    <label for="registerMobile">Mobile Number</label>
                    <input type="tel" id="registerMobile" required>
                </div>
                <div class="form-group">
                    <label for="registerBatch">Batch</label>
                    <select id="registerBatch" required>
                        <option value="">Select Batch</option>
                        <option value="Current Batch">Current Batch</option>
                        <option value="April'25 Batch">April'25 Batch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="btn">Register</button>
            </form>

            <!-- Password Reset Request Form -->
            <form id="passwordResetForm" class="hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 10px;">Request Password Reset</h3>
                    <p style="color: #666; font-size: 14px;">Submit a password reset request to the administrator for approval.</p>
                </div>
                
                <div class="form-group">
                    <label for="resetEmail">Email Address</label>
                    <input type="email" id="resetEmail" required placeholder="Enter your registered email">
                </div>

                <div class="form-group">
                    <label for="resetNIC">NIC Number</label>
                    <input type="text" id="resetNIC" required placeholder="Enter your NIC for verification">
                </div>

                <div class="form-group">
                    <label for="resetName">Full Name</label>
                    <input type="text" id="resetName" required placeholder="Enter your full name">
                </div>

                <div class="form-group">
                    <label for="resetReason">Reason for Password Reset</label>
                    <textarea id="resetReason" rows="3" placeholder="Please explain why you need a password reset (e.g., forgot password, account locked, etc.)" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                
                <button type="submit" class="btn">Submit Reset Request</button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showLogin()" style="color: #007bff; text-decoration: none; font-size: 14px;">
                        ‚Üê Back to Login
                    </a>
                </div>

                <!-- Status Check Section -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;">
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Check your reset request status:</p>
                    <button type="button" class="btn" style="background: #666666; font-size: 12px; padding: 5px 10px;" onclick="checkResetStatus()">
                        Check Request Status
                    </button>
                </div>
            </form>

            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e8ed;">
                <p style="color: #666; margin-bottom: 10px; font-size: 14px;">Are you an administrator?</p>
                <a href="47gwy2ga4a.html" style="color: #667eea; text-decoration: none; font-weight: 500;">
                    üîê Go to Admin Portal
                </a>
                <br><br>
                <a href="index.html" style="color: #999; text-decoration: none; font-size: 14px;">
                    ‚Üê Back to Portal Selector
                </a>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; overflow: hidden;">
        <aside class="sidebar" style="width: 250px; height: 100%; overflow-y: auto; background: #f5f5f5; border-right: 1px solid #e1e8ed; padding: 20px 0;">
            <div class="logo">
                <h2>Student Portal</h2>
                <p>Attorney's At Law Classes - Netaji Yasara Silva</p>
            </div>

            <div class="user-info">
                <h3 id="userName">Student Name</h3>
                <p id="userEmail">student@example.com</p>
                <p id="userRole">Student</p>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="showSection('profile')">
                            üìù Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('enrollment')">
                            üìö Class Enrollment
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('recordings')">
                            üé• Recordings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('notes')">
                            üìö Notes
                        </a>
                    </li>
                </ul>
            </nav>

            <button class="btn logout-btn" onclick="logout()" id="logoutButton">Logout</button>
            <div style="text-align: center; margin-top: 20px; padding: 10px; font-size: 10px; color: #999;">
                Version: 2.5.1-20250618-0950
            </div>
        </aside>

        <main class="main-content">
            <!-- Profile Section -->
            <div id="profileSection" class="content-section">
                <div class="content-header">
                    <h1>Profile Information</h1>
                    <p>View and update your personal information</p>
                </div>

                <form class="profile-form">
                    <div class="form-group">
                        <label for="profileName">Full Name</label>
                        <input type="text" id="profileName">
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email</label>
                        <input type="email" id="profileEmail">
                    </div>
                    <div class="form-group">
                        <label for="profileNIC">NIC Number</label>
                        <input type="text" id="profileNIC">
                    </div>
                    <div class="form-group">
                        <label for="profileMobile">Mobile Number</label>
                        <input type="tel" id="profileMobile">
                    </div>
                    <div class="form-group">
                        <label for="profileBatch">Batch</label>
                        <select id="profileBatch">
                            <option value="Current Batch">Current Batch</option>
                            <option value="April'25 Batch">April'25 Batch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn" onclick="updateProfile()">Update Profile</button>
                    </div>
                </form>
            </div>

            <!-- Class Enrollment Section -->
            <div id="enrollmentSection" class="content-section hidden">
                <div class="content-header">
                    <h1>Class Enrollment</h1>
                    <p>Enroll in available classes</p>
                </div>

                <!-- Available Classes -->
                <div style="margin-bottom: 30px;">
                    <h3>Available Classes</h3>
                    <button class="btn" onclick="loadAvailableClasses()" style="width: auto; margin: 10px 0;">Refresh Classes</button>
                    
                    <form id="enrollmentForm">
                        <div id="availableClasses" style="margin-bottom: 20px;">
                            <p>Click refresh to load available classes</p>
                        </div>

                        <div class="form-group" id="paymentProofSection" style="display: none;">
                            <label for="paymentProof">Payment Proof (Image or PDF) *</label>
                            <input type="file" id="paymentProof" accept="image/*,application/pdf" required>
                            <small style="color: #666;">Upload your payment receipt or bank transfer proof</small>
                        </div>

                        <button type="submit" class="btn" id="enrollBtn" style="display: none;">Submit Enrollment Request</button>
                    </form>
                </div>

                <!-- My Enrollments -->
                <div>
                    <h3>My Enrollments</h3>
                    <button class="btn" onclick="loadMyEnrollments()" style="width: auto; margin: 10px 0;">Refresh</button>
                    
                    <div style="overflow: auto; border: 1px solid #ddd; border-radius: 8px; max-height: 300px; width: 100%;">
                        <div style="width: 100%; overflow-x: auto; min-height: 100px;">
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0; min-width: 600px;">
                                <thead style="background: #f5f5f5; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="padding: 12px; border: 1px solid #dee2e6;">Class Name</th>
                                        <th style="padding: 12px; border: 1px solid #dee2e6;">Status</th>
                                        <th style="padding: 12px; border: 1px solid #dee2e6;">Enrollment Date</th>
                                    </tr>
                                </thead>
                                <tbody id="myEnrollmentsBody">
                                    <tr>
                                        <td colspan="4" style="padding: 20px; text-align: center;">Click refresh to load your enrollments</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recordings Section -->
            <div id="recordingsSection" class="content-section hidden">
                <div class="content-header">
                    <h1>Recordings</h1>
                    <p>Request access to class recordings and view your approved recordings</p>
                </div>

                <!-- Request Recording Access -->
                <div style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #333333;">
                    <h3>üìπ Request Recording Access</h3>
                    <p style="color: #666; margin-bottom: 15px;">Request access to class recordings for classes you're enrolled in</p>
                    
                    <div style="background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">üìã How it works:</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #6c757d;">
                            <li>Load your enrolled classes below</li>
                            <li>Select classes you want recording access for</li>
                            <li id="paymentProofInstructionStep">Upload payment proof based on your batch requirements</li>
                            <li>Submit your request for admin approval</li>
                            <li>Check "My Recording Requests" for status updates</li>
                        </ol>
                    </div>
                    
                    <!-- Batch-specific payment requirements notice -->
                    <div id="batchPaymentNotice" style="display: none; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
                        <h5 style="margin: 0 0 5px 0;"></h5>
                        <p style="margin: 0; font-size: 14px;"></p>
                    </div>
                    
                    <!-- Special user privilege notice -->
                    <div id="specialUserNotice" style="display: none; background: #d1ecf1; padding: 12px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #17a2b8;">
                        <h5 style="margin: 0 0 5px 0; color: #0c5460;">üåü Special Recording Access</h5>
                        <p style="margin: 0; color: #0c5460; font-size: 14px;">
                            You have special privileges and can submit multiple recording requests for the same class if needed.
                        </p>
                    </div>
                    
                    <button class="btn" onclick="loadRecordingClasses()" style="width: auto; margin: 10px 0; background: #666666;">
                        üîÑ Load Available Classes
                    </button>
                    
                    <form id="recordingRequestForm">
                        <div id="recordingAvailableClasses" style="margin-bottom: 20px;">
                            <p style="color: #6c757d; text-align: center; padding: 20px; background: white; border: 1px dashed #dee2e6; border-radius: 5px;">
                                Click "Load Available Classes" to see classes you can request recordings for
                            </p>
                        </div>

                        <div class="form-group" id="recordingPaymentProofSection" style="display: none; background: white; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <label for="recordingPaymentProof" id="recordingPaymentProofLabel" style="font-weight: bold; color: #495057;">üí≥ Payment Proof</label>
                            <input type="file" id="recordingPaymentProof" accept="image/*,application/pdf" style="margin-top: 5px;">
                            <small id="recordingPaymentProofHelpText" style="color: #6c757d; display: block; margin-top: 5px;">
                                üìé Upload payment proof for recording access (JPG, PNG, or PDF)
                            </small>
                        </div>

                        <button type="submit" class="btn" id="recordingRequestBtn" style="display: none; background: #333333; margin-top: 15px;">
                            üì§ Submit Recording Request
                        </button>
                    </form>
                </div>

                <!-- My Recording Requests -->
                <div style="margin-bottom: 30px;">
                    <h3>My Recording Requests</h3>
                    <button class="btn" onclick="loadMyRecordingRequests()" style="width: auto; margin: 10px 0;">Refresh Requests</button>
                    
                    <table style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Class Name</th>
                                <th>Request Date</th>
                                <th>Status</th>
                                <th>Payment Proof</th>
                                <th>Recording Link & Access Time</th>
                            </tr>
                        </thead>
                        <tbody id="myRecordingRequestsTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #666;">Click refresh to load your recording requests</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notes Section -->
            <div id="notesSection" class="content-section hidden">
                <div class="content-header">
                    <h1>Class Notes</h1>
                    <p>Access notes for your enrolled classes</p>
                </div>

                <!-- Available Notes -->
                <div style="margin-bottom: 30px;">
                    <h3>üìö Available Notes</h3>
                    <button class="btn" onclick="loadAvailableNotes()" style="width: auto; margin: 10px 0;">Refresh Notes</button>
                    
                    <div id="availableNotesContainer">
                        <p style="color: #6c757d; text-align: center; padding: 20px; background: white; border: 1px dashed #dee2e6; border-radius: 5px;">
                            Click "Refresh Notes" to load available class notes
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Secure Video Player Modal -->
    <div id="videoModal" class="video-modal">
        <div class="video-modal-content">
            <div class="video-header">
                <div class="video-title" id="videoTitle">Class Recording</div>
                <button class="video-close" onclick="closeVideoPlayer()">&times;</button>
            </div>
            <div class="video-container">
                <div id="videoLoading" class="video-loading">
                    <div>Loading video...</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #ccc;">Please wait while the recording loads</div>
                    <div style="margin-top: 5px; font-size: 12px; color: #aaa;">‚úÖ Enhanced for full-length video playback</div>
                </div>
                <div id="videoError" class="video-error" style="display: none;">
                    <div>Unable to load video</div>
                    <div style="margin-top: 10px; font-size: 14px;">Please contact support if this issue persists</div>
                </div>
                <iframe id="videoIframe" class="video-iframe" style="display: none;" 
                        sandbox="allow-scripts allow-same-origin allow-presentation allow-forms"
                        allowfullscreen="true"
                        allow="autoplay; encrypted-media; picture-in-picture"
                        referrerpolicy="no-referrer">
                </iframe>
                <div class="video-overlay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://lfszceyrzwsyxlvubrcc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmc3pjZXlyendzeXhsdnVicmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5Nzg4OTUsImV4cCI6MjA2NTU1NDg5NX0.h2EHHl3bXwRxTbRlYrGkXFN8v5xlmf4u-2IuigmfSWc';
        
        // Initialize Supabase client directly from the imported library
        let supabase = null;
        
        // The correct initialization method
        if (typeof window.supabase !== 'undefined') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized successfully');
        } else {
            console.error('Supabase client library not loaded properly. Please check your connection.');
            alert('Error: Authentication system could not be initialized. Please refresh the page or try again later.');
        }

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let availableClasses = [];
        let myEnrollments = [];
        let selectedClasses = [];
        let sessionCheckInterval = null;

        // Session monitoring for single-session enforcement
        function startSessionMonitoring() {
            // Clear any existing interval
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }

            // Check session validity every 5 seconds for faster detection
            sessionCheckInterval = setInterval(async () => {
                try {
                    // Check if we have current user and session ID
                    if (!currentUser || !localStorage.getItem('current_session_id')) {
                        return;
                    }

                    console.log('[Session Monitor] Checking session validity...');

                    // Validate the current session
                    const isValidSession = await validateCurrentSession();
                    
                    if (!isValidSession) {
                        console.log('[Session Monitor] Session invalid - forcing logout');
                        handleSessionTerminated();
                        return;
                    } else {
                        console.log('[Session Monitor] Session is valid');
                    }

                    // Also check Supabase auth session
                    const { data: { session }, error } = await supabase.auth.getSession();
                    
                    if (error || !session) {
                        console.log('Supabase session terminated');
                        handleSessionTerminated();
                        return;
                    }

                } catch (error) {
                    console.error('Error in session monitoring:', error);
                    // Don't terminate on network errors, only on auth errors
                    if (error.message && error.message.includes('Invalid JWT')) {
                        handleSessionTerminated();
                    }
                }
            }, 5000); // Check every 5 seconds for immediate detection
        }

        function stopSessionMonitoring() {
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
                sessionCheckInterval = null;
            }
        }

        function handleSessionTerminated() {
            stopSessionMonitoring();
            
            // Clear current user data
            currentUser = null;
            
            // Clear session data
            localStorage.removeItem('current_session_id');
            
            // Force Supabase signout
            if (supabase) {
                supabase.auth.signOut().catch(console.error);
            }
            
            // Show session terminated message
            showSessionTerminatedDialog();
            
            // Force logout and return to login screen
            setTimeout(() => {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('dashboardSection').style.display = 'none';
                showLogin();
            }, 3000);
        }

        function showSessionTerminatedDialog() {
            // Create modal dialog
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    max-width: 400px;
                    text-align: center;
                    margin: 20px;
                ">
                    <div style="
                        width: 60px;
                        height: 60px;
                        background: #ffeaa7;
                        border-radius: 50%;
                        margin: 0 auto 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                    ">‚ö†Ô∏è</div>
                    
                    <h3 style="
                        margin: 0 0 15px 0;
                        color: #2d3436;
                        font-size: 20px;
                        font-weight: 600;
                    ">Session Terminated</h3>
                    
                    <p style="
                        margin: 0 0 20px 0;
                        color: #636e72;
                        line-height: 1.5;
                    ">
                        You have been logged in from another device. For security reasons, only one active session is allowed per user.
                    </p>
                    
                    <p style="
                        margin: 0;
                        color: #74b9ff;
                        font-size: 14px;
                    ">
                        Redirecting to login page...
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Remove modal after 3 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 3000);
        }

        // Device Approval UI Functions
        function showDeviceApprovalRequest(userId, deviceFingerprint, deviceInfo) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="margin-bottom: 20px;">
                        <div style="width: 80px; height: 80px; background: #ff6b35; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 40px;">üîí</span>
                        </div>
                        <h2 style="color: #333; margin-bottom: 10px;">New Device Detected</h2>
                        <p style="color: #666; line-height: 1.5; margin-bottom: 20px;">
                            We've detected that you're trying to log in from a new device. For security reasons, this device needs administrator approval.
                        </p>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">Device Information:</h4>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Device:</strong> ${deviceInfo.name}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Type:</strong> ${deviceInfo.type}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Resolution:</strong> ${deviceInfo.resolution}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Platform:</strong> ${deviceInfo.platform}</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; color: #333; font-weight: bold;">
                                Reason for requesting access (optional):
                            </label>
                            <textarea id="deviceJustification" style="
                                width: 100%;
                                height: 80px;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-family: inherit;
                                resize: vertical;
                            " placeholder="e.g., This is my personal laptop, my main computer broke down, etc."></textarea>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="requestApproval('${userId}', '${deviceFingerprint}', '${btoa(JSON.stringify(deviceInfo))}')" style="
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                            font-weight: bold;
                        ">Request Approval</button>
                        <button onclick="closeDeviceModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                        ">Cancel</button>
                    </div>
                </div>
            `;
            
            modal.id = 'deviceApprovalModal';
            document.body.appendChild(modal);
        }

        function showDeviceApprovalPending(request) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            `;
            
            const requestDate = new Date(request.requested_at).toLocaleDateString();
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 10px;
                    max-width: 450px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="margin-bottom: 20px;">
                        <div style="width: 80px; height: 80px; background: #ffa500; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 40px;">‚è≥</span>
                        </div>
                        <h2 style="color: #333; margin-bottom: 10px;">Approval Pending</h2>
                        <p style="color: #666; line-height: 1.5; margin-bottom: 20px;">
                            Your device access request is currently under review by the administrator.
                        </p>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffa500;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>Request submitted:</strong> ${requestDate}<br>
                                You will be notified once your request is processed.
                            </p>
                        </div>
                    </div>
                    <button onclick="closeDeviceModal()" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 5px;
                        font-size: 16px;
                        cursor: pointer;
                        font-weight: bold;
                    ">OK</button>
                </div>
            `;
            
            modal.id = 'deviceApprovalModal';
            document.body.appendChild(modal);
        }

        function showDeviceApprovalRejected(request) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            `;
            
            const rejectionDate = new Date(request.rejected_at).toLocaleDateString();
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="margin-bottom: 20px;">
                        <div style="width: 80px; height: 80px; background: #dc3545; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 40px;">‚ùå</span>
                        </div>
                        <h2 style="color: #333; margin-bottom: 10px;">Access Denied</h2>
                        <p style="color: #666; line-height: 1.5; margin-bottom: 20px;">
                            Your device access request has been rejected by the administrator.
                        </p>
                        ${request.rejection_reason ? `
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                                <p style="margin: 0; color: #721c24; font-size: 14px;">
                                    <strong>Reason:</strong> ${request.rejection_reason}
                                </p>
                            </div>
                        ` : ''}
                        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
                            <p style="margin: 0; color: #0c5460; font-size: 14px;">
                                <strong>Rejected on:</strong> ${rejectionDate}<br>
                                You can submit a new request or contact the administrator for assistance.
                            </p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="showDeviceApprovalRequest('${request.user_id}', '${request.device_fingerprint}', '${btoa(JSON.stringify(request.device_info))}')" style="
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                            font-weight: bold;
                        ">Request Again</button>
                        <button onclick="closeDeviceModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                        ">Cancel</button>
                    </div>
                </div>
            `;
            
            modal.id = 'deviceApprovalModal';
            document.body.appendChild(modal);
        }

        async function requestApproval(userId, deviceFingerprint, encodedDeviceInfo) {
            const deviceInfo = JSON.parse(atob(encodedDeviceInfo));
            const justification = document.getElementById('deviceJustification').value.trim();
            
            const success = await requestDeviceApproval(userId, deviceFingerprint, deviceInfo, justification);
            
            if (success) {
                closeDeviceModal();
                showDeviceApprovalPending({
                    requested_at: new Date().toISOString()
                });
            } else {
                alert('Failed to submit device approval request. Please try again.');
            }
        }

        function closeDeviceModal() {
            const modal = document.getElementById('deviceApprovalModal');
            if (modal) {
                modal.remove();
            }
        }

        // Authentication functions
        function showLogin() {
            document.querySelector('.auth-tab.active').classList.remove('active');
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('passwordResetForm').classList.add('hidden');
        }

        function showRegister() {
            document.querySelector('.auth-tab.active').classList.remove('active');
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('passwordResetForm').classList.add('hidden');
        }

        function showPasswordReset() {
            // Clear active tabs since this is not a tab
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('passwordResetForm').classList.remove('hidden');
        }

        // Dashboard functions
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Add active class to selected nav link
            event.target.classList.add('active');

            // Load data for specific sections
            if (section === 'enrollment') {
                loadAvailableClasses();
                loadMyEnrollments();
            } else if (section === 'recordings') {
                loadRecordingClasses();
                loadMyRecordingRequests();
                updateBatchPaymentNotice(); // Update batch notice when entering recordings section
            } else {
                // Stop countdown when leaving recordings section
                stopRecordingCountdown();
            }
            
            if (section === 'notes') {
                loadAvailableNotes();
            }
        }

        async function updateProfile() {
            if (!supabase || !currentUser || isAdmin) {
                alert('Profile update functionality requires database tables to be set up. Please enable Supabase MCP tool to create the required tables.');
                return;
            }
            
            const name = document.getElementById('profileName').value;
            const email = document.getElementById('profileEmail').value;
            const nic = document.getElementById('profileNIC').value;
            const mobile = document.getElementById('profileMobile').value;
            const batch = document.getElementById('profileBatch').value;
            
            try {
                // Store the proposed changes in a separate table/record without updating the main profile
                const { error } = await supabase
                    .from('user_profiles')
                    .update({
                        pending_name: name,
                        pending_email: email,
                        pending_nic: nic,
                        pending_mobile: mobile,
                        pending_batch: batch,
                        profile_update_pending: true,
                        profile_update_requested_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                // DON'T update current user data or display - keep original values
                // The profile form will still show the new values they entered
                // But the display will show original approved data
                
                alert('Profile update request submitted! Your changes will be reviewed by an administrator. Your current profile information remains unchanged until approved.');
            } catch (error) {
                alert('Profile update failed: ' + error.message);
            }
        }
        
        function loadUserProfile() {
            console.log('Loading user profile to form fields');
            if (currentUser && !isAdmin) {
                // Update form fields with current user data
                document.getElementById('profileName').value = currentUser.name || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profileNIC').value = currentUser.nic || '';
                document.getElementById('profileMobile').value = currentUser.mobile || '';
                document.getElementById('profileBatch').value = currentUser.batch || '';
                
                console.log('Profile form populated with user data');
            } else {
                console.warn('Cannot load profile - no user data or user is admin');
            }
        }

        async function logout() {
            console.log('Logout initiated for user:', currentUser ? currentUser.name : 'No user');
            
            // Visual feedback for logout button
            const logoutButton = document.getElementById('logoutButton');
            if (!logoutButton) {
                console.error('Logout button not found');
                return;
            }
            
            const originalText = logoutButton.textContent;
            logoutButton.textContent = 'Logging out...';
            logoutButton.disabled = true;
            
            try {
                // Stop session monitoring first
                stopSessionMonitoring();
                
                // Use the new session management logout function
                await logoutAndClearSession();
                
                // Clear user data
                currentUser = null;
                isAdmin = false;
                
                // Clear forms
                try {
                    document.getElementById('loginForm').reset();
                    document.getElementById('registerForm').reset();
                    
                    // Clear profile form
                    document.getElementById('profileName').value = '';
                    document.getElementById('profileEmail').value = '';
                    document.getElementById('profileNIC').value = '';
                    document.getElementById('profileMobile').value = '';
                    document.getElementById('profileBatch').value = '';
                } catch (formError) {
                    console.warn('Error clearing forms:', formError);
                }
                
                // Clear any error messages
                const errorMessages = document.querySelectorAll('#loginErrorMessage, #registerErrorMessage');
                errorMessages.forEach(msg => msg.remove());
                
                console.log('Logout completed successfully');
                
            } catch (error) {
                console.error('Error during logout:', error);
                // Even if there's an error, still clear the UI
                try {
                    currentUser = null;
                    isAdmin = false;
                    
                    // Force clear session data
                    localStorage.removeItem('current_session_id');
                    
                    // Force sign out
                    if (supabase) {
                        await supabase.auth.signOut();
                    }
                    
                    // Force UI reset
                    document.getElementById('authSection').style.display = 'flex';
                    document.getElementById('dashboardSection').style.display = 'none';
                    showLogin();
                    
                } catch (forceLogoutError) {
                    console.error('Error in force logout:', forceLogoutError);
                }
            } finally {
                // Reset logout button state
                if (logoutButton) {
                    logoutButton.textContent = originalText;
                    logoutButton.disabled = false;
                }
            }
        }

        function showDashboard() {
            if (currentUser) {
                console.log('Showing dashboard for user:', currentUser.name);
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userRole').textContent = currentUser.role;
                
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'flex';
                
                // Load data for profile section
                document.getElementById('profileName').value = currentUser.name || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profileNIC').value = currentUser.nic || '';
                document.getElementById('profileMobile').value = currentUser.mobile || '';
                document.getElementById('profileBatch').value = currentUser.batch || '';
                
                // Show special user notice if applicable
                if (currentUser.email === 'ashanf00@yahoo.com') {
                    document.getElementById('specialUserNotice').style.display = 'block';
                } else {
                    document.getElementById('specialUserNotice').style.display = 'none';
                }

                // Update batch-specific payment requirements notice
                updateBatchPaymentNotice();
                
                // Load recording data when dashboard is shown
                try {
                    loadRecordingClasses();
                    loadMyRecordingRequests();
                } catch (error) {
                    console.error('Error loading recording data:', error);
                }
            } else {
                console.error('Attempted to show dashboard without user data');
            }
        }

        // Session Management Helper Functions
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getDeviceInfo() {
            const screen = window.screen;
            const userAgent = navigator.userAgent;
            
            let deviceType = 'Unknown';
            if (/Mobile|Android|iPhone|iPad/.test(userAgent)) {
                deviceType = 'Mobile';
            } else if (/Tablet|iPad/.test(userAgent)) {
                deviceType = 'Tablet';
            } else {
                deviceType = 'Desktop';
            }
            
            return `${deviceType} - ${screen.width}x${screen.height}`;
        }

        // Device Access Control Functions
        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint test', 2, 2);
            
            const fingerprint = {
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                userAgent: navigator.userAgent,
                colorDepth: screen.colorDepth,
                deviceMemory: navigator.deviceMemory || 'unknown',
                canvasFingerprint: canvas.toDataURL(),
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack || 'unknown'
            };
            
            // Create a hash of the fingerprint for storage
            const fingerprintString = JSON.stringify(fingerprint);
            return btoa(fingerprintString).substr(0, 32); // First 32 chars of base64
        }

        function getDetailedDeviceInfo() {
            const screen = window.screen;
            const userAgent = navigator.userAgent;
            
            let deviceType = 'Unknown';
            let deviceName = 'Unknown Device';
            
            if (/iPhone/.test(userAgent)) {
                deviceType = 'Mobile';
                deviceName = 'iPhone';
            } else if (/iPad/.test(userAgent)) {
                deviceType = 'Tablet';
                deviceName = 'iPad';
            } else if (/Android.*Mobile/.test(userAgent)) {
                deviceType = 'Mobile';
                deviceName = 'Android Phone';
            } else if (/Android/.test(userAgent)) {
                deviceType = 'Tablet';
                deviceName = 'Android Tablet';
            } else if (/Windows/.test(userAgent)) {
                deviceType = 'Desktop';
                deviceName = 'Windows PC';
            } else if (/Mac/.test(userAgent)) {
                deviceType = 'Desktop';
                deviceName = 'Mac';
            } else if (/Linux/.test(userAgent)) {
                deviceType = 'Desktop';
                deviceName = 'Linux PC';
            }
            
            return {
                type: deviceType,
                name: deviceName,
                resolution: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                userAgent: navigator.userAgent,
                cookieEnabled: navigator.cookieEnabled,
                onlineStatus: navigator.onLine
            };
        }

        async function checkDeviceApproval(userId, deviceFingerprint) {
            try {
                // Check if device is already approved
                const { data: approvedDevice, error: approvedError } = await supabase
                    .from('approved_devices')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('device_fingerprint', deviceFingerprint)
                    .eq('is_active', true)
                    .single();

                if (approvedDevice) {
                    // Update last seen timestamp
                    await supabase
                        .from('approved_devices')
                        .update({ last_seen: new Date().toISOString() })
                        .eq('id', approvedDevice.id);
                    
                    return { approved: true, device: approvedDevice };
                }

                // Check if there's a pending request
                const { data: pendingRequest, error: requestError } = await supabase
                    .from('device_access_requests')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('device_fingerprint', deviceFingerprint)
                    .eq('status', 'pending')
                    .single();

                if (pendingRequest) {
                    return { approved: false, status: 'pending', request: pendingRequest };
                }

                // Check if request was rejected
                const { data: rejectedRequest, error: rejectedError } = await supabase
                    .from('device_access_requests')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('device_fingerprint', deviceFingerprint)
                    .eq('status', 'rejected')
                    .order('requested_at', { ascending: false })
                    .limit(1)
                    .single();

                if (rejectedRequest) {
                    return { approved: false, status: 'rejected', request: rejectedRequest };
                }

                return { approved: false, status: 'new' };
            } catch (error) {
                console.error('Error checking device approval:', error);
                return { approved: false, status: 'error', error: error.message };
            }
        }

        async function autoApproveFirstDevice(userId, deviceFingerprint, deviceInfo) {
            try {
                // Check if user has any approved devices
                const { data: existingDevices, error } = await supabase
                    .from('approved_devices')
                    .select('id')
                    .eq('user_id', userId);

                if (existingDevices && existingDevices.length === 0) {
                    // This is the first device, auto-approve it
                    const { data: newDevice, error: approvalError } = await supabase
                        .from('approved_devices')
                        .insert({
                            user_id: userId,
                            device_fingerprint: deviceFingerprint,
                            device_name: `${deviceInfo.name} (Primary)`,
                            device_info: deviceInfo,
                            auto_approved: true
                        })
                        .select()
                        .single();

                    if (approvalError) {
                        console.error('Error auto-approving first device:', approvalError);
                        return false;
                    }

                    console.log('First device auto-approved:', newDevice);
                    return true;
                }

                return false; // Not the first device
            } catch (error) {
                console.error('Error in auto-approve logic:', error);
                return false;
            }
        }

        async function requestDeviceApproval(userId, deviceFingerprint, deviceInfo, userJustification) {
            try {
                const { data: request, error } = await supabase
                    .from('device_access_requests')
                    .insert({
                        user_id: userId,
                        device_fingerprint: deviceFingerprint,
                        device_info: deviceInfo,
                        user_justification: userJustification || 'User requested access from new device'
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Error creating device access request:', error);
                    return false;
                }

                console.log('Device access request created:', request);
                return true;
            } catch (error) {
                console.error('Error requesting device approval:', error);
                return false;
            }
        }

        async function validateCurrentSession() {
            const currentSessionId = localStorage.getItem('current_session_id');
            if (!currentSessionId) {
                return false;
            }

            try {
                const { data: user } = await supabase.auth.getUser();
                if (!user.user) {
                    return false;
                }

                // Check if current session is still valid and active
                const { data: sessionData, error } = await supabase
                    .from('user_sessions')
                    .select('*')
                    .eq('user_id', user.user.id)
                    .eq('session_id', currentSessionId)
                    .eq('is_active', true)
                    .single();

                if (error || !sessionData) {
                    console.log('[Session Validation] Session not found or error:', error?.message || 'Session not found');
                    return false;
                }

                // Check if session has expired
                const now = new Date();
                const expiresAt = new Date(sessionData.expires_at);
                if (now > expiresAt) {
                    // Mark session as inactive
                    await supabase
                        .from('user_sessions')
                        .update({ is_active: false })
                        .eq('session_id', currentSessionId);
                    return false;
                }

                // Update last activity
                await supabase
                    .from('user_sessions')
                    .update({ last_activity: new Date().toISOString() })
                    .eq('session_id', currentSessionId);

                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                return false;
            }
        }

        async function logoutAndClearSession() {
            const currentSessionId = localStorage.getItem('current_session_id');
            
            // Mark current session as inactive
            if (currentSessionId) {
                try {
                    await supabase
                        .from('user_sessions')
                        .update({ is_active: false })
                        .eq('session_id', currentSessionId);
                } catch (error) {
                    console.error('Error marking session inactive:', error);
                }
            }
            
            // Clear local session data
            localStorage.removeItem('current_session_id');
            
            // Sign out from Supabase
            await supabase.auth.signOut();
            
            // Reset UI
            currentUser = null;
            
            // Show auth section and hide dashboard
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('dashboardSection').style.display = 'none';
            
            // Reset to login tab
            showLogin();
        }

        // Form submissions
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Status indicator for login process
            const loginButton = this.querySelector('button[type="submit"]');
            const originalButtonText = loginButton.textContent;
            loginButton.textContent = 'Logging in...';
            loginButton.disabled = true;
            
            // Clear any previous error messages
            const errorMsg = document.createElement('div');
            errorMsg.id = 'loginErrorMessage';
            errorMsg.style.cssText = 'color: #dc3545; margin-top: 10px; padding: 10px; background: #ffecef; border-radius: 5px; font-size: 14px;';
            
            // Remove any existing error message
            const existingErrorMsg = document.getElementById('loginErrorMessage');
            if (existingErrorMsg) existingErrorMsg.remove();
            
            if (!supabase) {
                errorMsg.innerHTML = '<strong>Error:</strong> Login system not initialized. Please refresh the page and try again.';
                this.appendChild(errorMsg);
                loginButton.textContent = originalButtonText;
                loginButton.disabled = false;
                return;
            }
            
            try {
                console.log('Attempting login for:', email);
                
                // Sign in with Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) {
                    console.error('Authentication error:', authError);
                    errorMsg.innerHTML = `<strong>Login failed:</strong> ${authError.message}`;
                    this.appendChild(errorMsg);
                    loginButton.textContent = originalButtonText;
                    loginButton.disabled = false;
                    return;
                }
                
                console.log('Authentication successful, user ID:', authData.user.id);
                
                // Device Access Control - Check if device is approved
                const deviceFingerprint = generateDeviceFingerprint();
                const deviceInfo = getDetailedDeviceInfo();
                
                console.log('Checking device approval for fingerprint:', deviceFingerprint);
                
                const deviceCheck = await checkDeviceApproval(authData.user.id, deviceFingerprint);
                
                if (!deviceCheck.approved) {
                    if (deviceCheck.status === 'new') {
                        // Try to auto-approve if this is the first device
                        const autoApproved = await autoApproveFirstDevice(authData.user.id, deviceFingerprint, deviceInfo);
                        
                        if (!autoApproved) {
                            // Show device approval request form
                            await supabase.auth.signOut(); // Sign out since device not approved
                            showDeviceApprovalRequest(authData.user.id, deviceFingerprint, deviceInfo);
                            loginButton.textContent = originalButtonText;
                            loginButton.disabled = false;
                            return;
                        }
                    } else if (deviceCheck.status === 'pending') {
                        await supabase.auth.signOut();
                        showDeviceApprovalPending(deviceCheck.request);
                        loginButton.textContent = originalButtonText;
                        loginButton.disabled = false;
                        return;
                    } else if (deviceCheck.status === 'rejected') {
                        await supabase.auth.signOut();
                        showDeviceApprovalRejected(deviceCheck.request);
                        loginButton.textContent = originalButtonText;
                        loginButton.disabled = false;
                        return;
                    } else {
                        await supabase.auth.signOut();
                        errorMsg.innerHTML = '<strong>Device Access Error:</strong> Unable to verify device access. Please try again or contact administrator.';
                        this.appendChild(errorMsg);
                        loginButton.textContent = originalButtonText;
                        loginButton.disabled = false;
                        return;
                    }
                }
                
                console.log('Device approved, proceeding with login');
                
                // Single session management - invalidate existing sessions
                try {
                    // Generate new session ID
                    const newSessionId = generateSessionId();
                    
                    // Get device/browser info
                    const deviceInfo = getDeviceInfo();
                    
                    // First, invalidate all existing active sessions for this user
                    const { error: updateError } = await supabase
                        .from('user_sessions')
                        .update({ is_active: false })
                        .eq('user_id', authData.user.id)
                        .eq('is_active', true);
                    
                    if (updateError) {
                        console.warn('Warning: Could not invalidate existing sessions:', updateError);
                    }
                    
                    // Create new session record with device fingerprint
                    const { error: sessionError } = await supabase
                        .from('user_sessions')
                        .insert({
                            user_id: authData.user.id,
                            session_id: newSessionId,
                            device_info: deviceInfo,
                            device_fingerprint: deviceFingerprint,
                            user_agent: navigator.userAgent,
                            last_activity: new Date().toISOString()
                        });
                    
                    if (sessionError) {
                        console.error('Session creation error:', sessionError);
                        errorMsg.innerHTML = '<strong>Session error:</strong> Could not create login session. Please try again.';
                        this.appendChild(errorMsg);
                        await supabase.auth.signOut();
                        loginButton.textContent = originalButtonText;
                        loginButton.disabled = false;
                        return;
                    }
                    
                    // Store session ID in localStorage for validation
                    localStorage.setItem('current_session_id', newSessionId);
                    console.log('New session created:', newSessionId);
                    
                } catch (sessionManagementError) {
                    console.error('Session management error:', sessionManagementError);
                    errorMsg.innerHTML = '<strong>Login error:</strong> Session management failed. Please try again.';
                    this.appendChild(errorMsg);
                    await supabase.auth.signOut();
                    loginButton.textContent = originalButtonText;
                    loginButton.disabled = false;
                    return;
                }
                
                // Get user profile data
                const { data: profileData, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', authData.user.id);
                
                if (profileError) {
                    console.error('Profile fetch error:', profileError);
                    errorMsg.innerHTML = `<strong>Error:</strong> Could not retrieve your profile. ${profileError.message}`;
                    this.appendChild(errorMsg);
                    loginButton.textContent = originalButtonText;
                    loginButton.disabled = false;
                    return;
                }
                
                console.log('Profile data retrieved:', profileData);
                
                // Check if profile exists
                if (!profileData || profileData.length === 0) {
                    console.error('No profile found for user ID:', authData.user.id);
                    errorMsg.innerHTML = '<strong>Account error:</strong> Your profile was not found. Please contact the administrator.';
                    this.appendChild(errorMsg);
                    loginButton.textContent = originalButtonText;
                    loginButton.disabled = false;
                    return;
                }
                
                const userProfile = profileData[0];
                console.log('User status:', userProfile.status);
                
                // Check if user is approved
                if (userProfile.status !== 'approved') {
                    await supabase.auth.signOut();
                    let statusMessage = '';
                    if (userProfile.status === 'pending') {
                        statusMessage = 'Your account is pending approval. Please wait for admin approval.';
                    } else if (userProfile.status === 'rejected') {
                        statusMessage = 'Your account has been rejected. Please contact the administrator.';
                    } else {
                        statusMessage = `Your account status is: ${userProfile.status}. Please contact the administrator.`;
                    }
                    
                    errorMsg.innerHTML = `<strong>Access denied:</strong> ${statusMessage}`;
                    this.appendChild(errorMsg);
                    loginButton.textContent = originalButtonText;
                    loginButton.disabled = false;
                    return;
                }
                
                currentUser = {
                    id: authData.user.id,
                    name: userProfile.name,
                    email: userProfile.email,
                    nic: userProfile.nic,
                    mobile: userProfile.mobile,
                    batch: userProfile.batch,
                    status: userProfile.status,
                    role: 'Student'
                };
                
                console.log('Login successful, user data:', currentUser);
                
                isAdmin = false;
                
                // Start session monitoring for single-session enforcement
                startSessionMonitoring();
                
                showDashboard();
                loadUserProfile();
                
                // Clear form
                this.reset();
                
            } catch (error) {
                console.error('Unexpected login error:', error);
                const errorMsg = document.createElement('div');
                errorMsg.id = 'loginErrorMessage';
                errorMsg.style.cssText = 'color: #dc3545; margin-top: 10px; padding: 10px; background: #ffecef; border-radius: 5px; font-size: 14px;';
                errorMsg.innerHTML = `<strong>Error:</strong> ${error.message}`;
                this.appendChild(errorMsg);
            } finally {
                // Reset button state
                const loginButton = this.querySelector('button[type="submit"]');
                loginButton.textContent = 'Login';
                loginButton.disabled = false;
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Status indicator for registration process
            const registerButton = this.querySelector('button[type="submit"]');
            const originalButtonText = registerButton.textContent;
            registerButton.textContent = 'Registering...';
            registerButton.disabled = true;
            
            // Clear any previous error messages
            const errorMsg = document.createElement('div');
            errorMsg.id = 'registerErrorMessage';
            errorMsg.style.cssText = 'color: #dc3545; margin-top: 10px; padding: 10px; background: #ffecef; border-radius: 5px; font-size: 14px;';
            
            // Remove any existing error message
            const existingErrorMsg = document.getElementById('registerErrorMessage');
            if (existingErrorMsg) existingErrorMsg.remove();
            
            if (!supabase) {
                errorMsg.innerHTML = '<strong>Error:</strong> Registration system not initialized. Please refresh the page and try again.';
                this.appendChild(errorMsg);
                registerButton.textContent = originalButtonText;
                registerButton.disabled = false;
                return;
            }
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const nic = document.getElementById('registerNIC').value;
            const mobile = document.getElementById('registerMobile').value;
            const batch = document.getElementById('registerBatch').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                console.log('Attempting to register user:', email);
                
                // Register user with Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (authError) {
                    console.error('Registration auth error:', authError);
                    errorMsg.innerHTML = `<strong>Registration failed:</strong> ${authError.message}`;
                    this.appendChild(errorMsg);
                    registerButton.textContent = originalButtonText;
                    registerButton.disabled = false;
                    return;
                }
                
                console.log('User registered with Supabase Auth, ID:', authData.user.id);
                
                // Store additional user data
                const { error: profileError } = await supabase
                    .from('user_profiles')
                    .insert([{
                        user_id: authData.user.id,
                        name: name,
                        email: email,
                        nic: nic,
                        mobile: mobile,
                        batch: batch,
                        status: 'pending'
                    }]);
                
                if (profileError) {
                    console.error('Profile creation error:', profileError);
                    errorMsg.innerHTML = `<strong>Error:</strong> Your account was created but profile setup failed. Please contact the administrator. ${profileError.message}`;
                    this.appendChild(errorMsg);
                    registerButton.textContent = originalButtonText;
                    registerButton.disabled = false;
                    return;
                }
                
                // Success message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'color: #333333; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 14px;';
                successMsg.innerHTML = '<strong>Registration successful!</strong> Your account is pending admin approval. You will be notified once approved.';
                this.appendChild(successMsg);
                
                // Reset form
                this.reset();
                
                // Redirect to login after 3 seconds
                setTimeout(() => {
                    showLogin();
                    // Remove success message when switching to login
                    successMsg.remove();
                }, 3000);
                
            } catch (error) {
                console.error('Unexpected registration error:', error);
                errorMsg.innerHTML = `<strong>Registration error:</strong> ${error.message}`;
                this.appendChild(errorMsg);
            } finally {
                // Reset button state
                registerButton.textContent = originalButtonText;
                registerButton.disabled = false;
            }
        });

        // Password Reset Request Form Handler
        document.getElementById('passwordResetForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value.trim();
            const nic = document.getElementById('resetNIC').value.trim();
            const name = document.getElementById('resetName').value.trim();
            const reason = document.getElementById('resetReason').value.trim();
            
            if (!email || !nic || !name) {
                alert('Please fill in all required fields (Email, NIC, Name).');
                return;
            }

            if (!supabase) {
                alert('Password reset service is not available. Please try again later.');
                return;
            }

            const resetButton = this.querySelector('button[type="submit"]');
            const originalButtonText = resetButton.textContent;
            resetButton.textContent = 'Submitting...';
            resetButton.disabled = true;

            try {
                // Check if user exists in user_profiles
                const { data: existingUser, error: userError } = await supabase
                    .from('user_profiles')
                    .select('email, nic, name')
                    .eq('email', email)
                    .eq('nic', nic)
                    .single();

                if (userError && userError.code !== 'PGRST116') {
                    throw new Error('Database error checking user information.');
                }

                if (!existingUser) {
                    alert('No account found with the provided email and NIC combination. Please check your information.');
                    return;
                }

                // Check for existing pending requests
                const { data: existingRequest, error: requestError } = await supabase
                    .from('password_reset_requests')
                    .select('*')
                    .eq('user_email', email)
                    .eq('status', 'pending')
                    .single();

                if (requestError && requestError.code !== 'PGRST116') {
                    throw new Error('Error checking existing requests.');
                }

                if (existingRequest) {
                    alert('You already have a pending password reset request. Please wait for admin approval or contact support.');
                    return;
                }

                // Submit password reset request
                const { error: insertError } = await supabase
                    .from('password_reset_requests')
                    .insert([{
                        user_email: email,
                        user_nic: nic,
                        user_name: name,
                        reason: reason || 'Password reset requested'
                    }]);

                if (insertError) {
                    throw insertError;
                }

                // Show success message
                alert('Password reset request submitted successfully! The administrator will review your request and provide a temporary password if approved. Please check back later or contact the administrator.');
                
                // Clear form and go back to login
                document.getElementById('resetEmail').value = '';
                document.getElementById('resetNIC').value = '';
                document.getElementById('resetName').value = '';
                document.getElementById('resetReason').value = '';
                showLogin();

            } catch (error) {
                console.error('Password reset request error:', error);
                alert('Failed to submit password reset request: ' + error.message);
            } finally {
                resetButton.textContent = originalButtonText;
                resetButton.disabled = false;
            }
        });

        // Check Reset Request Status Function
        async function checkResetStatus() {
            const email = prompt('Enter your email address to check reset request status:');
            if (!email) return;

            if (!supabase) {
                alert('Service not available. Please try again later.');
                return;
            }

            try {
                const { data: requests, error } = await supabase
                    .from('password_reset_requests')
                    .select('*')
                    .eq('user_email', email)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (!requests || requests.length === 0) {
                    alert('No password reset requests found for this email address.');
                    return;
                }

                const request = requests[0];
                let statusMessage = `Password Reset Request Status:\n\n`;
                statusMessage += `Status: ${request.status.toUpperCase()}\n`;
                statusMessage += `Submitted: ${new Date(request.created_at).toLocaleString()}\n`;

                if (request.status === 'approved') {
                    statusMessage += `\nApproved by: ${request.approved_by || 'Administrator'}\n`;
                    if (request.approved_at) {
                        statusMessage += `Approved on: ${new Date(request.approved_at).toLocaleString()}\n`;
                    }
                    if (request.temporary_password) {
                        statusMessage += `\nTemporary Password: ${request.temporary_password}\n`;
                        statusMessage += `\nPlease use this temporary password to log in and change your password immediately.`;
                    }
                    if (request.admin_notes) {
                        statusMessage += `\nAdmin Notes: ${request.admin_notes}`;
                    }
                } else if (request.status === 'rejected') {
                    statusMessage += `\nReason for rejection: ${request.admin_notes || 'No reason provided'}`;
                } else {
                    statusMessage += `\nYour request is still pending review. Please wait for administrator approval.`;
                }

                alert(statusMessage);

            } catch (error) {
                console.error('Status check error:', error);
                alert('Failed to check request status: ' + error.message);
            }
        }

        // Class Enrollment Functions
        async function loadAvailableClasses() {
            if (!supabase) {
                alert('Database connection required. Please enable Supabase MCP tool.');
                return;
            }

            try {
                const { data: classes, error } = await supabase
                    .from('classes')
                    .select('*')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                availableClasses = classes;
                displayAvailableClasses();
            } catch (error) {
                alert('Failed to load classes: ' + error.message);
            }
        }

        function displayAvailableClasses() {
            const container = document.getElementById('availableClasses');
            
            if (availableClasses.length === 0) {
                container.innerHTML = '<p>No classes available at the moment.</p>';
                return;
            }

            // Get class IDs with pending or approved enrollments (not rejected)
            const blockedClassIds = myEnrollments
                .filter(enrollment => enrollment.status === 'pending' || enrollment.status === 'approved')
                .map(enrollment => enrollment.class_id);

            // Filter classes into Commercial Law I and Commercial Law II
            const commercialLaw1Classes = availableClasses.filter(cls => 
                (cls.name.includes('Commercial Law I') && !cls.name.includes('Commercial Law II')) || 
                (cls.name.includes('Commercial Law 1') && !cls.name.includes('Commercial Law 2'))
            );
            
            const commercialLaw2Classes = availableClasses.filter(cls => 
                cls.name.includes('Commercial Law II') || 
                cls.name.includes('Commercial Law 2')
            );
            
            // Other classes that don't fit either category
            const otherClasses = availableClasses.filter(cls => 
                !(cls.name.includes('Commercial Law I') || 
                  cls.name.includes('Commercial Law 1') ||
                  cls.name.includes('Commercial Law II') || 
                  cls.name.includes('Commercial Law 2'))
            );
            
            // Create two-column layout
            let html = `
                <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                    <!-- Commercial Law I Box -->
                    <div style="flex: 1; min-width: 300px; border: 1px solid #007bff; border-radius: 10px; padding: 15px; background: #f8f9fa;">
                        <h3 style="margin-top: 0; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 8px; margin-bottom: 15px;">
                            Commercial Law I
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            ${renderClassList(commercialLaw1Classes, blockedClassIds)}
                        </div>
                    </div>
                    
                    <!-- Commercial Law II Box -->
                    <div style="flex: 1; min-width: 300px; border: 1px solid #28a745; border-radius: 10px; padding: 15px; background: #f8f9fa;">
                        <h3 style="margin-top: 0; color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 8px; margin-bottom: 15px;">
                            Commercial Law II
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            ${renderClassList(commercialLaw2Classes, blockedClassIds)}
                        </div>
                    </div>
                </div>
            `;
            
            // Add other classes section if there are any
            if (otherClasses.length > 0) {
                html += `
                    <div style="border: 1px solid #6c757d; border-radius: 10px; padding: 15px; background: #f8f9fa; margin-top: 20px;">
                        <h3 style="margin-top: 0; color: #6c757d; border-bottom: 2px solid #6c757d; padding-bottom: 8px; margin-bottom: 15px;">
                            Other Classes
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            ${renderClassList(otherClasses, blockedClassIds)}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        // Helper function to render a list of classes
        function renderClassList(classes, blockedClassIds) {
            if (classes.length === 0) {
                return '<p style="color: #666; font-style: italic;">No classes available in this category</p>';
            }
            
            let html = '';
            
            classes.forEach(cls => {
                const enrollment = myEnrollments.find(e => e.class_id === cls.id);
                const isBlocked = blockedClassIds.includes(cls.id);
                const isDisabled = isBlocked ? 'disabled' : '';
                const checkboxStyle = isBlocked ? 'opacity: 0.5;' : '';
                
                let statusText = '';
                if (enrollment) {
                    const statusColors = {
                        pending: '#856404',
                        approved: '#28a745',
                        rejected: '#dc3545'
                    };
                    const color = statusColors[enrollment.status] || '#666';
                    statusText = `<br><small style="color: ${color}; font-weight: bold;">
                        ${enrollment.status === 'pending' ? 'Enrollment Pending' : 
                          enrollment.status === 'approved' ? 'Already Enrolled' : 
                          'Previously Rejected - Can Reapply'}
                    </small>`;
                }
                
                html += `
                    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; ${checkboxStyle}; background: white;">
                        <label style="display: flex; align-items: flex-start; cursor: ${isBlocked ? 'not-allowed' : 'pointer'};">
                            <input type="checkbox" value="${cls.id}" onchange="toggleClassSelection(this)" ${isDisabled} 
                                   style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <strong>${cls.name}</strong>
                                ${statusText}
                            </div>
                        </label>
                    </div>
                `;
            });
            
            return html;
        }

        function toggleClassSelection(checkbox) {
            const classId = checkbox.value;
            
            if (checkbox.checked) {
                selectedClasses.push(classId);
            } else {
                selectedClasses = selectedClasses.filter(id => id !== classId);
            }
            
            // Show/hide payment proof section and enroll button
            const paymentSection = document.getElementById('paymentProofSection');
            const enrollBtn = document.getElementById('enrollBtn');
            
            if (selectedClasses.length > 0) {
                paymentSection.style.display = 'block';
                enrollBtn.style.display = 'block';
            } else {
                paymentSection.style.display = 'none';
                enrollBtn.style.display = 'none';
            }
        }

        async function loadMyEnrollments() {
            if (!supabase || !currentUser) {
                return;
            }

            try {
                const { data: enrollments, error } = await supabase
                    .from('enrollments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('enrolled_at', { ascending: false });

                if (error) throw error;
                
                // Get class information separately
                const classIds = enrollments.map(enrollment => enrollment.class_id);
                
                if (classIds.length > 0) {
                    const { data: classes, error: classError } = await supabase
                        .from('classes')
                        .select('id, name')
                        .in('id', classIds);
                    
                    if (classError) throw classError;
                    
                    // Add class details to enrollment objects
                    enrollments.forEach(enrollment => {
                        const classInfo = classes.find(c => c.id === enrollment.class_id);
                        enrollment.classes = classInfo || { name: 'Unknown Class' };
                    });
                }

                myEnrollments = enrollments;
                displayMyEnrollments();
            } catch (error) {
                alert('Failed to load enrollments: ' + error.message);
            }
        }

        function displayMyEnrollments() {
            const tbody = document.getElementById('myEnrollmentsBody');
            
            if (myEnrollments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center;">No enrollments found</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            myEnrollments.forEach(enrollment => {
                const row = document.createElement('tr');
                const enrollmentDate = new Date(enrollment.enrolled_at).toLocaleDateString();
                const statusColors = {
                    pending: '#856404',
                    approved: '#155724',
                    rejected: '#721c24'
                };
                const statusBgs = {
                    pending: '#fff3cd',
                    approved: '#d4edda',
                    rejected: '#f8d7da'
                };
                
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${enrollment.classes.name}
                        ${enrollment.notes ? `<br><small style="color: #dc3545; font-style: italic;">Admin Note: ${enrollment.notes}</small>` : ''}
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                              background: ${statusBgs[enrollment.status]}; color: ${statusColors[enrollment.status]};">
                            ${enrollment.status.toUpperCase()}
                        </span>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${enrollmentDate}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Recording Functions
        let selectedRecordingClasses = [];

        async function loadRecordingClasses() {
            if (!supabase || !currentUser) {
                document.getElementById('recordingAvailableClasses').innerHTML = '<p style="color: #dc3545;">Please log in to request recordings.</p>';
                return;
            }

            try {
                // Get user's approved enrollments
                const { data: enrollments, error: enrollError } = await supabase
                    .from('enrollments')
                    .select(`
                        class_id,
                        classes (
                            id, name, description, price
                        )
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('status', 'approved');

                if (enrollError) throw enrollError;

                const container = document.getElementById('recordingAvailableClasses');
                
                if (enrollments.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: white; border: 1px solid #dee2e6; border-radius: 5px;">
                            <p style="color: #6c757d; margin: 0;">üìö You need to be enrolled and approved in classes to request recordings.</p>
                            <small style="color: #6c757d;">Go to "Class Enrollment" to enroll in classes first.</small>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                        <h4 style="margin: 0 0 15px 0; color: #495057;">üìã Select classes to request recordings for:</h4>
                        <div id="classSelectionArea"></div>
                    </div>
                `;
                
                const selectionArea = document.getElementById('classSelectionArea');
                
                enrollments.forEach(enrollment => {
                    const classDiv = document.createElement('div');
                    classDiv.style.cssText = `
                        border: 2px solid #e9ecef; 
                        padding: 15px; 
                        margin: 10px 0; 
                        border-radius: 8px; 
                        background: #f8f9fa;
                        transition: all 0.3s ease;
                        cursor: pointer;
                    `;
                    
                    classDiv.innerHTML = `
                        <label style="display: flex; align-items: flex-start; cursor: pointer; width: 100%;">
                            <input type="checkbox" value="${enrollment.classes.id}" onchange="toggleRecordingClass('${enrollment.classes.id}')" 
                                   style="margin: 5px 15px 0 0; transform: scale(1.2);" id="recording-class-${enrollment.classes.id}">
                            <div style="flex: 1;">
                                <strong style="color: #495057; font-size: 16px;">${enrollment.classes.name}</strong>
                                <p style="margin: 8px 0; color: #6c757d; line-height: 1.4;">${enrollment.classes.description || 'No description available'}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <small style="color: #28a745; font-weight: bold;">‚úÖ Enrolled & Approved</small>
                                    ${enrollment.classes.price ? `<small style="color: #6c757d;">Price: LKR ${enrollment.classes.price}</small>` : ''}
                                </div>
                            </div>
                        </label>
                    `;
                    
                    // Add hover effects
                    classDiv.addEventListener('mouseenter', function() {
                        this.style.borderColor = '#333333';
                        this.style.backgroundColor = '#ffffff';
                    });
                    
                    classDiv.addEventListener('mouseleave', function() {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        if (!checkbox.checked) {
                            this.style.borderColor = '#e9ecef';
                            this.style.backgroundColor = '#f8f9fa';
                        }
                    });
                    
                    selectionArea.appendChild(classDiv);
                });

            } catch (error) {
                console.error('Error loading recording classes:', error);
                document.getElementById('recordingAvailableClasses').innerHTML = '<p style="color: #dc3545;">Error loading classes. Please try again.</p>';
            }
        }

        function toggleRecordingClass(classId) {
            const checkbox = document.querySelector(`input[value="${classId}"]`);
            const classDiv = checkbox.closest('div[style*="border"]');
            
            if (checkbox.checked) {
                if (!selectedRecordingClasses.includes(classId)) {
                    selectedRecordingClasses.push(classId);
                }
                // Update visual styling for selected class
                if (classDiv) {
                    classDiv.style.borderColor = '#333333';
                    classDiv.style.backgroundColor = '#ffffff';
                    classDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                }
            } else {
                selectedRecordingClasses = selectedRecordingClasses.filter(id => id !== classId);
                // Reset visual styling for unselected class
                if (classDiv) {
                    classDiv.style.borderColor = '#e9ecef';
                    classDiv.style.backgroundColor = '#f8f9fa';
                    classDiv.style.boxShadow = 'none';
                }
            }
            
            // Show/hide payment proof and submit button based on batch requirements
            console.log('toggleRecordingClass - selectedRecordingClasses:', selectedRecordingClasses);
            console.log('toggleRecordingClass - currentUser:', currentUser);
            console.log('toggleRecordingClass - currentUser.batch:', currentUser?.batch);
            
            if (selectedRecordingClasses.length > 0) {
                // Always show submit button when classes are selected
                const submitBtn = document.getElementById('recordingRequestBtn');
                submitBtn.style.display = 'block';
                
                // Update submit button text
                const count = selectedRecordingClasses.length;
                submitBtn.textContent = count === 1 ? 
                    'üì§ Submit Recording Request' : 
                    `üì§ Submit ${count} Recording Requests`;
                
                // Batch-based payment proof logic
                if (currentUser && currentUser.batch) {
                    if (currentUser.batch === 'Current Batch') {
                        // Current Batch students don't need payment proof for recordings
                        document.getElementById('recordingPaymentProofSection').style.display = 'none';
                        console.log('Current Batch - hiding payment proof section');
                    } else if (currentUser.batch === "April'25 Batch") {
                        // April'25 Batch students must provide payment proof
                        const paymentSection = document.getElementById('recordingPaymentProofSection');
                        paymentSection.style.display = 'block';
                        document.getElementById('recordingPaymentProofLabel').innerHTML = 'üí≥ Payment Proof (Required) *';
                        document.getElementById('recordingPaymentProof').required = true;
                        document.getElementById('recordingPaymentProofHelpText').innerHTML = 'üìé <strong>Required:</strong> Upload payment proof for recording access (JPG, PNG, or PDF)';
                        document.getElementById('recordingPaymentProofHelpText').style.color = '#dc3545';
                        console.log('April 25 Batch - showing required payment proof section');
                    } else {
                        // Other batches - optional payment proof (backward compatibility)
                        document.getElementById('recordingPaymentProofSection').style.display = 'block';
                        document.getElementById('recordingPaymentProofLabel').innerHTML = 'üí≥ Payment Proof (Optional)';
                        document.getElementById('recordingPaymentProof').required = false;
                        document.getElementById('recordingPaymentProofHelpText').innerHTML = 'üìé Upload payment proof if required for recording access (JPG, PNG, or PDF)';
                        document.getElementById('recordingPaymentProofHelpText').style.color = '#6c757d';
                        console.log('Other Batch - showing optional payment proof section');
                    }
                } else {
                    // Fallback for users without batch info - show optional (backward compatibility)
                    document.getElementById('recordingPaymentProofSection').style.display = 'block';
                    document.getElementById('recordingPaymentProofLabel').innerHTML = 'üí≥ Payment Proof (Optional)';
                    document.getElementById('recordingPaymentProof').required = false;
                    document.getElementById('recordingPaymentProofHelpText').innerHTML = 'üìé Upload payment proof if required for recording access (JPG, PNG, or PDF)';
                    document.getElementById('recordingPaymentProofHelpText').style.color = '#6c757d';
                    console.log('No batch info - showing optional payment proof section');
                }
            } else {
                document.getElementById('recordingPaymentProofSection').style.display = 'none';
                document.getElementById('recordingRequestBtn').style.display = 'none';
                console.log('No classes selected - hiding both payment proof and submit button');
            }
        }

        async function loadMyRecordingRequests() {
            console.log('=== DEBUGGING loadMyRecordingRequests ===');
            console.log('supabase available:', !!supabase);
            console.log('currentUser available:', !!currentUser);
            console.log('currentUser object:', currentUser);
            
            if (!supabase || !currentUser) {
                console.log('Missing supabase or currentUser, returning early');
                const tbody = document.getElementById('myRecordingRequestsTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;">Please log in to view recording requests</td></tr>';
                }
                return;
            }

            try {
                console.log('Loading recording requests for user ID:', currentUser.id);
                console.log('User ID type:', typeof currentUser.id);
                
                // Check current auth status
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                console.log('Current auth user:', user);
                console.log('Auth error:', authError);
                console.log('Is user authenticated?', !!user);
                console.log('Auth UID:', user?.id);
                
                // Test direct query first to see if we can access the table at all
                console.log('Testing direct query to recording_requests table...');
                const { data: allRequests, error: testError } = await supabase
                    .from('recording_requests')
                    .select('*')
                    .limit(5);
                    
                console.log('Test query result:', { data: allRequests, error: testError });
                
                // Load recording requests first (without restrictive inner join)
                console.log('Querying recording requests for specific user...');
                const { data: requests, error: requestsError } = await supabase
                    .from('recording_requests')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('requested_at', { ascending: false });

                console.log('User-specific query result:', { data: requests, error: requestsError });

                if (requestsError) {
                    console.error('Error loading recording requests:', requestsError);
                    const tbody = document.getElementById('myRecordingRequestsTableBody');
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;">Error loading requests: ' + requestsError.message + '</td></tr>';
                    return;
                }

                console.log(`Found ${requests ? requests.length : 0} recording requests for user ${currentUser.id}`);

                // Start countdown timer for active recordings
                startRecordingCountdown();

                // Get classes information
                const { data: classes, error: classesError } = await supabase
                    .from('classes')
                    .select('id, name');
                    
                // Get class recordings information  
                const { data: recordings, error: recordingsError } = await supabase
                    .from('class_recordings')
                    .select('class_id, google_drive_url, zoom_url');

                // Create lookup maps
                const classMap = {};
                if (classes) {
                    classes.forEach(cls => {
                        classMap[cls.id] = cls.name;
                    });
                }

                const recordingMap = {};
                if (recordings) {
                    recordings.forEach(recording => {
                        recordingMap[recording.class_id] = {
                            google_drive_url: recording.google_drive_url,
                            zoom_url: recording.zoom_url
                        };
                    });
                }

                const tbody = document.getElementById('myRecordingRequestsTableBody');
                tbody.innerHTML = '';

                if (!requests || requests.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="5" style="text-align: center; color: #666;">No recording requests found</td>';
                    tbody.appendChild(row);
                    return;
                }

                requests.forEach(request => {
                    const row = document.createElement('tr');
                    const requestDate = new Date(request.requested_at).toLocaleDateString();
                    
                    const statusColors = {
                        pending: '#856404',
                        approved: '#155724',
                        rejected: '#721c24'
                    };
                    
                    const statusBgs = {
                        pending: '#fff3cd',
                        approved: '#d4edda',
                        rejected: '#f8d7da'
                    };

                    const className = classMap[request.class_id] || 'Unknown Class';
                    
                    let recordingLink = 'Not available';
                    if (request.status === 'approved' && recordingMap[request.class_id]) {
                        const recording = recordingMap[request.class_id];
                        const safeClassName = className.replace(/'/g, "\\'");
                        
                        let buttons = [];
                        if (recording.google_drive_url) {
                            buttons.push(`<button onclick="openSecureVideoPlayer('${recording.google_drive_url}', '${safeClassName} - Google Drive', '${request.id}')" style="background: #4285f4; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-right: 5px;">üìÅ Google Drive</button>`);
                        }
                        if (recording.zoom_url) {
                            buttons.push(`<button onclick="openSecureVideoPlayer('${recording.zoom_url}', '${safeClassName} - Zoom', '${request.id}')" style="background: #2D8CFF; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">üìπ Zoom</button>`);
                        }
                        
                        if (buttons.length > 0) {
                            // Check expiry first to determine if links should be disabled
                            let isExpired = false;
                            let expiryInfo = '';
                            
                            if (request.access_expiry_minutes) {
                                const now = new Date();
                                
                                if (!request.first_accessed_at) {
                                    const expiryText = formatExpiryTime(request.access_expiry_minutes);
                                    expiryInfo = `<div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 8px; border-left: 3px solid #ffc107;">
                                        <strong style="color: #856404;">‚è∞ Time-Limited Access</strong><br>
                                        <span style="color: #856404; font-size: 12px;">Will expire ${expiryText} after first click</span>
                                    </div>`;
                                } else {
                                    const expiryTime = new Date(request.access_expires_at);
                                    if (now > expiryTime) {
                                        isExpired = true;
                                        expiryInfo = `<div style="background: #f8d7da; padding: 8px; border-radius: 4px; margin-top: 8px; border-left: 3px solid #dc3545;">
                                            <strong style="color: #721c24;">‚ùå Access Expired</strong><br>
                                            <span style="color: #721c24; font-size: 12px;">Recording access has expired</span>
                                        </div>`;
                                    } else {
                                        const remainingMinutes = Math.floor((expiryTime - now) / (1000 * 60));
                                        const remainingText = formatRemainingTime(remainingMinutes);
                                        
                                        // Color based on urgency
                                        let urgencyColor = '#28a745'; // green
                                        let urgencyBg = '#d4edda';
                                        if (remainingMinutes < 60) { // less than 1 hour
                                            urgencyColor = '#dc3545'; // red
                                            urgencyBg = '#f8d7da';
                                        } else if (remainingMinutes < 1440) { // less than 1 day
                                            urgencyColor = '#fd7e14'; // orange
                                            urgencyBg = '#fff3cd';
                                        }
                                        
                                        expiryInfo = `<div data-expiry-time="${expiryTime.toISOString()}" style="background: ${urgencyBg}; padding: 8px; border-radius: 4px; margin-top: 8px; border-left: 3px solid ${urgencyColor};">
                                            <strong style="color: ${urgencyColor};">‚è≥ Time Remaining: ${remainingText}</strong><br>
                                            <span style="color: ${urgencyColor}; font-size: 12px;">Access will expire on ${expiryTime.toLocaleDateString()} at ${expiryTime.toLocaleTimeString()}</span>
                                        </div>`;
                                    }
                                }
                            }
                            
                            if (isExpired) {
                                recordingLink = `<div style="text-align: center;">
                                    <span style="color: #dc3545; font-weight: bold;">‚ùå Access Expired</span>
                                    ${expiryInfo}
                                </div>`;
                            } else {
                                recordingLink = `<div>
                                    ${buttons.join(' ')}
                                    ${expiryInfo}
                                </div>`;
                            }
                        } else {
                            recordingLink = '<span style="color: #ffc107;">‚è≥ Recording not uploaded yet</span>';
                        }
                    } else if (request.status === 'approved') {
                        recordingLink = '<span style="color: #ffc107;">‚è≥ Recording not uploaded yet</span>';
                    }

                    row.innerHTML = `
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${className}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${requestDate}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                                  background: ${statusBgs[request.status]}; color: ${statusColors[request.status]};">
                                ${request.status.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">
                            ${request.payment_proof_url ? '<span style="color: #28a745;">‚úÖ Uploaded</span>' : '<span style="color: #6c757d;">Not provided</span>'}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${recordingLink}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading recording requests:', error);
                const tbody = document.getElementById('myRecordingRequestsTableBody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;">Error loading requests: ' + error.message + '</td></tr>';
            }
        }



        // Recording Request Form Submission
        document.getElementById('recordingRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!supabase || !currentUser) {
                alert('Please log in to request recordings.');
                return;
            }

            if (selectedRecordingClasses.length === 0) {
                alert('Please select at least one class to request recordings for.');
                return;
            }

            try {
                // Batch-based payment proof validation
                const paymentProofFile = document.getElementById('recordingPaymentProof').files[0];
                
                if (currentUser && currentUser.batch === "April'25 Batch") {
                    // April'25 Batch students MUST provide payment proof
                    if (!paymentProofFile) {
                        alert('Payment proof is required for April\'25 Batch students when requesting recording access. Please upload your payment receipt.');
                        return;
                    }
                } else if (currentUser && currentUser.batch === 'Current Batch') {
                    // Current Batch students don't need payment proof - this is just a comment for clarity
                    // No validation needed, payment proof is optional and will be ignored
                }
                // For other batches or users without batch info, payment proof remains optional (backward compatibility)

                // Special exception for ashanf00@yahoo.com - allow multiple requests for same class
                const isSpecialUser = currentUser.email === 'ashanf00@yahoo.com';
                let newClassIds = selectedRecordingClasses;

                if (!isSpecialUser) {
                    // Check for existing requests first to prevent duplicates (for all other users)
                    const { data: existingRequests, error: checkError } = await supabase
                        .from('recording_requests')
                        .select('class_id')
                        .eq('user_id', currentUser.id)
                        .in('class_id', selectedRecordingClasses);

                    if (checkError) throw checkError;

                    // Filter out classes that already have requests
                    const existingClassIds = existingRequests.map(req => req.class_id);
                    newClassIds = selectedRecordingClasses.filter(classId => !existingClassIds.includes(classId));

                    if (newClassIds.length === 0) {
                        alert('You have already submitted recording requests for all selected classes. Please check "My Recording Requests" section.');
                        return;
                    }

                    if (existingClassIds.length > 0) {
                        const confirmMessage = `You already have requests for ${existingClassIds.length} selected class(es). Do you want to submit requests for the remaining ${newClassIds.length} class(es)?`;
                        if (!confirm(confirmMessage)) {
                            return;
                        }
                    }
                } else {
                    // For special user, show a different message if they're submitting requests for classes they already requested
                    const { data: existingRequests, error: checkError } = await supabase
                        .from('recording_requests')
                        .select('class_id')
                        .eq('user_id', currentUser.id)
                        .in('class_id', selectedRecordingClasses);

                    if (checkError) throw checkError;

                    const existingClassIds = existingRequests.map(req => req.class_id);
                    const duplicateClassIds = selectedRecordingClasses.filter(classId => existingClassIds.includes(classId));
                    
                    if (duplicateClassIds.length > 0) {
                        const confirmMessage = `You are submitting additional requests for ${duplicateClassIds.length} class(es) that you already have requests for. This will create duplicate requests. Continue?`;
                        if (!confirm(confirmMessage)) {
                            return;
                        }
                    }
                }

                let paymentProofUrl = null;

                // Handle payment proof based on batch requirements
                if (paymentProofFile) {
                    const reader = new FileReader();
                    const fileReadPromise = new Promise((resolve, reject) => {
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(new Error('Failed to read file'));
                    });
                    
                    reader.readAsDataURL(paymentProofFile);
                    paymentProofUrl = await fileReadPromise;
                }

                // Create recording requests for new classes only
                const requestData = newClassIds.map(classId => ({
                    user_id: currentUser.id,
                    class_id: classId,
                    payment_proof_url: paymentProofUrl,
                    payment_proof_filename: paymentProofFile ? paymentProofFile.name : null,
                    status: 'pending',
                    requested_at: new Date().toISOString()
                }));

                const { error } = await supabase
                    .from('recording_requests')
                    .insert(requestData);

                if (error) throw error;

                const submittedCount = newClassIds.length;
                const message = submittedCount === 1 
                    ? 'Recording request submitted successfully! Admin will review your request.'
                    : `${submittedCount} recording requests submitted successfully! Admin will review your requests.`;
                alert(message);

                // Reset form
                selectedRecordingClasses = [];
                document.getElementById('recordingRequestForm').reset();
                document.getElementById('recordingPaymentProofSection').style.display = 'none';
                document.getElementById('recordingRequestBtn').style.display = 'none';
                
                // Reload data
                loadRecordingClasses();
                loadMyRecordingRequests();

            } catch (error) {
                alert('Failed to submit recording request: ' + error.message);
            }
        });

        // Enrollment Form Submission
        document.getElementById('enrollmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!supabase || !currentUser) {
                alert('Please log in to enroll in classes.');
                return;
            }

            if (selectedClasses.length === 0) {
                alert('Please select at least one class to enroll.');
                return;
            }

            const paymentProofFile = document.getElementById('paymentProof').files[0];
            if (!paymentProofFile) {
                alert('Please upload payment proof.');
                return;
            }

            try {
                // Convert file to Base64 for embedding directly in database
                const reader = new FileReader();
                
                // Set up promise to handle file reading
                const fileReadPromise = new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('Failed to read file'));
                });
                
                // Start reading the file
                reader.readAsDataURL(paymentProofFile);
                
                // Wait for file to be read
                const fileBase64 = await fileReadPromise;
                
                // Check for existing enrollments for all selected classes
                const { data: existingEnrollments, error: fetchError } = await supabase
                    .from('enrollments')
                    .select('id, class_id, status')
                    .eq('user_id', currentUser.id)
                    .in('class_id', selectedClasses);
                
                if (fetchError) throw fetchError;
                
                // Separate classes into different categories
                const blockedClassIds = [];
                const updateableClassIds = [];
                const newClassIds = [];
                
                selectedClasses.forEach(classId => {
                    const existing = existingEnrollments.find(e => e.class_id === classId);
                    
                    if (!existing) {
                        // No existing enrollment - can create new
                        newClassIds.push(classId);
                    } else if (existing.status === 'rejected') {
                        // Rejected enrollment - can update to pending
                        updateableClassIds.push({ id: existing.id, class_id: classId });
                    } else {
                        // Pending or approved - cannot enroll
                        blockedClassIds.push({ class_id: classId, status: existing.status });
                    }
                });
                
                // Handle blocked classes
                if (blockedClassIds.length > 0) {
                    const { data: blockedClasses } = await supabase
                        .from('classes')
                        .select('id, name')
                        .in('id', blockedClassIds.map(b => b.class_id));
                    
                    const blockedClassNames = blockedClasses.map(cls => {
                        const status = blockedClassIds.find(b => b.class_id === cls.id).status;
                        return `${cls.name} (${status})`;
                    });
                    
                    if (newClassIds.length === 0 && updateableClassIds.length === 0) {
                        throw new Error(`Cannot enroll in selected classes:\n${blockedClassNames.join('\n')}`);
                    }
                    
                    const blockedList = blockedClassNames.join('\n');
                    if (!confirm(`Some classes cannot be enrolled:\n${blockedList}\n\nContinue with remaining classes?`)) {
                        return;
                    }
                }
                
                // Insert new enrollment records with Base64 data
                if (newClassIds.length > 0) {
                    const enrollmentData = newClassIds.map(classId => ({
                        user_id: currentUser.id,
                        class_id: classId,
                        payment_proof_url: fileBase64,
                        payment_proof_filename: paymentProofFile.name
                    }));

                    const { error: insertError } = await supabase
                        .from('enrollments')
                        .insert(enrollmentData);

                    if (insertError) throw insertError;
                    
                    alert('Enrollment requests submitted! Your enrollments will be reviewed by an administrator.');
                }
                
                // Update rejected enrollments to pending with Base64 data
                if (updateableClassIds.length > 0) {
                    for (const enrollment of updateableClassIds) {
                        const { error: updateError } = await supabase
                            .from('enrollments')
                            .update({
                                status: 'pending',
                                payment_proof_url: fileBase64, 
                                payment_proof_filename: paymentProofFile.name,
                                enrolled_at: new Date().toISOString()
                            })
                            .eq('id', enrollment.id);

                        if (updateError) throw updateError;
                    }
                }

                // Don't show this second alert since we already showed one above
                
                // Reset form
                selectedClasses = [];
                document.getElementById('enrollmentForm').reset();
                document.getElementById('paymentProofSection').style.display = 'none';
                document.getElementById('enrollBtn').style.display = 'none';
                
                // Reload data
                loadAvailableClasses();
                loadMyEnrollments();
                
            } catch (error) {
                alert('Enrollment failed: ' + error.message);
            }
        });

        // Password reset URL handler (fallback)
        function handlePasswordResetFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token');
            const type = urlParams.get('type');

            if (accessToken && refreshToken && type === 'recovery') {
                console.log('Password reset tokens detected in URL');
                
                // Show password reset interface
                const resetPassword = prompt('Please enter your new password (minimum 6 characters):');
                if (resetPassword && resetPassword.length >= 6) {
                    const confirmPassword = prompt('Please confirm your new password:');
                    if (resetPassword === confirmPassword) {
                        // Set session and update password
                        supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        }).then(({ data, error }) => {
                            if (error) {
                                console.error('Session error:', error);
                                alert('Reset link is invalid or expired. Please request a new password reset.');
                                return;
                            }
                            
                            // Update password
                            return supabase.auth.updateUser({ password: resetPassword });
                        }).then(({ error }) => {
                            if (error) {
                                console.error('Password update error:', error);
                                alert('Failed to update password: ' + error.message);
                            } else {
                                alert('Password updated successfully! You can now log in with your new password.');
                                // Clear URL parameters and refresh
                                window.history.replaceState({}, document.title, window.location.pathname);
                                showLogin();
                            }
                        });
                    } else {
                        alert('Passwords do not match. Please try again.');
                    }
                } else {
                    alert('Password must be at least 6 characters long.');
                }
            }
        }

        // Secure Video Player Functions
        function extractGoogleDriveFileId(url) {
            // Extract file ID from various Google Drive and Google Workspace URL formats
            // Extracting file ID securely
            
            const patterns = [
                // Google Drive file URLs
                /\/file\/d\/([a-zA-Z0-9-_]+)/,
                /id=([a-zA-Z0-9-_]+)/,
                /\/open\?id=([a-zA-Z0-9-_]+)/,
                /\/view\?id=([a-zA-Z0-9-_]+)/,
                // Google Docs URLs
                /\/document\/d\/([a-zA-Z0-9-_]+)/,
                // Google Sheets URLs
                /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/,
                // Google Slides URLs
                /\/presentation\/d\/([a-zA-Z0-9-_]+)/,
                // Other Google Drive formats
                /\/d\/([a-zA-Z0-9-_]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    console.log('File ID extracted:', match[1]);
                    return match[1];
                }
            }
            
            // Could not extract file ID from URL
            return null;
        }

        async function checkRecordingAccess(requestId) {
            try {
                const { data: request, error } = await supabase
                    .from('recording_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();

                if (error) throw error;

                if (request.status !== 'approved') {
                    return { allowed: false, message: 'Recording access not approved.' };
                }

                // If no expiry is set, allow access
                if (!request.access_expiry_minutes) {
                    return { allowed: true };
                }

                const now = new Date();

                // If this is the first access, record it
                if (!request.first_accessed_at) {
                    const expiryTime = new Date(now.getTime() + (request.access_expiry_minutes * 60 * 1000));
                    
                    const { error: updateError } = await supabase
                        .from('recording_requests')
                        .update({
                            first_accessed_at: now.toISOString(),
                            access_expires_at: expiryTime.toISOString()
                        })
                        .eq('id', requestId);

                    if (updateError) throw updateError;

                    const expiryText = formatExpiryTime(request.access_expiry_minutes);
                    return { 
                        allowed: true,
                        message: `Recording access granted! This recording will expire in ${expiryText}.`
                    };
                }

                // Check if access has expired
                const expiryTime = new Date(request.access_expires_at);
                if (now > expiryTime) {
                    const expiredText = formatExpiryTime(request.access_expiry_minutes);
                    return { 
                        allowed: false, 
                        message: `Recording access has expired. Access was valid for ${expiredText} after first viewing.` 
                    };
                }

                // Calculate remaining time
                const remainingMinutes = Math.floor((expiryTime - now) / (1000 * 60));
                const remainingText = formatRemainingTime(remainingMinutes);
                
                return { 
                    allowed: true,
                    message: `Recording access granted! Time remaining: ${remainingText}.`
                };

            } catch (error) {
                console.error('Error checking recording access:', error);
                return { allowed: false, message: 'Error checking recording access. Please try again.' };
            }
        }

        function formatExpiryTime(minutes) {
            if (minutes < 60) {
                return `${minutes} minute${minutes !== 1 ? 's' : ''}`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const remainingMins = minutes % 60;
                let result = `${hours} hour${hours !== 1 ? 's' : ''}`;
                if (remainingMins > 0) {
                    result += ` and ${remainingMins} minute${remainingMins !== 1 ? 's' : ''}`;
                }
                return result;
            } else {
                const days = Math.floor(minutes / 1440);
                const remainingHours = Math.floor((minutes % 1440) / 60);
                let result = `${days} day${days !== 1 ? 's' : ''}`;
                if (remainingHours > 0) {
                    result += ` and ${remainingHours} hour${remainingHours !== 1 ? 's' : ''}`;
                }
                return result;
            }
        }

        function formatRemainingTime(minutes) {
            if (minutes < 60) {
                return `${minutes} minute${minutes !== 1 ? 's' : ''}`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const remainingMins = minutes % 60;
                if (remainingMins === 0) {
                    return `${hours} hour${hours !== 1 ? 's' : ''}`;
                } else {
                    return `${hours}h ${remainingMins}m`;
                }
            } else {
                const days = Math.floor(minutes / 1440);
                const remainingHours = Math.floor((minutes % 1440) / 60);
                if (remainingHours === 0) {
                    return `${days} day${days !== 1 ? 's' : ''}`;
                } else {
                    return `${days}d ${remainingHours}h`;
                }
            }
        }

        // Live countdown timer for recording access
        let recordingCountdownInterval;

        function startRecordingCountdown() {
            // Clear any existing countdown
            if (recordingCountdownInterval) {
                clearInterval(recordingCountdownInterval);
            }

            recordingCountdownInterval = setInterval(async () => {
                // Only update if we're on the recordings section
                const recordingsSection = document.getElementById('recordingsSection');
                if (!recordingsSection || recordingsSection.classList.contains('hidden')) {
                    return;
                }

                // Get all countdown elements and update them
                const countdownElements = document.querySelectorAll('[data-expiry-time]');
                countdownElements.forEach(element => {
                    const expiryTime = new Date(element.getAttribute('data-expiry-time'));
                    const now = new Date();
                    const remainingMinutes = Math.floor((expiryTime - now) / (1000 * 60));

                    if (remainingMinutes <= 0) {
                        // Access expired - refresh the table
                        loadMyRecordingRequests();
                        return;
                    }

                    const remainingText = formatRemainingTime(remainingMinutes);
                    
                    // Update color based on urgency
                    let urgencyColor = '#28a745'; // green
                    let urgencyBg = '#d4edda';
                    if (remainingMinutes < 60) { // less than 1 hour
                        urgencyColor = '#dc3545'; // red
                        urgencyBg = '#f8d7da';
                    } else if (remainingMinutes < 1440) { // less than 1 day
                        urgencyColor = '#fd7e14'; // orange
                        urgencyBg = '#fff3cd';
                    }

                    element.style.background = urgencyBg;
                    element.style.borderLeftColor = urgencyColor;
                    element.querySelector('strong').style.color = urgencyColor;
                    element.querySelector('strong').innerHTML = `‚è≥ Time Remaining: ${remainingText}`;
                    element.querySelector('span').style.color = urgencyColor;
                });
            }, 60000); // Update every minute
        }

        function stopRecordingCountdown() {
            if (recordingCountdownInterval) {
                clearInterval(recordingCountdownInterval);
                recordingCountdownInterval = null;
            }
        }

        // Update batch-specific payment requirements notice
        function updateBatchPaymentNotice() {
            const noticeDiv = document.getElementById('batchPaymentNotice');
            const instructionStep = document.getElementById('paymentProofInstructionStep');
            
            if (!currentUser || !currentUser.batch) {
                noticeDiv.style.display = 'none';
                instructionStep.textContent = 'Upload payment proof if required';
                return;
            }

            const batch = currentUser.batch;
            const noticeTitle = noticeDiv.querySelector('h5');
            const noticeText = noticeDiv.querySelector('p');

            if (batch === 'Current Batch') {
                noticeDiv.style.display = 'block';
                noticeDiv.style.background = '#d4edda';
                noticeDiv.style.borderLeft = '4px solid #28a745';
                noticeTitle.style.color = '#155724';
                noticeTitle.textContent = '‚úÖ Current Batch - No Payment Required';
                noticeText.style.color = '#155724';
                noticeText.textContent = 'As a Current Batch student, you can request recording access without uploading payment proof.';
                instructionStep.textContent = 'No payment proof required for Current Batch students';
            } else if (batch === "April'25 Batch") {
                noticeDiv.style.display = 'block';
                noticeDiv.style.background = '#fff3cd';
                noticeDiv.style.borderLeft = '4px solid #ffc107';
                noticeTitle.style.color = '#856404';
                noticeTitle.textContent = 'üí≥ April\'25 Batch - Payment Required';
                noticeText.style.color = '#856404';
                noticeText.textContent = 'As an April\'25 Batch student, you must upload payment proof when requesting recording access.';
                instructionStep.textContent = 'Upload payment proof (REQUIRED for April\'25 Batch)';
            } else {
                noticeDiv.style.display = 'block';
                noticeDiv.style.background = '#e2e3e5';
                noticeDiv.style.borderLeft = '4px solid #6c757d';
                noticeTitle.style.color = '#495057';
                noticeTitle.textContent = 'üìã ' + batch + ' - Payment Optional';
                noticeText.style.color = '#495057';
                noticeText.textContent = 'Payment proof is optional for your batch. Upload if required by your enrollment terms.';
                instructionStep.textContent = 'Upload payment proof if required for your batch';
            }
        }

        function detectVideoUrlType(url) {
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                return 'google_drive';
            } else if (url.includes('zoom.us') || url.includes('zoom.com')) {
                return 'zoom';
            }
            return 'unknown';
        }

        function extractZoomEmbedUrl(url) {
            // Enhanced Zoom URL handling for full video playback
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('zoom.us') || urlObj.hostname.includes('zoom.com')) {
                    // Remove any existing restrictive parameters
                    urlObj.searchParams.delete('continueMode');
                    urlObj.searchParams.delete('componentName');
                    
                    // Add parameters for full playback
                    urlObj.searchParams.set('autoplay', 'false');
                    urlObj.searchParams.set('startTime', '0');
                    urlObj.searchParams.set('continueMode', 'true');
                    
                    // For embedded playback, we need to ensure proper format
                    let baseUrl = urlObj.toString();
                    
                    // If it's a /rec/play/ URL, ensure it's properly formatted for embedding
                    if (baseUrl.includes('/rec/play/')) {
                        // Remove any trailing parameters that might restrict playback
                        baseUrl = baseUrl.split('?')[0];
                        return `${baseUrl}?autoplay=false&startTime=0&continueMode=true`;
                    }
                    
                    return baseUrl;
                }
            } catch (e) {
                // Error parsing Zoom URL
            }
            return url; // Return original if parsing fails
        }

        async function openSecureVideoPlayer(videoUrl, title = 'Class Recording', requestId = null) {
            console.log('Opening secure video player for:', title);
            
            // Check recording access expiry if requestId is provided
            if (requestId) {
                const accessCheck = await checkRecordingAccess(requestId);
                if (!accessCheck.allowed) {
                    alert(accessCheck.message);
                    return;
                }
            }
            
            const urlType = detectVideoUrlType(videoUrl);
            let embedUrl = '';
            
            if (urlType === 'google_drive') {
                // Handle Google Drive URLs
                const fileId = extractGoogleDriveFileId(videoUrl);
                if (!fileId) {
                    // Could not extract file ID from Google Drive URL
                    alert('Invalid Google Drive link. Please contact support.');
                    return;
                }
                // Use multiple fallback methods for full video playback
                // Method 1: Direct preview (best for most videos)
                embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                
                // Store alternative URLs for fallback
                window.alternativeEmbedUrls = [
                    `https://drive.google.com/file/d/${fileId}/preview?embedded=true`,
                    `https://drive.google.com/uc?export=download&id=${fileId}`,
                    `https://drive.google.com/file/d/${fileId}/view`
                ];
            } else if (urlType === 'zoom') {
                // Handle Zoom URLs with multiple fallback methods
                const baseZoomUrl = extractZoomEmbedUrl(videoUrl);
                embedUrl = baseZoomUrl;
                
                // Create alternative Zoom embed URLs for fallback
                window.alternativeEmbedUrls = [];
                
                try {
                    const urlObj = new URL(videoUrl);
                    const baseUrl = urlObj.origin + urlObj.pathname;
                    
                    // Multiple Zoom embed strategies
                    window.alternativeEmbedUrls = [
                        // Method 1: Standard embed with continue mode
                        `${baseUrl}?autoplay=false&continueMode=true`,
                        // Method 2: Direct playback URL
                        `${baseUrl}?autoplay=false&startTime=0`,
                        // Method 3: Without any parameters (direct link)
                        baseUrl,
                        // Method 4: Original URL as final fallback
                        videoUrl
                    ];
                } catch (e) {
                    // Error creating Zoom fallback URLs
                    window.alternativeEmbedUrls = [videoUrl];
                }
            } else {
                // Unsupported video URL type
                alert('Unsupported video link format. Please contact support.');
                return;
            }

            // Show modal
            const modal = document.getElementById('videoModal');
            const videoTitle = document.getElementById('videoTitle');
            const videoIframe = document.getElementById('videoIframe');
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');

            // Set title
            videoTitle.textContent = title;

            // Show modal and loading state
            modal.style.display = 'block';
            videoLoading.style.display = 'block';
            videoIframe.style.display = 'none';
            videoError.style.display = 'none';

            // Enhanced video loading with fallback methods
            let currentUrlIndex = 0;
            let loadAttempted = false;
            
            function attemptVideoLoad() {
                loadAttempted = true;
                console.log(`Attempting to load video with method ${currentUrlIndex + 1}`);
                
                videoIframe.onload = function() {
                    console.log('Video loaded successfully');
                    videoLoading.style.display = 'none';
                    videoIframe.style.display = 'block';
                    
                    // Add message about video duration
                    if (urlType === 'google_drive' && currentUrlIndex === 0) {
                        console.log('Using optimized Google Drive embed for full video playback');
                    } else if (urlType === 'zoom') {
                        console.log(`Using Zoom embed method ${currentUrlIndex + 1} for full video playback`);
                        
                        // Special handling for Zoom - sometimes the iframe loads but content is restricted
                        // Set a longer timeout to check if video actually starts playing
                        setTimeout(function() {
                            // Add a subtle indicator that this is a Zoom recording
                            if (videoTitle) {
                                if (!videoTitle.textContent.includes('(Zoom)')) {
                                    videoTitle.textContent += ' (Zoom Recording)';
                                }
                            }
                        }, 2000);
                    }
                };

                videoIframe.onerror = function() {
                    console.error('Video failed to load with current method');
                    tryNextMethod();
                };
                
                // Set a timeout to try next method if video doesn't load
                // Use shorter timeout for Zoom videos as they tend to fail faster
                const timeoutDuration = urlType === 'zoom' ? 7000 : 10000;
                setTimeout(function() {
                    if (videoLoading.style.display === 'block' && currentUrlIndex < window.alternativeEmbedUrls?.length) {
                        console.log(`Video loading timeout after ${timeoutDuration/1000}s, trying next method...`);
                        tryNextMethod();
                    }
                }, timeoutDuration);
            }
            
            function tryNextMethod() {
                if (window.alternativeEmbedUrls && currentUrlIndex < window.alternativeEmbedUrls.length) {
                    currentUrlIndex++;
                    embedUrl = window.alternativeEmbedUrls[currentUrlIndex - 1];
                    console.log(`Trying alternative embed method ${currentUrlIndex}: ${embedUrl}`);
                    videoIframe.src = embedUrl;
                } else {
                    console.error('All video loading methods failed');
                    videoLoading.style.display = 'none';
                    videoError.style.display = 'block';
                    
                    // Provide specific error messages based on video type
                    if (urlType === 'zoom') {
                        videoError.innerHTML = `
                            <div>Unable to load Zoom recording</div>
                            <div style="margin-top: 10px; font-size: 14px;">
                                Zoom recordings may have access restrictions or require authentication.
                                <br><strong>Try:</strong> Opening the link directly in a new browser tab
                                <br>Or contact support for alternative access methods.
                            </div>
                            <button onclick="window.open('${videoUrl}', '_blank')" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üîó Open Direct Link
                            </button>
                        `;
                    } else {
                        videoError.innerHTML = `
                            <div>Unable to load video</div>
                            <div style="margin-top: 10px; font-size: 14px;">
                                This may be due to video access restrictions. 
                                <br>Please contact support for alternative access.
                            </div>
                        `;
                    }
                }
            }

            // Configure iframe attributes based on video type
            if (urlType === 'zoom') {
                // Special configuration for Zoom videos
                videoIframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-presentation allow-forms allow-popups');
                videoIframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture; camera; microphone');
            }
            
            // Set iframe source and start loading
            videoIframe.src = embedUrl;
            
            // Start the enhanced loading process
            if (!loadAttempted) {
                attemptVideoLoad();
            }

            // Prevent context menu on modal
            modal.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable keyboard shortcuts
            modal.addEventListener('keydown', function(e) {
                // Disable common shortcuts: Ctrl+S, Ctrl+A, F12, etc.
                if (e.ctrlKey && (e.key === 's' || e.key === 'a' || e.key === 'c' || e.key === 'v')) {
                    e.preventDefault();
                    return false;
                }
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                    return false;
                }
                // Allow only Escape to close
                if (e.key === 'Escape') {
                    closeVideoPlayer();
                }
            });

            // Auto-close on outside click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeVideoPlayer();
                }
            });

            // Focus trap to prevent tabbing out
            setTimeout(() => {
                modal.focus();
            }, 100);
        }

        function closeVideoPlayer() {
            const modal = document.getElementById('videoModal');
            const videoIframe = document.getElementById('videoIframe');
            
            // Hide modal
            modal.style.display = 'none';
            
            // Clear iframe to stop video playback
            videoIframe.src = '';
            
            console.log('Video player closed');
        }

        // Disable video controls and downloads globally
        document.addEventListener('DOMContentLoaded', function() {
            // Disable right-click globally on video elements
            document.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.video-modal')) {
                    e.preventDefault();
                    return false;
                }
            });

            // Disable drag and drop on video modal
            document.addEventListener('dragstart', function(e) {
                if (e.target.closest('.video-modal')) {
                    e.preventDefault();
                    return false;
                }
            });

            // Disable text selection in video modal
            document.addEventListener('selectstart', function(e) {
                if (e.target.closest('.video-modal')) {
                    e.preventDefault();
                    return false;
                }
            });

            // Additional security: Monitor for developer tools
            let devtools = {
                open: false,
                orientation: null
            };

            const threshold = 160;

            setInterval(function() {
                if (document.getElementById('videoModal').style.display === 'block') {
                    if (window.outerHeight - window.innerHeight > threshold || 
                        window.outerWidth - window.innerWidth > threshold) {
                        if (!devtools.open) {
                            devtools.open = true;
                            console.clear();
                            console.log('%cSecurity Notice', 'color: red; font-size: 20px; font-weight: bold;');
                            console.log('%cVideo content is protected. Please close developer tools.', 'color: red; font-size: 14px;');
                            // Optionally close video when dev tools detected
                            // closeVideoPlayer();
                        }
                    } else {
                        devtools.open = false;
                    }
                }
            }, 500);

            // Clear console periodically when video is playing
            setInterval(function() {
                if (document.getElementById('videoModal').style.display === 'block') {
                    console.clear();
                    console.log('%cProtected Content', 'color: #333; font-size: 16px;');
                    console.log('%cThis content is protected and cannot be downloaded or shared.', 'color: #666; font-size: 12px;');
                }
            }, 2000);
        });



        // Notes Management Functions
        async function loadAvailableNotes() {
            if (!supabase || !currentUser) {
                console.error('Supabase not initialized or user not logged in');
                return;
            }

            try {
                console.log('Loading available notes for user:', currentUser.id);
                
                // First, get user's approved enrollments to know which classes they can access notes for
                const { data: enrollments, error: enrollmentError } = await supabase
                    .from('enrollments')
                    .select('class_id, classes(id, name)')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'approved');

                if (enrollmentError) {
                    console.error('Error loading enrollments:', enrollmentError);
                    document.getElementById('availableNotesContainer').innerHTML = 
                        '<p style="color: #dc3545; text-align: center;">Error loading your enrolled classes</p>';
                    return;
                }

                if (!enrollments || enrollments.length === 0) {
                    document.getElementById('availableNotesContainer').innerHTML = 
                        '<p style="color: #6c757d; text-align: center; padding: 20px; background: white; border: 1px dashed #dee2e6; border-radius: 5px;">You are not enrolled in any approved classes yet</p>';
                    return;
                }

                // Get class IDs from approved enrollments
                const enrolledClassIds = enrollments.map(e => e.class_id);

                // Now fetch notes for those classes
                const { data: notes, error: notesError } = await supabase
                    .from('class_notes')
                    .select('*, classes(id, name)')
                    .in('class_id', enrolledClassIds)
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (notesError) {
                    console.error('Error loading notes:', notesError);
                    document.getElementById('availableNotesContainer').innerHTML = 
                        '<p style="color: #dc3545; text-align: center;">Error loading class notes</p>';
                    return;
                }

                displayAvailableNotes(notes || []);

            } catch (error) {
                console.error('Error in loadAvailableNotes:', error);
                document.getElementById('availableNotesContainer').innerHTML = 
                    '<p style="color: #dc3545; text-align: center;">Error loading notes</p>';
            }
        }

        function displayAvailableNotes(notes) {
            const container = document.getElementById('availableNotesContainer');
            
            if (notes.length === 0) {
                container.innerHTML = 
                    '<p style="color: #6c757d; text-align: center; padding: 20px; background: white; border: 1px dashed #dee2e6; border-radius: 5px;">No notes available for your enrolled classes</p>';
                return;
            }

            // Group notes by class
            const notesByClass = {};
            notes.forEach(note => {
                const className = note.classes?.name || 'Unknown Class';
                if (!notesByClass[className]) {
                    notesByClass[className] = [];
                }
                notesByClass[className].push(note);
            });

            let html = '';
            Object.keys(notesByClass).forEach(className => {
                const classNotes = notesByClass[className];
                html += `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 20px; overflow: hidden;">
                        <div style="background: #f8f9fa; padding: 15px; border-bottom: 1px solid #dee2e6;">
                            <h4 style="margin: 0; color: #333; display: flex; align-items: center;">
                                üìñ ${className}
                                <span style="margin-left: auto; background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                    ${classNotes.length} note${classNotes.length > 1 ? 's' : ''}
                                </span>
                            </h4>
                        </div>
                        <div style="padding: 15px;">
                `;

                classNotes.forEach(note => {
                    const createdDate = new Date(note.created_at).toLocaleDateString();
                    html += `
                        <div style="border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-bottom: 10px; background: #f8f9fa;">
                            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 5px 0; color: #333; font-weight: 600;">üìÑ ${note.title}</h5>
                                    ${note.description ? `<p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">${note.description}</p>` : ''}
                                    <small style="color: #6c757d;">üìÖ Added: ${createdDate}</small>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button onclick="secureViewNotes('${note.id}', '${note.title}')" 
                                        style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                    üëÅÔ∏è View Notes
                                </button>
                                <button onclick="secureDownloadNotes('${note.id}', '${note.title}')" 
                                        style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                    üì• Download
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function secureViewNotes(noteId, title) {
            // Secure notes viewer using note ID instead of exposing URLs
            try {
                // Fetch the note URL securely from database
                const { data: note, error } = await supabase
                    .from('class_notes')
                    .select('google_drive_url')
                    .eq('id', noteId)
                    .single();
                
                if (error || !note) {
                    alert('Unable to access notes. Please try again.');
                    return;
                }
                
                const googleDriveUrl = note.google_drive_url;
                let embedUrl = '';
                
                // Process URL securely without logging
                if (googleDriveUrl.includes('docs.google.com')) {
                    const docId = extractGoogleDriveFileId(googleDriveUrl);
                    if (docId) {
                        embedUrl = `https://docs.google.com/document/d/${docId}/preview?usp=embed_facebook`;
                    } else {
                        embedUrl = googleDriveUrl.replace('/edit', '/preview').replace('#gid=', '&gid=');
                        if (!embedUrl.includes('preview')) {
                            embedUrl += embedUrl.includes('?') ? '&usp=embed_facebook' : '?usp=embed_facebook';
                        }
                    }
                } else if (googleDriveUrl.includes('sheets.google.com')) {
                    const sheetId = extractGoogleDriveFileId(googleDriveUrl);
                    if (sheetId) {
                        embedUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/preview?usp=embed_facebook`;
                    } else {
                        embedUrl = googleDriveUrl.replace('/edit', '/preview').replace('#gid=', '&gid=');
                        if (!embedUrl.includes('preview')) {
                            embedUrl += embedUrl.includes('?') ? '&usp=embed_facebook' : '?usp=embed_facebook';
                        }
                    }
                } else if (googleDriveUrl.includes('slides.google.com')) {
                    const slideId = extractGoogleDriveFileId(googleDriveUrl);
                    if (slideId) {
                        embedUrl = `https://docs.google.com/presentation/d/${slideId}/preview?usp=embed_facebook`;
                    } else {
                        embedUrl = googleDriveUrl.replace('/edit', '/preview');
                        if (!embedUrl.includes('preview')) {
                            embedUrl += embedUrl.includes('?') ? '&usp=embed_facebook' : '?usp=embed_facebook';
                        }
                    }
                } else {
                    const fileId = extractGoogleDriveFileId(googleDriveUrl);
                    if (fileId) {
                        embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                    } else {
                        alert('Unable to preview this file.');
                        return;
                    }
                }
                
                // Open secure viewer
                openSecureNotesViewer(embedUrl, title);
                
            } catch (error) {
                alert('Error accessing notes. Please try again.');
            }
        }

        function openSecureNotesViewer(embedUrl, title) {
            const modal = document.getElementById('notesViewerModal');
            const iframe = document.getElementById('notesViewerFrame');
            const titleElement = document.getElementById('notesViewerTitle');
            
            // Set title securely
            titleElement.textContent = `üìÑ ${title}`;
            
            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Set iframe source securely
            iframe.src = embedUrl;
            
            // Add error handling without exposing URLs
            iframe.onload = function() {
                // Notes loaded successfully
            };
            
            iframe.onerror = function() {
                showSecureEmbedError(title);
            };
            
            // Check for access denied after a delay
            setTimeout(() => {
                try {
                    // If iframe content is blocked or shows error, try fallback
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc || iframeDoc.body.innerHTML.includes('does not exist') || 
                        iframeDoc.body.innerHTML.includes('access denied')) {
                        showSecureEmbedError(title);
                    }
                } catch (e) {
                    // Cross-origin restriction detected (normal for Google Drive)
                }
            }, 3000);
        }





        function closeNotesViewer() {
            const modal = document.getElementById('notesViewerModal');
            const iframe = document.getElementById('notesViewerFrame');
            
            // Hide modal and clear iframe
            modal.style.display = 'none';
            iframe.src = '';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Close modal when clicking outside content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('notesViewerModal');
            if (event.target === modal) {
                closeNotesViewer();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('notesViewerModal');
                if (modal.style.display === 'block') {
                    closeNotesViewer();
                }
            }
        });



        async function secureDownloadNotes(noteId, title) {
            // Secure download handler using note ID
            try {
                // Fetch the note URL securely from database
                const { data: note, error } = await supabase
                    .from('class_notes')
                    .select('google_drive_url')
                    .eq('id', noteId)
                    .single();
                
                if (error || !note) {
                    alert('Unable to access notes for download. Please try again.');
                    return;
                }
                
                const googleDriveUrl = note.google_drive_url;
                const fileId = extractGoogleDriveFileId(googleDriveUrl);
                
                if (!fileId) {
                    // Fallback download methods using hidden iframe to prevent URL exposure
                    if (googleDriveUrl.includes('docs.google.com')) {
                        const exportUrl = googleDriveUrl.replace('/edit', '/export?format=pdf');
                        triggerSecureDownload(exportUrl);
                    } else if (googleDriveUrl.includes('sheets.google.com')) {
                        const exportUrl = googleDriveUrl.replace('/edit', '/export?format=xlsx');
                        triggerSecureDownload(exportUrl);
                    } else if (googleDriveUrl.includes('slides.google.com')) {
                        const exportUrl = googleDriveUrl.replace('/edit', '/export?format=pptx');
                        triggerSecureDownload(exportUrl);
                    } else {
                        alert('Download format not supported. Please contact administrator.');
                    }
                    return;
                }
                
                // Create secure download URL and trigger hidden download
                const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                triggerSecureDownload(downloadUrl);
                
            } catch (error) {
                alert('Error downloading notes. Please try again.');
            }
        }

        function triggerSecureDownload(downloadUrl) {
            // Create a temporary hidden iframe to trigger download without exposing URL
            try {
                // Method 1: Hidden iframe approach
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.style.visibility = 'hidden';
                iframe.style.position = 'absolute';
                iframe.style.left = '-9999px';
                iframe.style.top = '-9999px';
                iframe.style.width = '1px';
                iframe.style.height = '1px';
                
                // Add iframe to body
                document.body.appendChild(iframe);
                
                // Set source to trigger download
                iframe.src = downloadUrl;
                
                // Clean up iframe after download starts
                setTimeout(() => {
                    if (iframe && iframe.parentNode) {
                        iframe.parentNode.removeChild(iframe);
                    }
                }, 3000);
                
            } catch (error) {
                // Fallback: Use hidden link approach
                try {
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = '';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    
                    // Clean up link
                    setTimeout(() => {
                        if (link && link.parentNode) {
                            link.parentNode.removeChild(link);
                        }
                    }, 100);
                } catch (fallbackError) {
                    alert('Download failed. Please contact administrator for assistance.');
                }
            }
        }

        function showSecureEmbedError(title) {
            const iframe = document.getElementById('notesViewerFrame');
            
            // Show error message without exposing URLs
            const errorHtml = `
                <html>
                <head>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 50px; 
                            background: #f8f9fa; 
                        }
                        .error-container { 
                            background: white; 
                            padding: 30px; 
                            border-radius: 8px; 
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
                            max-width: 500px; 
                            margin: 0 auto; 
                        }
                        .error-icon { font-size: 48px; margin-bottom: 20px; }
                        .error-title { color: #dc3545; font-size: 18px; margin-bottom: 15px; }
                        .error-message { color: #666; margin-bottom: 20px; line-height: 1.5; }
                        .support-btn { 
                            background: #6c757d; 
                            color: white; 
                            border: none; 
                            padding: 12px 24px; 
                            border-radius: 4px; 
                            cursor: pointer; 
                            font-size: 16px; 
                        }
                        .support-btn:hover { background: #5a6268; }
                    </style>
                </head>
                <body>
                    <div class="error-container">
                        <div class="error-icon">üìÑ‚ùå</div>
                        <div class="error-title">Unable to Preview File</div>
                        <div class="error-message">
                            This file cannot be embedded due to sharing restrictions or file type limitations. 
                            Please contact the administrator for assistance accessing this content.
                        </div>
                        <button class="support-btn" onclick="alert('Please contact your administrator for assistance accessing: ${title}')">
                            ‚ÑπÔ∏è Contact Support
                        </button>
                    </div>
                </body>
                </html>
            `;
            
            iframe.srcdoc = errorHtml;
        }



        // Developer tools protection
        function protectInspection() {
            // Disable right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Disable common developer tools shortcuts
            document.addEventListener('keydown', function(e) {
                // F12, Ctrl+Shift+I, Ctrl+Shift+C, Ctrl+U, Ctrl+Shift+J
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J')) ||
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Detect developer tools opening
            let devtools = {open: false, orientation: null};
            const threshold = 160;
            
            setInterval(() => {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        alert('Developer tools detected. For security reasons, this action is not allowed.');
                        // Optionally redirect or take other actions
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Enable protection
            protectInspection();
            
            // Initialize screen recording detection for Electron
            if (window.electronAPI) {
                console.log('üîí Initializing screen recording detection...');
                initializeRecordingDetection();
            }
            
            // Check for password reset in URL first
            handlePasswordResetFromURL();
            
            // Check for existing session
            const { data: user } = await supabase.auth.getUser();
            if (user.user) {
                console.log('User found in session, validating...');
                const isValidSession = await validateCurrentSession();
                
                if (isValidSession) {
                    console.log('Valid session found, loading user data...');
                    // Get user profile and show dashboard
                    try {
                        const { data: profileData } = await supabase
                            .from('user_profiles')
                            .select('*')
                            .eq('user_id', user.user.id);
                        
                        if (profileData && profileData.length > 0) {
                            const userProfile = profileData[0];
                            if (userProfile.status === 'approved') {
                                currentUser = {
                                    id: user.user.id,
                                    name: userProfile.name,
                                    email: userProfile.email,
                                    nic: userProfile.nic,
                                    mobile: userProfile.mobile,
                                    batch: userProfile.batch,
                                    status: userProfile.status,
                                    role: 'Student'
                                };
                                
                                // Start session monitoring for existing session
                                startSessionMonitoring();
                                
                                showDashboard();
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading user profile:', error);
                    }
                }
                
                // If session validation failed, clear everything
                console.log('Session validation failed, logging out...');
                await logoutAndClearSession();
            }
            
            // Show login form by default
            showLogin();
        });

        // Screen Recording Detection Functions for Electron
        function initializeRecordingDetection() {
            if (!window.electronAPI) return;
            
            // Listen for recording detection events
            window.electronAPI.onRecordingDetected((event, data) => {
                console.log('üö® SECURITY ALERT: Screen recording detected!', data);
                handleRecordingDetected(data);
            });
            
            // Log that detection is active
            logSecurityEvent('detection_initialized', {
                message: 'Screen recording detection initialized',
                timestamp: new Date().toISOString()
            });
        }

        function handleRecordingDetected(detectionData) {
            const processNames = detectionData.processes.map(p => p.name).join(', ');
            
            // Log the security event to Supabase
            logSecurityEvent('recording_detected', {
                message: 'Screen recording software detected',
                processes: detectionData.processes,
                user_id: currentUser ? currentUser.id : 'anonymous',
                timestamp: detectionData.timestamp
            });
            
            // Show warning to user
            showSecurityAlert(
                'Security Violation Detected',
                `The following recording software has been detected: ${processNames}\n\nThis activity has been logged and reported to the administrator.\n\nAccess to sensitive content will be restricted until recording software is closed.`,
                'error'
            );
            
            // Hide sensitive content if showing recordings
            if (document.getElementById('recordingsSection') && !document.getElementById('recordingsSection').classList.contains('hidden')) {
                hideSensitiveContent();
            }
        }

        function hideSensitiveContent() {
            // Hide video content
            const videoElements = document.querySelectorAll('video, iframe');
            videoElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // Show warning overlay
            const recordingsSection = document.getElementById('recordingsSection');
            if (recordingsSection) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'recording-warning-overlay';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(220, 53, 69, 0.95);
                    color: white;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    text-align: center;
                    padding: 20px;
                `;
                warningDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">üö®</div>
                    <h2 style="margin-bottom: 20px;">Security Violation Detected</h2>
                    <p style="font-size: 18px; margin-bottom: 20px;">Screen recording software has been detected on your system.</p>
                    <p style="font-size: 16px; margin-bottom: 30px;">Access to video content is restricted for security reasons.</p>
                    <button onclick="checkRecordingStatus()" style="
                        background: white;
                        color: #dc3545;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 5px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                    ">Check Again</button>
                `;
                document.body.appendChild(warningDiv);
            }
        }

        async function checkRecordingStatus() {
            if (!window.electronAPI) return;
            
            try {
                const result = await window.electronAPI.checkRecordingNow();
                
                if (!result.detected) {
                    // Recording stopped, remove warning overlay
                    const overlay = document.getElementById('recording-warning-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                    
                    // Show video content again
                    const videoElements = document.querySelectorAll('video, iframe');
                    videoElements.forEach(element => {
                        element.style.display = '';
                    });
                    
                    showSuccessAlert('Security Check Passed', 'No recording software detected. You can now access video content.');
                    
                    logSecurityEvent('recording_stopped', {
                        message: 'Recording software no longer detected',
                        user_id: currentUser ? currentUser.id : 'anonymous',
                        timestamp: new Date().toISOString()
                    });
                } else {
                    showErrorAlert('Recording Still Detected', 'Please close all screen recording software before accessing video content.');
                }
            } catch (error) {
                console.error('Error checking recording status:', error);
                showErrorAlert('Detection Error', 'Unable to verify recording status. Please restart the application.');
            }
        }

        async function logSecurityEvent(eventType, eventData) {
            try {
                // Log to Supabase
                const { error } = await supabase
                    .from('security_events')
                    .insert([{
                        event_type: eventType,
                        user_id: eventData.user_id || (currentUser ? currentUser.id : null),
                        details: eventData,
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    console.error('Error logging security event to Supabase:', error);
                }
                
                // Also log to Electron if available
                if (window.electronAPI) {
                    await window.electronAPI.logSecurityEvent({
                        type: eventType,
                        data: eventData
                    });
                }
            } catch (error) {
                console.error('Error logging security event:', error);
            }
        }

        function showSecurityAlert(title, message, type = 'warning') {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#dc3545' : '#ffc107'};
                color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                font-family: inherit;
            `;
            alertDiv.innerHTML = `
                <h4 style="margin: 0 0 10px 0; font-size: 16px;">${title}</h4>
                <p style="margin: 0; font-size: 14px; line-height: 1.4;">${message}</p>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 10000);
        }
    </script>

    <!-- Notes Viewer Modal -->
    <div id="notesViewerModal" class="notes-viewer-modal">
        <div class="notes-viewer-content">
            <div class="notes-viewer-header">
                <h3 id="notesViewerTitle" class="notes-viewer-title">üìÑ Loading Notes...</h3>
                <button onclick="closeNotesViewer()" class="notes-viewer-close">&times;</button>
            </div>
            <iframe id="notesViewerFrame" class="notes-viewer-iframe" src=""></iframe>
        </div>
    </div>

</body>
</html>